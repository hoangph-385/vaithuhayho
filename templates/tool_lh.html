{% extends "base.html" %}
{% block title %}LH Report - Báo cáo Last Hub{% endblock %}
{% block content %}

<script>
  window.API_BASE = window.API_BASE || "";
</script>

<div class="sdd-page lh-page">
<!-- ===== Notice ===== -->
<div id="notice" class="notice"></div>

<!-- ===== Controls ===== -->
<div id="controls">
  <div class="row">
    <label for="selectedDate" style="font-weight: 600; margin-right: 8px;">Chọn ngày:</label>
    <input type="date" id="selectedDate" class="form-control" style="width: 180px;">
    <button id="btnFetchTrips" class="btn-action">Lấy dữ liệu</button>
  </div>
</div>

<!-- ===== Outbound Trips Table ===== -->
<div id="tripsSection" style="display: none;">
  <div style="margin-bottom: 20px;">
    <h3>Danh sách Trips - Outbound</h3>
    <p>Tổng số trips: <strong id="totalTrips">0</strong></p>
  </div>

  <div style="overflow-x: auto;">
    <table class="table" id="tripsTable">
      <thead>
        <tr>
          <th>STT</th>
          <th>Trip Number</th>
          <th>Vehicle</th>
          <th>Type</th>
          <th>Seq</th>
          <th>TO Qty</th>
          <th>Parcel Qty</th>
          <th>Operator</th>
          <th>Loading Time</th>
          <th>Seal Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tripsTableBody">
        <!-- Trips will be populated here -->
      </tbody>
    </table>
  </div>
</div>

<!-- ===== Handover Trips Table ===== -->
<div id="handoverSection" style="display: none;">
  <div style="margin-bottom: 20px;">
    <h3>Danh sách Trips - Handover</h3>
    <p>Tổng số trips: <strong id="totalHandoverTrips">0</strong></p>
  </div>

  <div style="overflow-x: auto;">
    <table class="table" id="handoverTable">
      <thead>
        <tr>
          <th>STT</th>
          <th>Trip Number</th>
          <th>Vehicle</th>
          <th>Type</th>
          <th>Seq</th>
          <th>TO Qty</th>
          <th>Parcel Qty</th>
          <th>Operator</th>
          <th>Loading Time</th>
          <th>Seal Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="handoverTableBody">
        <!-- Handover trips will be populated here -->
      </tbody>
    </table>
  </div>
</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Pre-load audio files
const audioCache = {
  success: new Audio('/static/sounds/sys_success.mp3'),
  error: new Audio('/static/sounds/sys_error.mp3')
};
audioCache.success.volume = 0.5;
audioCache.error.volume = 0.5;

// Utility functions
function el(id) { return document.getElementById(id); }

function notice(msg, type = "info", duration = 0) {
  const n = el("notice");
  let htmlMsg = msg.includes('\n') ? msg.replace(/\n/g, '<br>') : msg;
  const isLoading = type === 'info' && /Đang tải|Đang lấy|⏳/.test(msg);
  if (isLoading) {
    htmlMsg = `<span class=\"spinner-lg spinner-lg-notice\"></span>${htmlMsg.replace(/^⏳\s?/, '')}`;
  }
  n.innerHTML = htmlMsg;
  n.className = "notice";
  n.setAttribute("data-kind", type);
  n.style.display = "block";
  playSound(type);
  if (duration > 0) {
    setTimeout(() => { n.style.display = "none"; }, duration);
  }
}

function playSound(type) {
  try {
    let audio;
    if (type === "success" || type === "ok") {
      audio = audioCache.success;
    } else if (type === "error") {
      audio = audioCache.error;
    } else {
      return; // No sound for other types
    }

    // Reset audio to start
    audio.currentTime = 0;

    // Force play immediately
    const playPromise = audio.play();
    if (playPromise !== undefined) {
      playPromise.catch(e => {
        console.warn("Audio playback failed:", e);
        audio.muted = false;
        audio.play().catch(err => console.log("Sound retry failed:", err));
      });
    }
  } catch (e) {
    console.log("Sound error:", e);
  }
}

function hideNotice() {
  const n = el("notice");
  n.style.display = "none";
}

function formatDateTime(dateStr) {
  if (!dateStr) return "-";
  // Extract only HH:MM from datetime string (YYYY-MM-DD HH:MM:SS -> HH:MM)
  return dateStr.substring(11, 16);
}

// Fetch trips data
async function fetchTrips() {
  try {
    hideNotice();
    notice('⏳ Đang tải dữ liệu trips...', 'info');
    el("tripsSection").style.display = "none";
    el("handoverSection").style.display = "none";
    el("btnFetchTrips").disabled = true;

    // Get selected date
    const selectedDate = el("selectedDate").value;
    const outboundUrl = selectedDate
      ? `/api/report/LH_report?date=${selectedDate}`
      : "/api/report/LH_report";
    const handoverUrl = selectedDate
      ? `/api/report/LH_report_handover?date=${selectedDate}`
      : "/api/report/LH_report_handover";

    // Fetch both outbound and handover trips in parallel
    const [outboundResponse, handoverResponse] = await Promise.all([
      fetch(outboundUrl),
      fetch(handoverUrl)
    ]);

    const [outboundData, handoverData] = await Promise.all([
      outboundResponse.json(),
      handoverResponse.json()
    ]);

    // Debug logging
    console.log("Outbound response:", outboundResponse.ok, outboundData);
    console.log("Handover response:", handoverResponse.ok, handoverData);

    if (!outboundResponse.ok || !outboundData.ok) {
      throw new Error(outboundData.error || "Failed to fetch outbound trips");
    }

    // Display trips and wait for rendering to complete
    await displayTrips(outboundData);

    // Always display handover section, even if no data or error
    if (handoverResponse.ok && handoverData.ok) {
      await displayHandoverTrips(handoverData);
      notice(`✓ Đã tải ${outboundData.total_trips} Outbound trips và ${handoverData.total_trips} Handover trips!`, "success", 3000);
    } else {
      // Show empty handover table even on error
      await displayHandoverTrips({ ok: false, total_trips: 0, trips: [] });
      notice(`✓ Đã tải ${outboundData.total_trips} Outbound trips!`, "success", 3000);
    }

  } catch (error) {
    console.error("Error fetching trips:", error);
    notice(`✗ Lỗi: ${error.message}`, "error", 5000);
  } finally {
    el("btnFetchTrips").disabled = false;
  }
}

function displayTrips(data) {
  const tbody = el("tripsTableBody");
  tbody.innerHTML = "";

  if (!data.trips || data.trips.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">Không có dữ liệu</td></tr>';
    el("tripsSection").style.display = "block";
    return Promise.resolve();
  }

  // Update summary
  el("totalTrips").textContent = data.total_trips;

  // Sort trips by seal_time in descending order (newest first)
  const sortedTrips = data.trips.sort((a, b) => {
    if (!a.seal_time) return 1;
    if (!b.seal_time) return -1;
    return b.seal_time.localeCompare(a.seal_time);
  });

  // Fetch parcel counts for all trips using Promise.all
  const parcelPromises = sortedTrips.map(trip =>
    fetch(`/api/report/LH_get_parcel_count/${trip.id}?seq=${trip.sequence_number || 1}`)
      .then(res => res.json())
      .then(result => ({
        trip_id: trip.id,
        total_parcel: result.ok ? result.total_parcel : 0
      }))
      .catch(() => ({ trip_id: trip.id, total_parcel: 0 }))
  );

  return Promise.all(parcelPromises).then(parcelResults => {
    // Create a map for quick lookup
    const parcelMap = {};
    parcelResults.forEach(result => {
      parcelMap[result.trip_id] = result.total_parcel;
    });

    // Populate table with parcel counts
    sortedTrips.forEach((trip, index) => {
      const stt = data.total_trips - index;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align: center;">${stt}</td>
        <td><strong>${trip.trip_number}</strong></td>
        <td>${trip.vehicle_number || "-"}</td>
        <td>${trip.vehicle_type_name || "-"}</td>
        <td style="text-align: center;">${trip.sequence_number || "-"}</td>
        <td style="text-align: center;">${trip.load_quantity || 0}</td>
        <td style="text-align: center;">${parcelMap[trip.id] || 0}</td>
        <td>${trip.operator || "-"}</td>
        <td>${formatDateTime(trip.loading_time)}</td>
        <td>${formatDateTime(trip.seal_time)}</td>
        <td style="text-align: center;">
          <button class="btn-download-csv" id="csv-${trip.id}" onclick="downloadCSV('${trip.id}', '${trip.trip_number}', ${trip.sequence_number || 1}, this)">Tải CSV</button>
          <button class="btn-download-pdf" id="pdf-${trip.id}" onclick="downloadPDF('${trip.id}', '${trip.trip_number}', this)">Tải PDF</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    el("tripsSection").style.display = "block";
  });
}

function displayHandoverTrips(data) {
  console.log("displayHandoverTrips called with:", data);
  const tbody = el("handoverTableBody");
  tbody.innerHTML = "";

  if (!data.trips || data.trips.length === 0) {
    console.log("No handover trips data");
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">Không có dữ liệu</td></tr>';
    el("handoverSection").style.display = "block";
    return Promise.resolve();
  }

  // Update summary
  el("totalHandoverTrips").textContent = data.total_trips;
  console.log(`Displaying ${data.total_trips} handover trips`);

  // Sort trips by seal_time in descending order (newest first)
  const sortedTrips = data.trips.sort((a, b) => {
    if (!a.seal_time) return 1;
    if (!b.seal_time) return -1;
    return b.seal_time.localeCompare(a.seal_time);
  });

  // Fetch parcel counts for all trips using Promise.all
  const parcelPromises = sortedTrips.map(trip =>
    fetch(`/api/report/LH_get_parcel_count/${trip.id}?seq=${trip.sequence_number || 1}`)
      .then(res => res.json())
      .then(result => ({
        trip_id: trip.id,
        total_parcel: result.ok ? result.total_parcel : 0
      }))
      .catch(() => ({ trip_id: trip.id, total_parcel: 0 }))
  );

  return Promise.all(parcelPromises).then(parcelResults => {
    // Create a map for quick lookup
    const parcelMap = {};
    parcelResults.forEach(result => {
      parcelMap[result.trip_id] = result.total_parcel;
    });

    // Populate table with parcel counts
    sortedTrips.forEach((trip, index) => {
      const stt = data.total_trips - index;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align: center;">${stt}</td>
        <td><strong>${trip.trip_number}</strong></td>
        <td>${trip.vehicle_number || "-"}</td>
        <td>${trip.vehicle_type_name || "-"}</td>
        <td style="text-align: center;">${trip.sequence_number || "-"}</td>
        <td style="text-align: center;">${trip.load_quantity || 0}</td>
        <td style="text-align: center;">${parcelMap[trip.id] || 0}</td>
        <td>${trip.operator || "-"}</td>
        <td>${formatDateTime(trip.loading_time)}</td>
        <td>${formatDateTime(trip.seal_time)}</td>
        <td style="text-align: center;">
          <button class="btn-download-csv" id="csv-h-${trip.id}" onclick="downloadCSV('${trip.id}', '${trip.trip_number}', ${trip.sequence_number || 1}, this)">Tải CSV</button>
          <button class="btn-download-pdf" id="pdf-h-${trip.id}" onclick="downloadPDF('${trip.id}', '${trip.trip_number}', this)">Tải PDF</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    el("handoverSection").style.display = "block";
  });
}

// Download CSV function
async function downloadCSV(tripId, tripNumber, sequenceNumber, btn) {
  const originalText = btn.innerHTML;
  try {
    // Disable button and show spinner animation
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Đang tải...';
    btn.style.opacity = '0.7';
    btn.style.cursor = 'not-allowed';

    notice(`⏳ Đang tải CSV cho trip ${tripNumber}...`, "info");

    const url = `/api/report/LH_get_list/${tripId}/${tripNumber}?seq=${sequenceNumber}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    // Get filename from headers if provided
    const disposition = response.headers.get('Content-Disposition');
    let filename = `${tripNumber}.csv`;
    if (disposition && disposition.includes('filename=')) {
      const match = disposition.match(/filename="?([^";]+)"?/);
      if (match && match[1]) filename = match[1];
    }

    const blob = await response.blob();
    const blobUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = blobUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(blobUrl);

    notice(`✓ Đã tải xong CSV cho trip ${tripNumber}`, "success", 6000);
    btn.disabled = false;
    btn.innerHTML = originalText;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';

  } catch (error) {
    console.error("Error downloading CSV:", error);
    notice(`✗ Lỗi: ${error.message}`, "error", 5000);
    // Re-enable button on error
    btn.disabled = false;
    btn.innerHTML = originalText;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  }
}

// Download PDF function
async function downloadPDF(tripId, tripNumber, btn) {
  const originalText = btn.innerHTML;
  try {
    // Disable button and show spinner
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Đang tải...';
    btn.style.opacity = '0.7';
    btn.style.cursor = 'not-allowed';

    notice(`⏳ Đang tải PDF cho trip ${tripNumber}...`, "info");

    const url = `https://spx.shopee.vn/api/admin/transportation/run_sheet/download_all?trip_id=${tripId}`;
    let response;
    try {
      response = await fetch(url, { credentials: 'include' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const disposition = response.headers.get('Content-Disposition');
      let filename = `runsheet_${tripNumber}.pdf`;
      if (disposition && disposition.includes('filename=')) {
        const match = disposition.match(/filename="?([^";]+)"?/);
        if (match && match[1]) filename = match[1];
      }
      const blob = await response.blob();
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(blobUrl), 4000);
      notice(`✓ Đã tải xong PDF cho trip ${tripNumber}`, "success", 4000);
    } catch (innerErr) {
      // Fallback nếu CORS hoặc lỗi fetch
      console.warn('Fetch PDF thất bại, fallback window.open:', innerErr);
      window.open(url, '_blank');
      notice(`⚠ Mở PDF (không xác nhận tải hoàn tất) trip ${tripNumber}`, "info", 4000);
    }

    btn.disabled = false;
    btn.innerHTML = originalText;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';

  } catch (error) {
    console.error("Error downloading PDF:", error);
    notice(`✗ Lỗi: ${error.message}`, "error", 5000);
    // Re-enable button on error
    btn.disabled = false;
    btn.innerHTML = originalText;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  }
}

// Event listeners
document.addEventListener("DOMContentLoaded", () => {
  // Set today's date as default
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  el("selectedDate").value = `${yyyy}-${mm}-${dd}`;

  el("btnFetchTrips").addEventListener("click", fetchTrips);
});
</script>

<!-- ========================== View-Only Mode Handler ========================== -->
<script>
(function() {
  "use strict";
  const isAuthenticated = "{{ 'true' if is_authenticated else 'false' }}";
  function applyViewOnlyMode() {
    if (isAuthenticated === 'true') return;
    console.log('[VIEW-ONLY] Disabling all action controls');
    const inputs = ['selectedDate'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.disabled = true;
        el.readOnly = true;
        el.style.opacity = '0.6';
        el.style.cursor = 'not-allowed';
        el.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
      }
    });
    const buttons = ['btnFetchTrips'];
    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        btn.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
      }
    });
    document.querySelectorAll('.btn-download-csv, .btn-download-pdf').forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
    });
    const notice = document.getElementById('notice');
    if (notice) {
      notice.innerHTML = '⚠ Chế độ chỉ xem - Vui lòng đăng nhập để thực hiện thao tác';
      notice.className = 'notice';
      notice.setAttribute('data-kind', 'warning');
      notice.style.display = 'block';
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyViewOnlyMode);
  } else {
    applyViewOnlyMode();
  }
  setTimeout(applyViewOnlyMode, 500);
})();
</script>
{% endblock %}
