{% extends "base.html" %}
{% block title %}LH Report - Báo cáo Last Hub{% endblock %}
{% block content %}

<script>
  window.API_BASE = window.API_BASE || "";
</script>

<div class="sdd-page lh-page">
<!-- ===== Notice ===== -->
<div id="notice" class="notice"></div>

<!-- ===== Controls ===== -->
<div id="controls">
  <div class="row" style="display: flex; align-items: center;">
    <label for="selectedDate" style="font-weight: 600; margin-right: 8px;">Chọn ngày:</label>
    <input type="date" id="selectedDate" class="form-control" style="width: 180px;">
    <button id="btnFetchTrips" class="btn-action">Lấy dữ liệu</button>
    <button id="btnMassDownload" class="btn-action" style="margin-left: 8px;" disabled type="button">Tải hàng loạt</button>
    <div style="margin-left: auto; display: flex; align-items: center;">
      <p style="margin: 0; font-size: 14px;"><span id="cookieExpiry" style="color: #d9534f; font-weight: 700; font-size: 16px;">--</span> - <span id="spxDN" style="color: #0275d8; font-weight: 700; font-size: 16px;">--</span></p>
    </div>
  </div>
</div>

<!-- ===== Outbound Trips Table ===== -->
<div id="tripsSection" style="display: none;">
  <div style="margin-bottom: 20px;">
    <h3>Danh sách Trips - Outbound</h3>
    <p>Tổng số trips: <strong id="totalTrips">0</strong></p>
  </div>

  <div style="overflow-x: auto;">
    <table class="table" id="tripsTable">
      <thead>
        <tr>
          <th style="width: 40px; text-align: center;"><input type="checkbox" class="select-all-checkbox" data-target="outbound" aria-label="Chọn tất cả outbound"></th>
          <th>STT</th>
          <th>Trip Number</th>
          <th>Vehicle</th>
          <th>Type</th>
          <th>Seq</th>
          <th>TO Qty</th>
          <th>Parcel Qty</th>
          <th>Driver</th>
          <th>Loading Time</th>
          <th>Seal Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tripsTableBody">
        <!-- Trips will be populated here -->
      </tbody>
    </table>
  </div>
</div>

<!-- ===== Handover Trips Table ===== -->
<div id="handoverSection" style="display: none;">
  <div style="margin-bottom: 20px;">
    <h3>Danh sách Trips - Handover</h3>
    <p>Tổng số trips: <strong id="totalHandoverTrips">0</strong></p>
  </div>

  <div style="overflow-x: auto;">
    <table class="table" id="handoverTable">
      <thead>
        <tr>
          <th style="width: 40px; text-align: center;"><input type="checkbox" class="select-all-checkbox" data-target="handover" aria-label="Chọn tất cả handover"></th>
          <th>STT</th>
          <th>Trip Number</th>
          <th>Vehicle</th>
          <th>Type</th>
          <th>Seq</th>
          <th>TO Qty</th>
          <th>Parcel Qty</th>
          <th>Driver</th>
          <th>Loading Time</th>
          <th>Seal Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="handoverTableBody">
        <!-- Handover trips will be populated here -->
      </tbody>
    </table>
  </div>
</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Pre-load audio files
const audioCache = {
  success: new Audio('/static/sounds/sys_success.mp3'),
  error: new Audio('/static/sounds/sys_error.mp3')
};
audioCache.success.volume = 0.5;
audioCache.error.volume = 0.5;
const IS_AUTHENTICATED = "{{ 'true' if is_authenticated else 'false' }}" === 'true';

// Utility functions
function el(id) { return document.getElementById(id); }

function notice(msg, type = "info", duration = 0) {
  const n = el("notice");
  let htmlMsg = msg.includes('\n') ? msg.replace(/\n/g, '<br>') : msg;
  const isLoading = type === 'info' && /Đang tải|Đang lấy|⏳/.test(msg);
  if (isLoading) {
    htmlMsg = `<span class=\"spinner-lg spinner-lg-notice\"></span>${htmlMsg.replace(/^⏳\s?/, '')}`;
  }
  n.innerHTML = htmlMsg;
  n.className = "notice";
  n.setAttribute("data-kind", type);
  n.style.display = "block";
  playSound(type);
  if (duration > 0) {
    setTimeout(() => { n.style.display = "none"; }, duration);
  }
}

function playSound(type) {
  try {
    let audio;
    if (type === "success" || type === "ok") {
      audio = audioCache.success;
    } else if (type === "error" || type === "warning") {
      audio = audioCache.error;
    } else {
      return; // No sound for other types
    }

    // Reset audio to start
    audio.currentTime = 0;

    // Force play immediately
    const playPromise = audio.play();
    if (playPromise !== undefined) {
      playPromise.catch(e => {
        console.warn("Audio playback failed:", e);
        audio.muted = false;
        audio.play().catch(err => console.log("Sound retry failed:", err));
      });
    }
  } catch (e) {
    console.log("Sound error:", e);
  }
}

function hideNotice() {
  const n = el("notice");
  n.style.display = "none";
}

function formatDateTime(dateStr) {
  if (!dateStr) return "-";
  // Extract only HH:MM from datetime string (YYYY-MM-DD HH:MM:SS -> HH:MM)
  return dateStr.substring(11, 16);
}

// Fetch trips data
async function fetchTrips() {
  try {
    hideNotice();
    notice('⏳ Đang tải dữ liệu trips...', 'info');
    el("tripsSection").style.display = "none";
    el("handoverSection").style.display = "none";
    el("btnFetchTrips").disabled = true;

    // Get selected date
    const selectedDate = el("selectedDate").value;
    const outboundUrl = selectedDate
      ? `/api/report/LH_report?date=${selectedDate}`
      : "/api/report/LH_report";
    const handoverUrl = selectedDate
      ? `/api/report/LH_report_handover?date=${selectedDate}`
      : "/api/report/LH_report_handover";

    // Fetch both outbound and handover trips in parallel
    const [outboundResponse, handoverResponse] = await Promise.all([
      fetch(outboundUrl),
      fetch(handoverUrl)
    ]);

    const [outboundData, handoverData] = await Promise.all([
      outboundResponse.json(),
      handoverResponse.json()
    ]);

    // Debug logging
    console.log("Outbound response:", outboundResponse.ok, outboundData);
    console.log("Handover response:", handoverResponse.ok, handoverData);

    if (!outboundResponse.ok || !outboundData.ok) {
      throw new Error(outboundData.error || "Failed to fetch outbound trips");
    }

    // Display trips and wait for rendering to complete
    await displayTrips(outboundData);

    // Always display handover section, even if no data or error
    if (handoverResponse.ok && handoverData.ok) {
      await displayHandoverTrips(handoverData);
      notice(`✓ Đã tải ${outboundData.total_trips} Outbound trips và ${handoverData.total_trips} Handover trips!`, "success", 3000);
    } else {
      // Show empty handover table even on error
      await displayHandoverTrips({ ok: false, total_trips: 0, trips: [] });
      notice(`✓ Đã tải ${outboundData.total_trips} Outbound trips!`, "success", 3000);
    }

  } catch (error) {
    console.error("Error fetching trips:", error);
    notice(`✗ Lỗi: ${error.message}`, "error", 5000);
  } finally {
    el("btnFetchTrips").disabled = false;
  }
}

function displayTrips(data) {
  const tbody = el("tripsTableBody");
  tbody.innerHTML = "";
  resetSelectAll('outbound');

  if (!data.trips || data.trips.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">Không có dữ liệu</td></tr>';
    el("tripsSection").style.display = "block";
    updateMassDownloadButtonState();
    return Promise.resolve();
  }

  // Update summary
  el("totalTrips").textContent = data.total_trips;

  // Sort trips by seal_time in descending order (newest first)
  const sortedTrips = data.trips.sort((a, b) => {
    if (!a.seal_time) return 1;
    if (!b.seal_time) return -1;
    return b.seal_time.localeCompare(a.seal_time);
  });

  // Fetch parcel counts for all trips using Promise.all
  const parcelPromises = sortedTrips.map(trip =>
    fetch(`/api/report/LH_get_parcel_count/${trip.id}?seq=${trip.sequence_number || 1}`)
      .then(res => res.json())
      .then(result => ({
        trip_id: trip.id,
        total_parcel: result.ok ? result.total_parcel : 0
      }))
      .catch(() => ({ trip_id: trip.id, total_parcel: 0 }))
  );

  return Promise.all(parcelPromises).then(parcelResults => {
    // Create a map for quick lookup
    const parcelMap = {};
    parcelResults.forEach(result => {
      parcelMap[result.trip_id] = result.total_parcel;
    });

    // Populate table with parcel counts
    sortedTrips.forEach((trip, index) => {
      const stt = data.total_trips - index;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align: center;">
          <input type="checkbox" class="trip-checkbox" data-trip-id="${trip.id}" data-trip-number="${trip.trip_number}" data-sequence="${trip.sequence_number || 1}" data-kind="outbound" data-to-qty="${trip.load_quantity || 0}" data-parcel-qty="${parcelMap[trip.id] || 0}">
        </td>
        <td style="text-align: center;">${stt}</td>
        <td><strong>${trip.trip_number}</strong></td>
        <td>${trip.vehicle_number || "-"}</td>
        <td>${trip.vehicle_type_name || "-"}</td>
        <td style="text-align: center;">${trip.sequence_number || "-"}</td>
        <td style="text-align: center;">${trip.load_quantity || 0}</td>
        <td style="text-align: center;">${parcelMap[trip.id] || 0}</td>
        <td>${trip.driver_name || "-"}</td>
        <td>${formatDateTime(trip.loading_time)}</td>
        <td>${formatDateTime(trip.seal_time)}</td>
        <td style="text-align: center;">
          <button class="btn-download-trip" id="action-outbound-${trip.id}" data-trip-id="${trip.id}" data-trip-number="${trip.trip_number}" data-sequence="${trip.sequence_number || 1}" data-kind="outbound" data-to-qty="${trip.load_quantity || 0}" data-parcel-qty="${parcelMap[trip.id] || 0}" onclick="downloadTripFiles(this)">Tải PDF+CSV</button>
        </td>
      `;
      tbody.appendChild(row);
      if (!IS_AUTHENTICATED) {
          const checkbox = row.querySelector('.trip-checkbox');
          const button = row.querySelector('.btn-download-trip');
          if (checkbox) {
            checkbox.disabled = true;
            checkbox.style.opacity = '0.6';
            checkbox.style.cursor = 'not-allowed';
            checkbox.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
          }
          if (button) {
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
          }
        }
    });

    el("tripsSection").style.display = "block";
    updateMassDownloadButtonState();
  });
}

function displayHandoverTrips(data) {
  console.log("displayHandoverTrips called with:", data);
  const tbody = el("handoverTableBody");
  tbody.innerHTML = "";
  resetSelectAll('handover');

  if (!data.trips || data.trips.length === 0) {
    console.log("No handover trips data");
    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">Không có dữ liệu</td></tr>';
    el("handoverSection").style.display = "block";
    updateMassDownloadButtonState();
    return Promise.resolve();
  }

  // Update summary
  el("totalHandoverTrips").textContent = data.total_trips;
  console.log(`Displaying ${data.total_trips} handover trips`);

  // Sort trips by seal_time in descending order (newest first)
  const sortedTrips = data.trips.sort((a, b) => {
    if (!a.seal_time) return 1;
    if (!b.seal_time) return -1;
    return b.seal_time.localeCompare(a.seal_time);
  });

  // Fetch parcel counts for all trips using Promise.all
  const parcelPromises = sortedTrips.map(trip =>
    fetch(`/api/report/LH_get_parcel_count/${trip.id}?seq=${trip.sequence_number || 1}&kind=handover`)
      .then(res => res.json())
      .then(result => ({
        trip_id: trip.id,
        total_parcel: result.ok ? result.total_parcel : 0
      }))
      .catch(() => ({ trip_id: trip.id, total_parcel: 0 }))
  );

  return Promise.all(parcelPromises).then(parcelResults => {
    // Create a map for quick lookup
    const parcelMap = {};
    parcelResults.forEach(result => {
      parcelMap[result.trip_id] = result.total_parcel;
    });

    // Populate table with parcel counts
    sortedTrips.forEach((trip, index) => {
      const stt = data.total_trips - index;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align: center;">
          <input type="checkbox" class="trip-checkbox" data-trip-id="${trip.id}" data-trip-number="${trip.trip_number}" data-sequence="${trip.sequence_number || 1}" data-kind="handover" data-to-qty="${trip.load_quantity || 0}" data-parcel-qty="${parcelMap[trip.id] || 0}">
        </td>
        <td style="text-align: center;">${stt}</td>
        <td><strong>${trip.trip_number}</strong></td>
        <td>${trip.vehicle_number || "-"}</td>
        <td>${trip.vehicle_type_name || "-"}</td>
        <td style="text-align: center;">${trip.sequence_number || "-"}</td>
        <td style="text-align: center;">${trip.load_quantity || 0}</td>
        <td style="text-align: center;">${parcelMap[trip.id] || 0}</td>
        <td>${trip.driver_name || "-"}</td>
        <td>${formatDateTime(trip.loading_time)}</td>
        <td>${formatDateTime(trip.seal_time)}</td>
        <td style="text-align: center;">
          <button class="btn-download-trip" id="action-handover-${trip.id}" data-trip-id="${trip.id}" data-trip-number="${trip.trip_number}" data-sequence="${trip.sequence_number || 1}" data-kind="handover" data-to-qty="${trip.load_quantity || 0}" data-parcel-qty="${parcelMap[trip.id] || 0}" onclick="downloadTripFiles(this)">Tải PDF+CSV</button>
        </td>
      `;
      tbody.appendChild(row);
      if (!IS_AUTHENTICATED) {
          const checkbox = row.querySelector('.trip-checkbox');
          const button = row.querySelector('.btn-download-trip');
          if (checkbox) {
            checkbox.disabled = true;
            checkbox.style.opacity = '0.6';
            checkbox.style.cursor = 'not-allowed';
            checkbox.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
          }
          if (button) {
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
          }
        }
    });

    el("handoverSection").style.display = "block";
    updateMassDownloadButtonState();
  });
}

function getTripPayloadFromDataset(dataset) {
  return {
    tripId: dataset.tripId,
    tripNumber: dataset.tripNumber,
    sequenceNumber: Number(dataset.sequence) || 1,
    kind: dataset.kind || 'outbound',
    toQty: Number(dataset.toQty) || 0,
    parcelQty: Number(dataset.parcelQty) || 0
  };
}

function triggerBlobDownload(blob, filename) {
  const blobUrl = URL.createObjectURL(blob);
  const anchor = document.createElement('a');
  anchor.href = blobUrl;
  anchor.download = filename;
  document.body.appendChild(anchor);
  anchor.click();
  document.body.removeChild(anchor);
  URL.revokeObjectURL(blobUrl);
}

function resolveFilenameFromDisposition(disposition, defaultName) {
  if (!disposition) return defaultName;
  const match = disposition.match(/filename="?([^";]+)"?/);
  return match && match[1] ? match[1] : defaultName;
}

async function downloadFileFromUrl(url, defaultName) {
  const response = await fetch(url);
  if (!response.ok) throw new Error(`HTTP ${response.status}`);
  const disposition = response.headers.get('Content-Disposition');
  const filename = resolveFilenameFromDisposition(disposition, defaultName);
  const blob = await response.blob();
  triggerBlobDownload(blob, filename);
}

async function fetchPdfDownloadUrl(tripId) {
  // Use the proxy endpoint instead of getting the Shopee URL directly
  return `/api/report/LH_download_pdf/${tripId}`;
}

async function downloadCsvForTrip(payload) {
  const url = `/api/report/LH_get_list/${payload.tripId}/${payload.tripNumber}?seq=${payload.sequenceNumber}&kind=${payload.kind}&to_qty=${payload.toQty}&parcel_qty=${payload.parcelQty}`;
  const response = await fetch(url);
  if (!response.ok) throw new Error(`HTTP ${response.status}`);

  const disposition = response.headers.get('Content-Disposition');
  let filename = `${payload.tripNumber}.csv`;
  if (disposition && disposition.includes('filename=')) {
    const match = disposition.match(/filename="?([^";]+)"?/);
    if (match && match[1]) filename = match[1];
  }

  const blob = await response.blob();
  triggerBlobDownload(blob, filename);
}

async function downloadTripFiles(btn, progressTracker = null) {
  if (!btn) return;
  const payload = getTripPayloadFromDataset(btn.dataset);
  const originalText = btn.innerHTML;
  try {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Đang tải...';
    btn.style.opacity = '0.7';
    btn.style.cursor = 'not-allowed';

    if (!progressTracker) {
      notice(`⏳ Đang tải PDF cho trip ${payload.tripNumber}...`, "info");
    }
    const pdfUrl = await fetchPdfDownloadUrl(payload.tripId);
    await downloadFileFromUrl(pdfUrl, `${payload.tripNumber}.pdf`);

    if (progressTracker) {
      progressTracker.increment(payload.tripNumber, 'PDF');
    } else {
      audioCache.success.currentTime = 0;
      audioCache.success.play().catch(e => console.log("Audio play failed:", e));
      notice(`✓ Đã tải PDF cho trip ${payload.tripNumber}`, "success", 4000);
    }

    if (!progressTracker) {
      notice(`⏳ Đang tải CSV cho trip ${payload.tripNumber}...`, "info");
    }
    await downloadCsvForTrip(payload);

    if (progressTracker) {
      progressTracker.increment(payload.tripNumber, 'CSV');
    } else {
      notice(`✓ Đã tải CSV cho trip ${payload.tripNumber}`, "success", 4000);
    }

  } catch (error) {
    console.error("Error downloading trip files:", error);
    if (progressTracker) {
      progressTracker.markError(payload.tripNumber, error.message);
    } else {
      notice(`✗ Lỗi: ${error.message}`, "error", 5000);
    }
    throw error;
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  }
}

async function handleMassDownload() {
  const massBtn = el("btnMassDownload");
  if (!massBtn) return;
  const selected = Array.from(document.querySelectorAll('.trip-checkbox:checked'));
  if (!selected.length) {
    notice('⚠ Vui lòng chọn ít nhất một trip để tải', 'warning', 5000);
    return;
  }
  massBtn.disabled = true;

  // Create progress tracker
  const tripNumbers = selected.map(cb => cb.dataset.tripNumber);
  const tracker = createProgressTracker(tripNumbers);

  try {
    const downloadPromises = selected.map(checkbox => {
      const meta = checkbox.dataset;
      const buttonId = `action-${meta.kind}-${meta.tripId}`;
      const btn = document.getElementById(buttonId);
      return btn ? downloadTripFiles(btn, tracker) : Promise.resolve();
    });

    await Promise.allSettled(downloadPromises);

    // Final summary
    const summary = tracker.getSummary();
    if (summary.failed > 0) {
      notice(`✓ Hoàn tất: ${summary.completed}/${summary.total} files thành công, ${summary.failed} lỗi`, 'warning', 8000);
    } else {
      audioCache.success.currentTime = 0;
      audioCache.success.play().catch(e => console.log("Audio play failed:", e));
      notice(`✓ Đã tải thành công ${summary.completed}/${summary.total} files!`, 'success', 6000);
    }
  } finally {
    updateMassDownloadButtonState();
  }
}

function createProgressTracker(tripNumbers) {
  const trips = {};
  tripNumbers.forEach(num => {
    trips[num] = { completed: 0, total: 2, errors: [] };
  });

  const totalFiles = tripNumbers.length * 2;
  let completedFiles = 0;
  let failedFiles = 0;

  function updateNotice() {
    const percentage = Math.round((completedFiles / totalFiles) * 100);
    const lines = [`⏳ Đang tải: ${completedFiles}/${totalFiles} files (${percentage}%)`];

    // Show per-trip progress
    tripNumbers.forEach(num => {
      const t = trips[num];
      const status = t.errors.length > 0 ? '✗' : (t.completed === t.total ? '✓' : '⏳');
      lines.push(`${status} ${num}: ${t.completed}/${t.total}`);
    });

    notice(lines.join('\n'), 'info');
  }

  return {
    increment(tripNumber, fileType) {
      if (trips[tripNumber]) {
        trips[tripNumber].completed++;
        completedFiles++;
        updateNotice();
      }
    },

    markError(tripNumber, errorMsg) {
      if (trips[tripNumber]) {
        trips[tripNumber].errors.push(errorMsg);
        failedFiles++;
        updateNotice();
      }
    },

    getSummary() {
      return {
        total: totalFiles,
        completed: completedFiles,
        failed: failedFiles
      };
    }
  };
}

function updateMassDownloadButtonState() {
  const btn = el("btnMassDownload");
  if (!btn) return;
  const hasSelection = document.querySelectorAll('.trip-checkbox:checked').length > 0;
  btn.disabled = !IS_AUTHENTICATED || !hasSelection;
}

function resetSelectAll(kind) {
  const checkbox = document.querySelector(`.select-all-checkbox[data-target="${kind}"]`);
  if (checkbox) {
    checkbox.checked = false;
    checkbox.indeterminate = false;
  }
}

document.addEventListener("change", event => {
  const target = event.target;
  if (target.classList && target.classList.contains("select-all-checkbox")) {
    const kind = target.dataset.target;
    const checked = target.checked;
    document.querySelectorAll(`.trip-checkbox[data-kind="${kind}"]`).forEach(cb => {
      cb.checked = checked;
    });
    target.indeterminate = false;
    updateMassDownloadButtonState();
  } else if (target.classList && target.classList.contains("trip-checkbox")) {
    const kind = target.dataset.kind;
    if (kind) {
      const group = document.querySelectorAll(`.trip-checkbox[data-kind="${kind}"]`);
      const selectAll = document.querySelector(`.select-all-checkbox[data-target="${kind}"]`);
      if (selectAll && group.length) {
        const checkedCount = Array.from(group).filter(cb => cb.checked).length;
        selectAll.checked = checkedCount === group.length;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < group.length;
      }
    }
    updateMassDownloadButtonState();
  }
});

// Fetch and display SPX DN value
async function updateSpxDN() {
  try {
    const response = await fetch('https://cookie-vnw-default-rtdb.firebaseio.com/SPX/value/cookie.json');
    const cookieString = await response.text();

    if (cookieString && cookieString !== 'null') {
      // Remove quotes from the string
      const cleanString = cookieString.replace(/^"|"$/g, '');

      // Extract fms_display_name from cookie string
      const match = cleanString.match(/fms_display_name=([^;]+)/);
      if (match && match[1]) {
        el("spxDN").textContent = match[1];
        el("spxDN").style.color = '#0275d8'; // Blue color
      } else {
        el("spxDN").textContent = 'N/A';
        el("spxDN").style.color = '#999';
      }
    } else {
      el("spxDN").textContent = 'N/A';
      el("spxDN").style.color = '#999';
    }
  } catch (error) {
    console.warn("Could not fetch SPX DN:", error);
    el("spxDN").textContent = 'Không thể lấy';
    el("spxDN").style.color = '#999';
  }
}

// Event listeners
// Fetch and display cookie expiry time
async function updateCookieExpiry() {
  try {
    const response = await fetch('https://cookie-vnw-default-rtdb.firebaseio.com/SPX/value/expiry_str.json');
    const expiryStr = await response.text();

    if (expiryStr && expiryStr !== 'null') {
      // Parse the expiry_str (format: "06-12-2025 17:03:52")
      const cleanStr = expiryStr.replace(/^"|"$/g, ''); // Remove quotes if any

      // Parse DD-MM-YYYY HH:MM:SS format
      const [datePart, timePart] = cleanStr.split(' ');
      const [day, month, year] = datePart.split('-').map(Number);
      const [hours, mins, secs] = timePart.split(':').map(Number);

      const expiryTime = new Date(year, month - 1, day, hours, mins, secs);
      const now = new Date();
      const diffMs = expiryTime - now;

      if (diffMs > 0) {
        const diffMins = Math.floor(diffMs / 60000);

        el("cookieExpiry").textContent = `${diffMins} phút`;
        // Green if >= 150 mins, Orange if < 150 mins, Red if expired
        if (diffMins >= 150) {
          el("cookieExpiry").style.color = '#5cb85c'; // Green
        } else {
          el("cookieExpiry").style.color = '#f0ad4e'; // Orange
        }
      } else {
        el("cookieExpiry").textContent = 'Đã hết hạn';
        el("cookieExpiry").style.color = '#d9534f';
      }
    }
  } catch (error) {
    console.warn("Could not fetch cookie expiry:", error);
    el("cookieExpiry").textContent = 'Không thể lấy thông tin';
  }
}

document.addEventListener("DOMContentLoaded", () => {
  // Set today's date as default
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  el("selectedDate").value = `${yyyy}-${mm}-${dd}`;

  el("btnFetchTrips").addEventListener("click", fetchTrips);
  const massBtn = el("btnMassDownload");
  if (massBtn) {
    massBtn.addEventListener("click", handleMassDownload);
  }
  updateMassDownloadButtonState();

  // Update SPX DN and cookie expiry on page load and every 5 seconds
  updateSpxDN();
  updateCookieExpiry();
  setInterval(() => {
    updateSpxDN();
    updateCookieExpiry();
  }, 5000);
});
</script>

<!-- ========================== View-Only Mode Handler ========================== -->
<script>
(function() {
  "use strict";
  function disableControl(element) {
    if (!element) return;
    element.disabled = true;
    element.style.opacity = '0.6';
    element.style.cursor = 'not-allowed';
    element.title = 'Vui lòng đăng nhập để sử dụng chức năng này';
  }

  function applyViewOnlyMode() {
    if (IS_AUTHENTICATED) return;
    console.log('[VIEW-ONLY] Disabling all action controls');
    const inputs = ['selectedDate'];
    inputs.forEach(id => {
      const field = document.getElementById(id);
      if (field) {
        disableControl(field);
        field.readOnly = true;
      }
    });
    const buttons = ['btnFetchTrips', 'btnMassDownload'];
    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) {
        disableControl(btn);
      }
    });
    document.querySelectorAll('.trip-checkbox, .select-all-checkbox').forEach(el => disableControl(el));
    document.querySelectorAll('.btn-download-trip').forEach(btn => disableControl(btn));
    const notice = document.getElementById('notice');
    if (notice) {
      notice.innerHTML = '⚠ Chế độ chỉ xem - Vui lòng đăng nhập để thực hiện thao tác';
      notice.className = 'notice';
      notice.setAttribute('data-kind', 'warning');
      notice.style.display = 'block';
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyViewOnlyMode);
  } else {
    applyViewOnlyMode();
  }
  setTimeout(applyViewOnlyMode, 500);
})();
</script>
{% endblock %}
