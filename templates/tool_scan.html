{% extends "base.html" %}
{% block title %}Scan Tool{% endblock %}
{% block content %}

<script>
  window.API_BASE = window.API_BASE || "";
</script>

<!-- ===== Notice ===== -->
<div id="notice" class="notice"></div>
  <div class="row card space-between">
    <div class="row">
      <label>Ng√†y</label>
      <input id="dayPicker" type="date">
      <label>Warehouse</label>
      <select id="warehouse"><option>VNDB</option></select>
      <label>Ch·∫ø ƒë·ªô</label>
      <select id="scanMode">
        <option value="vanhanh">Vanhanh API</option>
        <option value="firebase">Firebase VNDB</option>
      </select>
      <label>Ca</label>
      <div class="row">
        <input id="hour" type="number" min="0" max="23">
        <span>:</span>
        <select id="minute"><option>00</option><option>30</option></select>
      </div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="scan">SCAN IN/OUT</button>
    <button class="tab-btn" data-tab="task">SCAN TASK</button>
    <button class="tab-btn" data-tab="dash">DASHBOARD</button>
    <button class="tab-btn" data-tab="analyze">ANALYZE</button>
  </div>

  <!-- ========================== PANEL: SCAN ========================== -->
  <section id="tab-scan" class="tab-panel grid grid-2">
    <div class="grid">
      <!-- IN -->
      <div class="card">
        <div class="row">
          <input id="in-wfm" type="text" class="big grow" placeholder="Scan M√£ QR ho·∫∑c M√£ Vendor ho·∫∑c M√£ WFM" spellcheck="false">
          <button id="btnScanIn" class="btn-action">Scan In</button>
        </div>
        <hr>
        <div class="grid grid-2">
          <div>
            <div class="kpi" id="in-fullname"></div>
            <div class="row"><label>Nh√† th·∫ßu:</label> <div id="in-vendor" class="grow"></div></div>
            <div class="row"><label>M√£ Vendor:</label> <div id="in-vendor-code" class="grow"></div></div>
            <div class="row"><label>Gi·ªõi t√≠nh:</label> <div id="in-gender" class="grow"></div></div>
            <div class="row"><label>NƒÉm sinh:</label> <div id="in-birth" class="grow"></div></div>
            <div class="row"><label>Operator:</label> <div id="in-operator" class="grow"></div></div>
            <div class="row"><label>WMS ID:</label> <div id="in-wmsid" class="grow"></div></div>
          </div>
          <div class="row end">
            <img id="in-avatar" class="avatar" alt="avatar">
          </div>
        </div>
      </div>

      <!-- OUT -->
      <div class="card">
        <div class="row">
          <input id="out-wfm" type="text" class="big grow" placeholder="Scan M√£ QR ho·∫∑c M√£ Vendor ho·∫∑c M√£ WFM" spellcheck="false">
          <button id="btnScanOut" class="btn-action">Scan Out</button>
        </div>
        <hr>
        <div class="grid grid-2">
          <div>
            <div class="kpi" id="out-fullname"></div>
            <div class="row"><label>Nh√† th·∫ßu:</label> <div id="out-vendor" class="grow"></div></div>
            <div class="row"><label>M√£ Vendor:</label> <div id="out-vendor-code" class="grow"></div></div>
            <div class="row"><label>Gi·ªõi t√≠nh:</label> <div id="out-gender" class="grow"></div></div>
            <div class="row"><label>NƒÉm sinh:</label> <div id="out-birth" class="grow"></div></div>
            <div class="row"><label>Operator:</label> <div id="out-operator" class="grow"></div></div>
            <div class="row"><label>WMS ID:</label> <div id="out-wmsid" class="grow"></div></div>
          </div>
          <div class="row end">
            <img id="out-avatar" class="avatar" alt="avatar">
          </div>
        </div>
      </div>
    </div>

    <!-- Counter ph·∫£i -->
    <div class="grid">
      <div class="counter card">
        <h3 id="in-total">Total Scan In</h3>
        <div id="in-shifts"><div class="block">
          <div class="stats-line"><strong></strong></div>
          <div class="stats-line vendors"><span></span></div>
        </div></div>
        <hr>
        <div id="in-vendor-stats" class="stats-line vendors"><span></span></div>
      </div>

      <div class="counter card">
        <h3 id="out-total">Total Scan Out</h3>
        <div id="out-shifts"><div class="stats-line"></div></div>
        <hr>
        <div id="out-vendor-stats" class="stats-line"></div>
      </div>
    </div>
  </section>

  <!-- ========================== PANEL: TASK ========================== -->
  <section id="tab-task" class="tab-panel grid grid-2 is-hidden">
    <div class="grid" style="gap: 0; display: flex; flex-direction: column;">
      <div class="card row">
        <input id="task-wfm" type="text" class="big grow" placeholder="Scan M√£ QR ho·∫∑c WFM" spellcheck="false">
        <select id="task-type">
          <option value="A0027">Ngh·ªâ Tr∆∞a</option>
          <option value="A0020">V√†o Ca</option>
          <option value="A0026">Ngh·ªâ OT</option>
        </select>
        <button id="btnScanTask" class="btn-action">SCAN</button>
        <div id="task-result" class="kpi ml-auto"></div>
      </div>

      <div class="card" style="margin-top: -1px; border-radius: 0 0 8px 8px;">
        <div class="grid grid-2">
          <div>
            <div class="kpi" id="task-fullname"></div>
            <div class="row"><label>Nh√† th·∫ßu:</label>  <div id="task-vendor" class="grow"></div></div>
            <div class="row"><label>M√£ Vendor:</label> <div id="task-vendor-code" class="grow"></div></div>
            <div class="row"><label>Gi·ªõi t√≠nh:</label> <div id="task-gender" class="grow"></div></div>
            <div class="row"><label>NƒÉm sinh:</label> <div id="task-birth" class="grow"></div></div>
            <div class="row"><label>Operator:</label> <div id="task-operator" class="grow"></div></div>
            <div class="row"><label>WMS ID:</label>   <div id="task-wmsid" class="grow"></div></div>
          </div>
          <div class="row end">
            <img id="task-avatar" class="avatar" alt="avatar">
          </div>
        </div>
      </div>
    </div>

    <!-- Counter ph·∫£i -->
    <div class="grid" id="task-right">
      <div class="counter card" id="task60-card">
        <h3 id="task60-header">Ngh·ªâ Tr∆∞a: 0 / V√†o Ca: 0 / Total: 0</h3>
        <div id="task60-total" class="stats-line is-hidden"></div>
        <div id="task60-shifts"><div class="stats-line"><span class="spinner-lg"></span> ƒêang t·∫£i...</div></div>
        <hr>
        <div id="task60-vendor-stats" class="stats-line"></div>
      </div>

      <div class="counter card" id="task30-card">
        <h3 id="task30-header">Ngh·ªâ OT: 0 / V√†o Ca: 0 / Total: 0</h3>
        <div id="task30-total" class="stats-line is-hidden"></div>
        <div id="task30-shifts"><div class="stats-line"><span class="spinner-lg"></span> ƒêang t·∫£i...</div></div>
        <hr>
        <div id="task30-vendor-stats" class="stats-line"></div>
      </div>
    </div>
  </section>

  <!-- ========================== PANEL: DASHBOARD ========================== -->
  <section id="tab-dash" class="tab-panel is-hidden">
    <div class="table-wrap card">
  <div class="title">
    <span>Dashboard nh√¢n s·ª±</span>
    <div>
      <button id="btnEditMode" class="btn-action" title="B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô ch·ªânh s·ª≠a">Edit Mode</button>
      <button id="btnResetFilters" class="btn-action" title="Reset t·∫•t c·∫£ b·ªô l·ªçc">Reset Filters</button>
      <button id="btnExportXlsx" class="btn-action" title="T·∫£i Excel">Export Excel</button>
    </div>
  </div>


      <div class="table-container">
        <table class="table" id="tbl-dashboard">
          <thead>
            <tr>
              <th class="sticky">No.</th>
              <th class="sticky"><button class="filter-btn" data-col="vendor_name" title="L·ªçc">‚è∑</button>Nh√† Th·∫ßu</th>
              <th class="sticky"><button class="filter-btn" data-col="vendor_code" title="L·ªçc">‚è∑</button>M√£ Vendor</th>
              <th class="sticky"><button class="filter-btn" data-col="wfm_code" title="L·ªçc">‚è∑</button>M√£ WFM</th>
              <th class="sticky"><button class="filter-btn" data-col="wms_user_id" title="L·ªçc">‚è∑</button>M√£ WMS</th>
              <th class="sticky tbl-col-fullname"><button class="filter-btn" data-col="fullname" title="L·ªçc">‚è∑</button>H·ªç v√† T√™n</th>
              <th class="sticky tbl-col-gender"><button class="filter-btn" data-col="gender" title="L·ªçc">‚è∑</button>Gi·ªõi t√≠nh</th>
              <th class="sticky"><button class="filter-btn" data-col="birth_year" title="L·ªçc">‚è∑</button>SN</th>
              <th class="sticky"><button class="filter-btn" data-col="shift_in" title="L·ªçc">‚è∑</button>In</th>
              <th class="sticky"><button class="filter-btn" data-col="break_60" title="L·ªçc">‚è∑</button>Ngh·ªâ Tr∆∞a</th>
              <th class="sticky"><button class="filter-btn" data-col="break_60_in" title="L·ªçc">‚è∑</button>V√†o Ca</th>
              <th class="sticky"><button class="filter-btn" data-col="break_30" title="L·ªçc">‚è∑</button>Ngh·ªâ OT</th>
              <th class="sticky"><button class="filter-btn" data-col="break_30_in" title="L·ªçc">‚è∑</button>V√†o Ca</th>
              <th class="sticky"><button class="filter-btn" data-col="shift_out" title="L·ªçc">‚è∑</button>Out</th>
            </tr>
          </thead>
          <tbody id="tbody-dash">
          </tbody>
        </table>

        <div class="pager" id="dash-pager">
          <button id="dash-prev" class="btn-action" disabled="">¬´</button>
          <span class="page-info" id="dash-info">Trang 1 / 1 ‚Äî 1 k·∫øt qu·∫£</span>
          <button id="dash-next" class="btn-action" disabled="">¬ª</button>
          <span>ƒê·∫øn trang:</span>
          <input type="number" min="1" value="1" class="jump" id="dash-jump">
        </div>
      </div>
    </div>
  </section>

  <!-- ========================== PANEL: ANALYZE ========================== -->
  <section id="tab-analyze" class="tab-panel is-hidden">
    <div class="card">
      <div class="title">
        <span>Ph√¢n t√≠ch d·ªØ li·ªáu</span>
        <div style="display: flex; align-items: center; gap: 12px;">
          <label style="font-size: 14px; white-space: nowrap;">Ng∆∞·ª°ng User C≈©:</label>
          <input id="analyze-threshold" type="number" min="1" max="100" value="3"
                 style="width: 60px; padding: 4px 8px; text-align: center;"
                 title="User c≈© khi xu·∫•t hi·ªán tr√™n N l·∫ßn trong database">
          <span style="font-size: 13px; color: #666;">l·∫ßn</span>
          <button id="btnRefreshAnalyze" class="btn-action is-hidden" title="L√†m m·ªõi ph√¢n t√≠ch">Refresh</button>
        </div>
      </div>

      <div id="analyze-loading" class="stats-line" style="text-align: center; padding: 20px;">
        <span class="spinner-lg"></span> ƒêang t·∫£i d·ªØ li·ªáu ph√¢n t√≠ch...
      </div>

      <div id="analyze-content" class="is-hidden">
        <!-- Main Charts Grid -->
        <div class="grid grid-2" style="gap: 16px; margin-bottom: 16px;">
          <!-- 1. Gender Analysis Chart -->
          <div class="card">
            <h3 style="margin-top: 0; text-align: center;">Ph√¢n t√≠ch theo Gi·ªõi t√≠nh</h3>
            <div style="max-width: 350px; margin: 0 auto;">
              <canvas id="chart-gender"></canvas>
            </div>
            <div class="grid grid-2" style="margin-top: 16px;">
              <div class="stats-line" style="text-align: center;">
                <strong>Nam:</strong> <span id="analyze-male-count">0</span> (<span id="analyze-male-pct">0%</span>)
              </div>
              <div class="stats-line" style="text-align: center;">
                <strong>N·ªØ:</strong> <span id="analyze-female-count">0</span> (<span id="analyze-female-pct">0%</span>)
              </div>
            </div>
          </div>

          <!-- 2. User Type with Gender Breakdown Chart -->
          <div class="card">
            <h3 style="margin-top: 0; text-align: center;">Ph√¢n t√≠ch User C≈©/M·ªõi theo Gi·ªõi t√≠nh</h3>
            <div style="font-size: 12px; color: #666; text-align: center; margin-bottom: 8px;">
              (User c≈©: m√£ S xu·∫•t hi·ªán tr√™n <strong><span id="analyze-threshold-display">3</span></strong> l·∫ßn trong database)
            </div>
            <div style="max-width: 350px; margin: 0 auto;">
              <canvas id="chart-usertype-gender"></canvas>
            </div>
            <div style="margin-top: 16px;">
              <!-- Old Users Stats -->
              <div style="border: 2px solid #FFCE56; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #fffbf0;">
                <div style="font-weight: bold; margin-bottom: 8px; color: #856404;">
                  üë• User C≈©: <span id="analyze-old-count">0</span> (<span id="analyze-old-pct">0%</span>)
                </div>
                <div class="grid grid-2" style="gap: 8px;">
                  <div class="stats-line" style="text-align: center; font-size: 14px;">
                    Nam: <span id="analyze-old-male">0</span> (<span id="analyze-old-male-pct">0%</span>)
                  </div>
                  <div class="stats-line" style="text-align: center; font-size: 14px;">
                    N·ªØ: <span id="analyze-old-female">0</span> (<span id="analyze-old-female-pct">0%</span>)
                  </div>
                </div>
              </div>

              <!-- New Users Stats -->
              <div style="border: 2px solid #4BC0C0; border-radius: 8px; padding: 12px; background: #f0fffe;">
                <div style="font-weight: bold; margin-bottom: 8px; color: #0c5460;">
                  ‚ú® User M·ªõi: <span id="analyze-new-count">0</span> (<span id="analyze-new-pct">0%</span>)
                </div>
                <div class="grid grid-2" style="gap: 8px;">
                  <div class="stats-line" style="text-align: center; font-size: 14px;">
                    Nam: <span id="analyze-new-male">0</span> (<span id="analyze-new-male-pct">0%</span>)
                  </div>
                  <div class="stats-line" style="text-align: center; font-size: 14px;">
                    N·ªØ: <span id="analyze-new-female">0</span> (<span id="analyze-new-female-pct">0%</span>)
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Modal -->
  <div id="filterModal" class="filter-modal">
    <div class="filter-content">
      <h4 id="filterTitle">L·ªçc d·ªØ li·ªáu</h4>
      <div class="filter-search">
        <input type="text" id="filterSearch" placeholder="T√¨m ki·∫øm..." style="width: 100%; margin-bottom: 10px;">
      </div>
      <div id="filterOptions" class="filter-options"></div>
      <div class="filter-actions">
        <button id="filterClear">X√≥a t·∫•t c·∫£</button>
        <button id="filterCancel">H·ªßy</button>
        <button id="filterApply" class="btn-primary">√Åp d·ª•ng</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="filter-modal">
    <div class="filter-content">
      <h4>Ch·ªânh s·ª≠a nh√¢n s·ª±</h4>
      <div id="editForm">
        <label>Nh√† th·∫ßu</label>
        <input id="edit-vendor_name" type="text">

        <label>M√£ Vendor</label>
        <input id="edit-vendor_code" type="text">

        <label>M√£ WFM</label>
        <input id="edit-wfm_code" type="text" disabled>

        <label>M√£ WMS</label>
        <input id="edit-wms_user_id" type="text">

        <label>H·ªç v√† t√™n</label>
        <input id="edit-fullname" type="text">

        <label>Gi·ªõi t√≠nh</label>
        <input id="edit-gender" type="text">

        <label>NƒÉm sinh</label>
        <input id="edit-birth_year" type="text">
      </div>
      <div class="filter-actions">
        <button id="editCancel">H·ªßy</button>
        <button id="editSave" class="btn-primary">L∆∞u</button>
      </div>
    </div>
  </div>

<!-- ========================== APP SCRIPT (c√≥ th·ªÉ t√°ch assets/app.js) ========================== -->
<script>
(() => {
  "use strict";

  /* ====================== CONFIG ====================== */
  const CONFIG = {
    API_BASE: window.API_BASE || ""   // same-origin
  };
  // Enable/disable extra QA verification before marking scan success
  // Set to true to call /wms/verify_scan API which should return { ok: true } when the scan is valid
  CONFIG.ENABLE_QA_CHECK = true;

  // ===== MODULAR SOUND SYSTEM =====
  let playOk, playErr, playCancel, playSysOk, playSysErr;

  // Dynamic import for sound system
  (async () => {
    try {
      const soundModule = await import('../static/js/sound-system.js');
      const STATIC_AUDIO_URLS = {
        "cancel.mp3":      "{{ url_for('static', filename='sounds/cancel.mp3') }}",
        "error.mp3":       "{{ url_for('static', filename='sounds/error.mp3') }}",
        "ok.mp3":          "{{ url_for('static', filename='sounds/ok.mp3') }}",
        "sys_error.mp3":   "{{ url_for('static', filename='sounds/sys_error.mp3') }}",
        "sys_success.mp3": "{{ url_for('static', filename='sounds/sys_success.mp3') }}"
      };
      await soundModule.initSounds(STATIC_AUDIO_URLS);
      playOk = soundModule.playOk;
      playErr = soundModule.playErr;
      playCancel = soundModule.playCancel;
      playSysOk = soundModule.playSysOk;
      playSysErr = soundModule.playSysErr;
    } catch (e) {
      console.warn('Failed to load sound system:', e);
      // Fallback to simple beep
      const fallbackBeep = () => console.beep?.() || console.log('beep');
      playOk = playErr = playCancel = playSysOk = playSysErr = fallbackBeep;
    }
  })();

  /* ====================== UTILS ====================== */

  // ==== Vendor code helpers ====
  // 10 k√Ω t·ª±, b·∫Øt ƒë·∫ßu b·∫±ng "SP", ph·∫ßn c√≤n l·∫°i ch·ªØ/s·ªë
  const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";
  // M√£ WFM thu·∫ßn: S + 6 ch·ªØ s·ªë (v√≠ d·ª•: S012345)
  const WFM_RE = /^S\d{6}$/i;

  /** C·∫≠p nh·∫≠t c√°c counter t·ªïng t·ª´ raw RTDB */
  function renderBreakCounters(raw){
    const s = computeTaskStats(raw);

    // Ngh·ªâ Tr∆∞a ‚Äì 60'
    const b60   = document.getElementById("nt-b60");
    const b60in = document.getElementById("nt-b60in");
    if (b60)   b60.textContent   = s.total_b60;
    if (b60in) b60in.textContent = s.total_b60_in;
    document.querySelectorAll(".nt-totalin").forEach(el => el.textContent = s.total_in);

    // Ngh·ªâ OT ‚Äì 30'
    const b30   = document.getElementById("no-b30");
    const b30in = document.getElementById("no-b30in");
    if (b30)   b30.textContent   = s.total_b30;
    if (b30in) b30in.textContent = s.total_b30_in;
    document.querySelectorAll(".no-totalin").forEach(el => el.textContent = s.total_in);
  }

  /** T√≠nh t·ªïng v√† theo ca t·ª´ raw RTDB c·ªßa ng√†y hi·ªán t·∫°i */
  function computeTaskStats(raw){
    const byShift = {}; // {shift: { total_in, b60, b60_in, b30, b30_in }}

    for (const [shift, vendors] of Object.entries(raw || {})){
      const S = (byShift[shift] ||= { total_in:0, b60:0, b60_in:0, b30:0, b30_in:0 });
      for (const staffGroup of Object.values(vendors || {})){
        for (const s of Object.values(staffGroup || {})){
          if (!s) continue;

          if (hasVal(s.shift_in))      S.total_in++;
          if (hasVal(s.break_60))      S.b60++;
          if (hasVal(s.break_60_in))   S.b60_in++;
          if (hasVal(s.break_30))      S.b30++;
          if (hasVal(s.break_30_in))   S.b30_in++;
        }
      }
    }

    // T·ªïng to√†n ng√†y
    let total_in=0, total_b60=0, total_b60_in=0, total_b30=0, total_b30_in=0;
    for (const sh of Object.keys(byShift)){
      const S = byShift[sh];
      total_in     += S.total_in;
      total_b60    += S.b60;
      total_b60_in += S.b60_in;
      total_b30    += S.b30;
      total_b30_in += S.b30_in;
    }

    return { byShift, total_in, total_b60, total_b60_in, total_b30, total_b30_in };
  }

  function findTodayRec(flat, staff_no){
    return flat.find(r => r.wfm_code?.toUpperCase() === staff_no.toUpperCase());
  }

  function safeFocus(id){
  // ƒë·ª£i DOM re-enable xong r·ªìi m·ªõi focus
  setTimeout(()=>{
    const elv = document.getElementById(id);
    if(!elv) return;
    // ƒë·∫£m b·∫£o kh√¥ng c√≤n disabled/hidden
    elv.disabled = false;
    try{ elv.focus(); elv.select?.(); }catch(_){}
  }, 0); // c√≥ th·ªÉ ƒë·ªïi 0 ‚Üí 30‚Äì50ms n·∫øu v·∫´n b·ªã toast/transition c∆∞·ªõp focus
}

  // Tr·∫£ v·ªÅ l√Ω do ch·∫∑n (string) ho·∫∑c "" n·∫øu h·ª£p l·ªá
  function checkDuplicateByKeys(rec, action){
  const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";
  if(!rec) return "";

  if(action === "in"){
    if(hasVal(rec.shift_in)) return "Nh√¢n vi√™n n√†y ƒë√£ Scan In trong ng√†y r·ªìi!";
  } else if(action === "out"){
    if(!hasVal(rec.shift_in)) return "Nh√¢n vi√™n n√†y ch∆∞a Scan In, kh√¥ng th·ªÉ Out.";
    if(hasVal(rec.shift_out) || hasVal(rec.gsheet_time_out)) return "Nh√¢n vi√™n n√†y ƒë√£ Scan Out trong ng√†y r·ªìi!";
  } else if(action === "A0027"){           // m·ªü 60'
    if(hasVal(rec.break_60)) return "Nh√¢n vi√™n ƒë√£ v√†o ca sau gi·ªù ngh·ªâ tr∆∞a r·ªìi.";
  } else if(action === "A0026"){           // m·ªü 30'
    if(hasVal(rec.break_30)) return "Nh√¢n vi√™n ƒë√£ v√†o ca sau gi·ªù ngh·ªâ OT r·ªìi.";
  } else if(action === "A0020"){           // k·∫øt th√∫c break (v√†o ca)
    const open60 = hasVal(rec.break_60) && !hasVal(rec.break_60_in);
    const open30 = hasVal(rec.break_30) && !hasVal(rec.break_30_in);
    if (!open60 && !open30) return "Nh√¢n vi√™n n√†y ƒë√£ v√†o ca r·ªìi.";
    if (open60 && open30)   return "Nh√¢n vi√™n n√†y ƒë√£ ngh·ªâ gi·∫£i lao r·ªìi.";
    // ‚úÖ H·ª£p l·ªá: ƒë√∫ng 1 lo·∫°i ƒëang m·ªü ‚Üí KH√îNG tr·∫£ th√¥ng b√°o block
  }

  return "";
}

  const VENDOR_RE = /^SP[A-Z0-9]{8}$/i;
  const VANHANH_BASE = "https://vanhanh.shopee.vn";

  /** N·∫øu nh·∫≠p m√£ vendor, t·ª± gh√©p sang URL /spx-ops/wh/<code>; n·∫øu l√† URL/QR th√¨ gi·ªØ nguy√™n */
  function normalizeVendorOrQR(input) {
    const s = (input || "").trim();
    if (!s) return "";
    if (VENDOR_RE.test(s)) return `${VANHANH_BASE}/spx-ops/wh/${s.toUpperCase()}`;
    return s;
  }

  /** (tu·ª≥ ch·ªçn) b√°o s·ªõm n·∫øu nh·∫≠p sai ƒë·ªãnh d·∫°ng vendor */
  function assertValidVendorOrQR(s){
    const v = (s||"").trim();
    if (!v) throw new Error("Vui l√≤ng nh·∫≠p/scan m√£.");
    const looksUrl = /^https?:\/\//i.test(v) || v.includes("/");
    if (!looksUrl && !VENDOR_RE.test(v)) {
      // Kh√¥ng b·∫Øt bu·ªôc ph·∫£i throw. N·∫øu mu·ªën ch·∫∑t ch·∫Ω th√¨ m·ªü comment d∆∞·ªõi:
      // throw new Error("M√£ Vendor ph·∫£i 10 k√Ω t·ª± v√† b·∫Øt ƒë·∫ßu b·∫±ng SP (vd: SP12345678).");
    }
    return v;
  }

  // ==== DOM helpers ====
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const el = (id)=>document.getElementById(id);

  const notice = (msg, kind="info", timeout=3000) => {
    const n = el("notice");
    if (!n) return;

    // If no message, clear content and styling and exit
    if (!msg) {
      n.innerHTML = "";
      n.removeAttribute("data-kind");
      return;
    }

    // Show message with kind
    n.dataset.kind = kind;

    // Add spinner for loading messages
    let htmlMsg = msg;
    const isLoading = kind === 'info' && /ƒêang t·∫£i|ƒêang l·∫•y|ƒêang ph√¢n t√≠ch|‚è≥/.test(msg);
    if (isLoading) {
      htmlMsg = `<span class="spinner-lg spinner-lg-notice"></span>${msg.replace(/^‚è≥\s?/, '')}`;
    }
    n.innerHTML = htmlMsg;

    // Auto-clear after timeout: remove text and styling so background color doesn't linger
    if (notice._t) clearTimeout(notice._t);
    if (timeout > 0) {
      notice._t = setTimeout(() => {
        n.innerHTML = "";
        n.removeAttribute("data-kind");
      }, timeout);
    }
  };

  const todayKey = (d=new Date())=>{
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };

  const ceilToNext15 = ()=>{
    const d=new Date();
    let h=d.getHours(), m=d.getMinutes();
    let next=Math.floor(m/15)*15+15; if(next>=60){ next=0; h=(h+1)%24; }
    const use30=(next===0||next===15)?"00":"30";
    return {h, use30};
  };

  const toVendorCode = (input)=>{
    const s=(input||"").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)){
      try{ const u=new URL(s); const parts=u.pathname.split('/').filter(Boolean); return parts.pop(); }catch{ return s; }
    }
    if(s.includes("/")){ const parts=s.split('/').filter(Boolean); return parts.pop(); }
    return s;
  };

  const imgFromUrl = async (url)=>{
    try{ const r=await fetch(url); if(!r.ok) return ""; return URL.createObjectURL(await r.blob()); }catch{ return ""; }
  };

  function setBusy(on){ document.documentElement.classList.toggle('busy', !!on); }
  function setAllDisabled(disabled=true){
  const dayLocked = document.body.dataset.dayLock === "1";
  const finalDisabled = disabled || dayLocked; // n·∫øu dayLocked th√¨ lu√¥n gi·ªØ disable

  ["in-wfm","btnScanIn","task-wfm","btnScanTask","out-wfm","btnScanOut"].forEach(id=>{
    const n = document.getElementById(id);
    if (!n) return;
    n.disabled = finalDisabled;
    n.style.opacity = finalDisabled ? "0.6" : "1";
    n.style.cursor  = finalDisabled ? "not-allowed" : "pointer";
  });
}

  function scheduleShiftAutoAdvance(){
    const apply=()=>{
      const {h,use30}=ceilToNext15();
      const hourEl=el('hour'), minuteEl=el('minute');
      if(hourEl && minuteEl){
        const hh=String(+h).padStart(2,'0');
        if(hourEl.value!==hh) hourEl.value=hh;
        if(minuteEl.value!==use30) minuteEl.value=use30;
      }
      const now=new Date();
      const msToNextMinute=60000-(now.getSeconds()*1000+now.getMilliseconds());
      setTimeout(apply, msToNextMinute);
    };
    apply();
  }

  // ==== Day lock helpers ====
  function isTodayStr(yyyy_mm_dd){
    if (!/^\d{4}-\d{2}-\d{2}$/.test(yyyy_mm_dd||"")) return false;
    return yyyy_mm_dd === todayKey();
  }

  // Kh√≥a qu√©t n·∫øu ch·ªçn kh√°c h√¥m nay (past/future)
  function applyDayLock(){
    const dp = document.getElementById('dayPicker');
    const locked = dp && !isTodayStr(dp.value);
    document.body.dataset.dayLock = locked ? "1" : "0";

    // Ch·ªâ t√°c ƒë·ªông t·ªõi c√°c control qu√©t
    const ids = ["in-wfm","btnScanIn","task-wfm","btnScanTask","out-wfm","btnScanOut"];
    ids.forEach(id=>{
      const n = document.getElementById(id);
      if (!n) return;
      n.disabled = !!locked;
      n.style.opacity = locked ? "0.6" : "1";
      n.style.cursor  = locked ? "not-allowed" : "pointer";
    });

    // Disable Edit Mode button when viewing non-today dates
    const btnEdit = document.getElementById('btnEditMode');
    if(btnEdit){
      btnEdit.disabled = !!locked;
      btnEdit.style.opacity = locked ? "0.6" : "1";
      btnEdit.style.cursor  = locked ? "not-allowed" : "pointer";
      if(locked && document.body.dataset.editMode === "1"){
        // Auto-disable edit mode if locked
        document.body.dataset.editMode = "0";
        btnEdit.textContent = "Edit Mode";
        btnEdit.classList.remove('active');
      }
    }

    if (locked) {
      notice("ƒêang xem ng√†y c≈© (ho·∫∑c kh√°c h√¥m nay) ‚Äî ƒë√£ t·∫Øt ch·ª©c nƒÉng qu√©t v√† ch·ªânh s·ª≠a.", "warning", 6000);
    }
  }

  /* ====================== SERVICES (API/BE) ====================== */

  // Analytics state
  const ANALYZE = {
    allData: {},      // All historical data from VNDB
    currentData: {},  // Current day data
    stats: null
  };

  async function fetchAllVNDBData(){
    // Fetch entire VNDB database to count S-code frequencies
    const url = `https://data-scan-tool-default-rtdb.asia-southeast1.firebasedatabase.app/VNDB.json`;
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      return data || {};
    } catch (e) {
      console.error('[fetchAllVNDBData]', e);
      throw e;
    }
  }

  function countSCodeFrequencies(allData){
    // Count how many times each S-code appears across all dates
    const frequencies = {};

    for (const [date, dateData] of Object.entries(allData || {})) {
      for (const [shift, shiftData] of Object.entries(dateData || {})) {
        for (const [vendor, vendorData] of Object.entries(shiftData || {})) {
          for (const [wfmCode, record] of Object.entries(vendorData || {})) {
            // wfmCode is the S-code (e.g., S012345)
            if (wfmCode && wfmCode.startsWith('S')) {
              const upperCode = wfmCode.toUpperCase();
              frequencies[upperCode] = (frequencies[upperCode] || 0) + 1;
            }
          }
        }
      }
    }

    return frequencies;
  }

  // Normalize gender to either "NAM" or "N·ªÆ"
  function normalizeGender(genderInput) {
    const g = String(genderInput || '').trim().toUpperCase().normalize("NFC");

    // Male variations
    if (['NAM', 'MALE', 'M', 'BOY', 'MAN'].includes(g)) {
      return 'NAM';
    }

    // Female variations - handle Unicode normalization
    if (['N·ªÆ', 'NU', 'N∆Ø', 'FEMALE', 'F', 'GIRL', 'WOMAN'].includes(g)) {
      return 'N·ªÆ';
    }

    // If unclear, return empty (will be counted as unknown)
    return '';
  }

  function analyzeData(currentDayData, sCodeFrequencies, threshold = 3){
    // Flatten current day data
    const records = [];
    for (const [shift, shiftData] of Object.entries(currentDayData || {})) {
      for (const [vendor, vendorData] of Object.entries(shiftData || {})) {
        for (const [wfmCode, record] of Object.entries(vendorData || {})) {
          if (record && record.wfm_code) {
            const normalizedGender = normalizeGender(record.gender);
            records.push({
              ...record,
              wfm_code: (record.wfm_code || wfmCode).toUpperCase(),
              gender: normalizedGender,
              frequency: sCodeFrequencies[(record.wfm_code || wfmCode).toUpperCase()] || 1
            });
          }
        }
      }
    }

    // Calculate stats
    const total = records.length;

    // Gender counts
    let maleCount = 0, femaleCount = 0, unknownCount = 0;
    for (const r of records) {
      if (r.gender === 'NAM') {
        maleCount++;
      } else if (r.gender === 'N·ªÆ') {
        femaleCount++;
      } else {
        unknownCount++;
      }
    }

    // Old/New user counts (old = frequency > threshold)
    let oldCount = 0, newCount = 0;
    for (const r of records) {
      if (r.frequency > threshold) {
        oldCount++;
      } else {
        newCount++;
      }
    }

    // Combined: Gender by User Type
    let oldMale = 0, oldFemale = 0, oldUnknown = 0;
    let newMale = 0, newFemale = 0, newUnknown = 0;
    for (const r of records) {
      const isMale = (r.gender === 'NAM');
      const isFemale = (r.gender === 'N·ªÆ');
      const isOld = r.frequency > threshold;

      if (isOld) {
        if (isMale) oldMale++;
        else if (isFemale) oldFemale++;
        else oldUnknown++;
      } else {
        if (isMale) newMale++;
        else if (isFemale) newFemale++;
        else newUnknown++;
      }
    }

    // Calculate percentages
    const pct = (count, total) => total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';

    console.log('[Analytics Debug]', {
      total,
      maleCount,
      femaleCount,
      unknownCount,
      oldCount,
      newCount,
      oldMale,
      oldFemale,
      oldUnknown,
      newMale,
      newFemale,
      newUnknown,
      records: records.map(r => ({ wfm: r.wfm_code, gender: r.gender, freq: r.frequency }))
    });

    // Calculate percentages based on normalized gender only (exclude unknown)
    const genderNormalized = maleCount + femaleCount;
    const oldNormalized = oldMale + oldFemale;
    const newNormalized = newMale + newFemale;

    return {
      total,
      male: { count: maleCount, pct: pct(maleCount, genderNormalized) },
      female: { count: femaleCount, pct: pct(femaleCount, genderNormalized) },
      old: { count: oldCount, pct: pct(oldCount, total) },
      new: { count: newCount, pct: pct(newCount, total) },
      oldMale: { count: oldMale, pct: pct(oldMale, oldNormalized) },
      oldFemale: { count: oldFemale, pct: pct(oldFemale, oldNormalized) },
      newMale: { count: newMale, pct: pct(newMale, newNormalized) },
      newFemale: { count: newFemale, pct: pct(newFemale, newNormalized) }
    };
  }

  // Analytics charts
  // Analytics charts - only 2 charts now
  const ANALYZE_CHARTS = {
    gender: null,
    usertypeGender: null
  };

  function destroyAnalyzeCharts() {
    if (ANALYZE_CHARTS.gender) { ANALYZE_CHARTS.gender.destroy(); ANALYZE_CHARTS.gender = null; }
    if (ANALYZE_CHARTS.usertypeGender) { ANALYZE_CHARTS.usertypeGender.destroy(); ANALYZE_CHARTS.usertypeGender = null; }
  }

  function renderAnalyzeStats(stats){
    if (!stats) return;

    // Show content, hide loading
    el('analyze-loading')?.classList.add('is-hidden');
    el('analyze-content')?.classList.remove('is-hidden');

    // Update threshold display
    const threshold = el('analyze-threshold')?.value || '3';
    const thresholdDisplay = el('analyze-threshold-display');
    if (thresholdDisplay) {
      thresholdDisplay.textContent = threshold;
    }

    // Destroy old charts
    destroyAnalyzeCharts();

    // Gender stats
    el('analyze-male-count').textContent = stats.male.count;
    el('analyze-male-pct').textContent = stats.male.pct + '%';
    el('analyze-female-count').textContent = stats.female.count;
    el('analyze-female-pct').textContent = stats.female.pct + '%';

    // User type stats
    el('analyze-old-count').textContent = stats.old.count;
    el('analyze-old-pct').textContent = stats.old.pct + '%';
    el('analyze-new-count').textContent = stats.new.count;
    el('analyze-new-pct').textContent = stats.new.pct + '%';

    // Combined stats
    el('analyze-old-male').textContent = stats.oldMale.count;
    el('analyze-old-male-pct').textContent = stats.oldMale.pct + '%';
    el('analyze-old-female').textContent = stats.oldFemale.count;
    el('analyze-old-female-pct').textContent = stats.oldFemale.pct + '%';

    el('analyze-new-male').textContent = stats.newMale.count;
    el('analyze-new-male-pct').textContent = stats.newMale.pct + '%';
    el('analyze-new-female').textContent = stats.newFemale.count;
    el('analyze-new-female-pct').textContent = stats.newFemale.pct + '%';

    // Render charts
    if (typeof Chart !== 'undefined') {
      // Chart 1: Overall Gender Distribution (Pie)
      const ctxGender = el('chart-gender')?.getContext('2d');
      if (ctxGender) {
        ANALYZE_CHARTS.gender = new Chart(ctxGender, {
          type: 'pie',
          data: {
            labels: ['Nam', 'N·ªØ'],
            datasets: [{
              data: [stats.male.count, stats.female.count],
              backgroundColor: ['#36A2EB', '#FF6384'],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            rotation: -90,
            circumference: 360,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const pct = stats.total > 0 ? ((value / stats.total) * 100).toFixed(1) : '0.0';
                    return `${label}: ${value} (${pct}%)`;
                  }
                }
              }
            }
          }
        });
      }

      // Chart 2: User Type with Gender Breakdown (Stacked Bar)
      const ctxUsertypeGender = el('chart-usertype-gender')?.getContext('2d');
      if (ctxUsertypeGender) {
        ANALYZE_CHARTS.usertypeGender = new Chart(ctxUsertypeGender, {
          type: 'bar',
          data: {
            labels: ['User C≈©', 'User M·ªõi'],
            datasets: [
              {
                label: 'Nam',
                data: [stats.oldMale.count, stats.newMale.count],
                backgroundColor: '#36A2EB',
                borderWidth: 1,
                borderColor: '#fff'
              },
              {
                label: 'N·ªØ',
                data: [stats.oldFemale.count, stats.newFemale.count],
                backgroundColor: '#FF6384',
                borderWidth: 1,
                borderColor: '#fff'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              x: {
                stacked: true,
                grid: { display: false }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 15 }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y || 0;
                    const datasetIndex = context.datasetIndex;
                    const categoryIndex = context.dataIndex;

                    // Calculate percentage within the category
                    let total = 0;
                    context.chart.data.datasets.forEach((dataset) => {
                      total += dataset.data[categoryIndex] || 0;
                    });

                    const pct = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                    return `${label}: ${value} (${pct}%)`;
                  },
                  footer: function(tooltipItems) {
                    const categoryIndex = tooltipItems[0].dataIndex;
                    let total = 0;
                    tooltipItems[0].chart.data.datasets.forEach((dataset) => {
                      total += dataset.data[categoryIndex] || 0;
                    });
                    return `T·ªïng: ${total}`;
                  }
                }
              }
            }
          }
        });
      }
    }
  }

  async function loadAnalytics(){
    try {
      setBusy(true);
      el('analyze-loading')?.classList.remove('is-hidden');
      el('analyze-content')?.classList.add('is-hidden');

      // Get current day data
      const wh = el('warehouse')?.value || 'VNDB';
      const dp = el('dayPicker');
      const day = (dp?.value && /^\d{4}-\d{2}-\d{2}$/.test(dp.value)) ? dp.value : todayKey();

      const currentData = await fetchRTDBAll(wh, day);
      ANALYZE.currentData = currentData;

      // Fetch all historical data
      const allData = await fetchAllVNDBData();
      ANALYZE.allData = allData;

      // Count S-code frequencies
      const frequencies = countSCodeFrequencies(allData);

      // Get threshold from input
      const threshold = parseInt(el('analyze-threshold')?.value || '3', 10);

      // Analyze current day data
      const stats = analyzeData(currentData, frequencies, threshold);
      ANALYZE.stats = stats;

      // Render
      renderAnalyzeStats(stats);

      notice('Ph√¢n t√≠ch ho√†n t·∫•t!', 'success', 3000);
    } catch (e) {
      console.error('[loadAnalytics]', e);
      notice('L·ªói khi t·∫£i d·ªØ li·ªáu ph√¢n t√≠ch: ' + (e.message || e), 'error', 5000);
      playSysErr();
    } finally {
      setBusy(false);
    }
  }

  async function callWms(path, payload){
    const url = `${CONFIG.API_BASE}${path}`;
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });
    const text = await r.text();
    let data={}; try{ data=JSON.parse(text);}catch{}
    if(!r.ok){
      console.error("[callWms]", url, {payload, status:r.status, text});
      const serverMsg=(data&&(data.message||data.error))||text.slice(0,300);
      throw new Error(`HTTP ${r.status} ‚Äì ${serverMsg}`);
    }
    if(typeof data.retcode!=="undefined" && data.retcode!==0){
      console.error("[callWms-retcode]", data);
      throw new Error(`retcode=${data.retcode} ‚Äì ${(data.message||"")}`);
    }
    return data;
  }

  async function fetchStaffFromVNDB(vendorCodeInput) {
    // L·∫•y d·ªØ li·ªáu t·ª´ Firebase VNDB database
    // Input c√≥ th·ªÉ l√†:
    //   - Vendor code: SPAGR01355
    //   - URL: https://vanhanh.shopee.vn/spx-ops/wh/SPAGR01355
    // C·∫•u tr√∫c: { vendor_code1: { "birth_year": "...", "fullname": "...", "wfm_code": "..." }, ... }
    const firebaseUrl = "https://data-bpo-default-rtdb.asia-southeast1.firebasedatabase.app/VNDB";

    try {
      // C·∫Øt vendor code t·ª´ input
      const normalized = normalizeVendorOrQR(vendorCodeInput);
      const vendorCode = toVendorCode(normalized);

      if (!vendorCode) throw new Error("Vendor code tr·ªëng");

      const vendorCodeUpper = vendorCode.toUpperCase();
      console.log('[fetchStaffFromVNDB] T√¨m ki·∫øm vendor:', vendorCodeUpper);

      // Fetch to√†n b·ªô VNDB data
      const url = `${firebaseUrl}.json`;
      const r = await fetch(url, { method: "GET", timeout: 15000 });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);

      const vndbData = await r.json();
      if (!vndbData || typeof vndbData !== 'object') {
        throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu trong VNDB");
      }

      // T√¨m vendor_code trong c·∫•u tr√∫c
      // VNDB structure: { "SPAGR01355": { "birth_year": "...", "fullname": "...", "wfm_code": "..." } }
      let staffData = null;

      // Duy·ªát qua t·∫•t c·∫£ keys ƒë·ªÉ t√¨m vendor code (case-insensitive)
      for (const [key, value] of Object.entries(vndbData)) {
        if (key.toUpperCase() === vendorCodeUpper && typeof value === 'object' && value !== null) {
          staffData = value;
          console.log('[fetchStaffFromVNDB] ‚úì T√¨m th·∫•y vendor:', key);
          break;
        }
      }

      if (!staffData) {
        console.warn('[fetchStaffFromVNDB] ‚úó Kh√¥ng t√¨m th·∫•y vendor:', vendorCodeUpper);
        const sampleVendors = Object.keys(vndbData).slice(0, 5);
        console.warn('[fetchStaffFromVNDB] Sample vendors:', sampleVendors);
        throw new Error(`Kh√¥ng t√¨m th·∫•y vendor code "${vendorCode}" trong VNDB`);
      }

      const info = {
        full_name:  staffData.fullname || "",
        contractor: staffData.vendor_name || "",
        gender:     staffData.gender || "",
        birth_year: staffData.birth_year || "",
        staff_id:   vendorCodeUpper, // D√πng vendor code ƒë√£ c·∫Øt
      };

      const staff_no = staffData.wfm_code || "";

      console.log('[fetchStaffFromVNDB] ‚úì Record t√¨m ƒë∆∞·ª£c:', { staff_no, info });

      return { staff_no, info, img_url: "" };
    } catch (e) {
      console.error('[fetchStaffFromVNDB]', e);
      throw new Error(`Firebase VNDB: ${e.message || e}`);
    }
  }  async function fetchStaffFromScanToolByDate(wfmCode, dateStr) {
    // L·∫•y d·ªØ li·ªáu t·ª´ data-scan-tool database
    // C·∫•u tr√∫c: { date: { shift_time: { vendor: { wfm: record } } } }
    // ‚ö†Ô∏è QUAN TR·ªåNG: WFM code ph·∫£i l√† ƒë·ªãnh d·∫°ng S0xxxxx (v√≠ d·ª•: S098480)
    //    KH√îNG ph·∫£i vendor_code (v√≠ d·ª•: SPAGR01225)
    const firebaseUrl = "https://data-scan-tool-default-rtdb.asia-southeast1.firebasedatabase.app/VNDB";

    try {
      // Fetch to√†n b·ªô d·ªØ li·ªáu VNDB
      const url = `${firebaseUrl}.json`;
      const r = await fetch(url, { method: "GET" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);

      const allData = await r.json();
      if (!allData || typeof allData !== 'object') {
        throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu trong data-scan-tool");
      }

      const wfmUpper = wfmCode.toUpperCase();
      console.log('[fetchStaffFromScanToolByDate] T√¨m ki·∫øm WFM:', wfmUpper);

      // Duy·ªát qua t·∫•t c·∫£ dates
      for (const [date, dateData] of Object.entries(allData)) {
        if (!dateData || typeof dateData !== 'object') continue;

        // Duy·ªát qua t·∫•t c·∫£ shifts trong ng√†y
        for (const [shift, shiftData] of Object.entries(dateData)) {
          if (!shiftData || typeof shiftData !== 'object') continue;

          // Duy·ªát qua t·∫•t c·∫£ vendors
          for (const [vendor, staffGroup] of Object.entries(shiftData)) {
            if (!staffGroup || typeof staffGroup !== 'object') continue;

            // Duy·ªát qua t·∫•t c·∫£ WFM codes v√† t√¨m match
            for (const [wfm, record] of Object.entries(staffGroup)) {
              if (wfm.toUpperCase() === wfmUpper && record && typeof record === 'object') {
                console.log('[fetchStaffFromScanToolByDate] ‚úì T√¨m th·∫•y t·∫°i:', { date, shift, vendor, wfm });
                console.log('[fetchStaffFromScanToolByDate] Record:', record);
                return record;
              }
            }
          }
        }
      }

      // N·∫øu kh√¥ng t√¨m th·∫•y, show c√°c WFMs c√≥ s·∫µn ƒë·ªÉ debug
      console.warn('[fetchStaffFromScanToolByDate] ‚úó Kh√¥ng t√¨m th·∫•y WFM:', wfmUpper);

      // L·∫•y m·ªôt s·ªë WFM t·ª´ database ƒë·ªÉ debug
      const debugWfms = [];
      for (const dateData of Object.values(allData).slice(0, 1)) {
        for (const shiftData of Object.values(dateData || {}).slice(0, 1)) {
          for (const staffGroup of Object.values(shiftData || {}).slice(0, 2)) {
            if (staffGroup) {
              debugWfms.push(...Object.keys(staffGroup).slice(0, 3));
            }
          }
        }
      }

      console.warn('[fetchStaffFromScanToolByDate] ‚ö† ƒê·ªãnh d·∫°ng WFM ph·∫£i l√† S0xxxxx (v√≠ d·ª•: S098480)');
      console.warn('[fetchStaffFromScanToolByDate] Sample WFMs t·ª´ DB:', debugWfms);

      throw new Error(`Kh√¥ng t√¨m th·∫•y WFM code "${wfmCode}" trong data-scan-tool. S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng S0xxxxx (v√≠ d·ª•: S098480)`);
    } catch (e) {
      console.error('[fetchStaffFromScanToolByDate]', e);
      throw new Error(`Data-scan-tool: ${e.message || e}`);
    }
  }  async function fetchStaffByVendor(vendorCodeInput) {
    // Cho ph√©p nh·∫≠p SP******** ho·∫∑c URL
    const normalized = normalizeVendorOrQR(vendorCodeInput);
    const vendorCode = toVendorCode(normalized);
    if (!vendorCode) throw new Error("Vendor code tr·ªëng");

    const url = `${window.API_BASE || ""}/wms/info/${encodeURIComponent(vendorCode)}`;
    const r = await fetch(url, { method: "GET" });
    let j = {};
    try { j = await r.json(); } catch { j = {}; }

    // ‚ùó Ch·ªâ throw khi HTTP l·ªói. KH√îNG throw khi j.ok === false
    if (!r.ok) throw new Error(`HTTP ${r.status}`);

    // L·∫•y info d√π j.ok false (ƒë·ªÉ hi·ªÉn th·ªã s·ªõm)
    const base = j.all_info || {};
    const info = {
      full_name:  j.full_name  ?? base.full_name  ?? "",
      contractor: j.contractor ?? base.contractor ?? "",
      gender:     j.gender     ?? base.gender     ?? "",
      birth_year: j.birth_year ?? base.birth_year ?? "",
      staff_id:   j.staff_id   ?? base.staff_id   ?? "",
    };

    // wfm c√≥ th·ªÉ n·∫±m ·ªü nhi·ªÅu key kh√°c nhau (t√πy trang/parser)
    const staff_no =
      j.wfm || j.vac_number || j.vacc_number || base.wfm || base.vac_number || base.vacc_number || "";

    const img_url = j.profile_image_url || base.profile_image_url || "";

    return { staff_no, info, img_url };
  }


  async function parseQR(inputCode){
    const code = (inputCode || "").trim();
    if (!code) throw new Error("M√£ tr·ªëng");

    // N·∫øu ng∆∞·ªùi d√πng nh·∫≠p tr·ª±c ti·∫øp m√£ WFM (S + 6 s·ªë)
    // T·ª± ƒë·ªông t√¨m ki·∫øm th√¥ng tin t·ª´ Firebase VNDB
    if (WFM_RE.test(code)) {
      const wfmUpper = code.toUpperCase();
      console.log('[parseQR] Nh·∫≠p m√£ WFM tr·ª±c ti·∫øp:', wfmUpper);

      try {
        // T√¨m ki·∫øm trong Firebase VNDB b·∫±ng WFM code
        const firebaseUrl = "https://data-bpo-default-rtdb.asia-southeast1.firebasedatabase.app/VNDB";
        const url = `${firebaseUrl}.json`;
        const r = await fetch(url, { method: "GET", timeout: 15000 });

        if (!r.ok) throw new Error(`HTTP ${r.status}`);

        const vndbData = await r.json();
        if (!vndbData || typeof vndbData !== 'object') {
          throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu trong VNDB");
        }

        // T√¨m record c√≥ wfm_code kh·ªõp
        let foundRecord = null;
        let foundVendorCode = "";

        for (const [vendorCode, record] of Object.entries(vndbData)) {
          if (record && typeof record === 'object' &&
              record.wfm_code &&
              record.wfm_code.toUpperCase() === wfmUpper) {
            foundRecord = record;
            foundVendorCode = vendorCode;
            console.log('[parseQR] ‚úì T√¨m th·∫•y th√¥ng tin WFM trong VNDB:', vendorCode);
            break;
          }
        }

        if (foundRecord) {
          // T√¨m th·∫•y - tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß th√¥ng tin
          return {
            staff_no: wfmUpper,
            info: {
              full_name:  foundRecord.fullname || "",
              contractor: foundRecord.vendor_name || "",
              gender:     foundRecord.gender || "",
              birth_year: foundRecord.birth_year || "",
              staff_id:   foundVendorCode
            },
            img_url: ""
          };
        } else {
          // Kh√¥ng t√¨m th·∫•y - tr·∫£ v·ªÅ c·∫•u tr√∫c t·ªëi thi·ªÉu
          console.warn('[parseQR] ‚ö† Kh√¥ng t√¨m th·∫•y WFM trong VNDB, d√πng c·∫•u tr√∫c t·ªëi thi·ªÉu');
          return {
            staff_no: wfmUpper,
            info: {
              full_name:  "",
              contractor: "",
              gender:     "",
              birth_year: "",
              staff_id:   ""
            },
            img_url: ""
          };
        }
      } catch (e) {
        console.error('[parseQR] L·ªói t√¨m ki·∫øm Firebase:', e);
        // Fallback v·ªÅ c·∫•u tr√∫c t·ªëi thi·ªÉu n·∫øu c√≥ l·ªói
        return {
          staff_no: wfmUpper,
          info: {
            full_name:  "",
            contractor: "",
            gender:     "",
            birth_year: "",
            staff_id:   ""
          },
          img_url: ""
        };
      }
    }

    // Ki·ªÉm tra ch·∫ø ƒë·ªô hi·ªán t·∫°i
    const scanMode = el("scanMode")?.value || "vanhanh";

    // C√≤n l·∫°i coi nh∆∞ QR / vendor, d√πng mode ƒë∆∞·ª£c ch·ªçn
    try {
      let data;

      if (scanMode === "firebase") {
        // Mode Firebase: l·∫•y t·ª´ VNDB database
        data = await fetchStaffFromVNDB(code);
      } else {
        // Mode Vanhanh: l·∫•y t·ª´ API nh∆∞ c≈©
        data = await fetchStaffByVendor(code);
      }

      window.currentStaff = data;

      // ‚ùå KH√îNG cho ph√©p scan n·∫øu kh√¥ng c√≥ staff_no (WFM code)
      if (!data.staff_no || !data.staff_no.trim()) {
        throw new Error("Kh√¥ng t√¨m th·∫•y WFM code t·ª´ vendor. Vui l√≤ng ki·ªÉm tra l·∫°i m√£.");
      }

      return data;
    } catch (e) {
      // Kh√¥ng fallback v·ªÅ code n·ªØa - throw error ra ngo√†i
      throw e;
    }
  }

  /* ====================== DATA (RTDB helpers) ====================== */
  const rtdbDayPath = (wh, day=todayKey()) => `${window.__firebaseDB.databaseURL}/${wh}/${day}.json`;
  const rtdbRecPath = (wh, day, shift, vendor, wfm) =>
    `${window.__firebaseDB.databaseURL}/${wh}/${day}/${encodeURIComponent(shift)}/${encodeURIComponent(vendor)}/${encodeURIComponent(wfm)}.json`;

  async function fetchRTDBAll(wh, day=todayKey()){
    const r = await fetch(rtdbDayPath(wh, day));
    return (await r.json()) || {};
  }

  function flattenRecords(records){
    const flat=[];
    for(const [shift, group] of Object.entries(records||{})){
      for(const [vendor_name, staff_group] of Object.entries(group||{})){
        for(const [wfm, info] of Object.entries(staff_group||{})){
          flat.push({...info, shift, vendor_name, wfm_code:wfm});
        }
      }
    }
    return flat;
  }

  function computeCounts(raw){
    let total_in=0, total_out=0;
    for(const group of Object.values(raw||{})){
      for(const staff_group of Object.values(group||{})){
        const arr=Object.values(staff_group||{});
        total_in += arr.length;
        for(const s of arr){ if(s.gsheet_time_out || s.type==="done") total_out++; }
      }
    }
    return {total_in, total_out, raw};
  }

  function computeTaskFromRaw(raw){
    const byShift={}; let break60=0, break30=0;
    for (const [shift, vendors] of Object.entries(raw||{})){
      const S=(byShift[shift] ||= { totalIn:0, b60:0, b30:0 });
      for (const staffGroup of Object.values(vendors||{})){
        for (const s of Object.values(staffGroup||{})){
          if(!s) continue;
          const is60=!!s.break_60 && !s.break_60_in;
          const is30=!!s.break_30 && !s.break_30_in;
          S.totalIn++;
          if(is60){ S.b60++; break60++; }
          if(is30){ S.b30++; break30++; }
        }
      }
    }
    return { byShift, break60, break30 };
  }

  /* ====================== UI ====================== */
  function setActiveTab(name){
    $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    const want='tab-'+name;
    $$('.tab-panel').forEach(p=>p.classList.toggle('is-hidden', p.id!==want));
  }

  function setPersonUI(prefix, info, img){
    el(`${prefix}-fullname`).textContent    =(info.full_name||"").toUpperCase();
    el(`${prefix}-vendor`).textContent      =(info.contractor||"").toUpperCase();
    el(`${prefix}-vendor-code`).textContent =(info.staff_id||"").toUpperCase();
    el(`${prefix}-gender`).textContent      =(info.gender||"").toUpperCase();
    el(`${prefix}-birth`).textContent       =(info.birth_year||"");
    const imgEl = el(`${prefix}-avatar`);
    if (imgEl) imgEl.src = img || "";
  }

  // Update UI t·ª´ Firebase record (sau scan in, khi l·∫•y l·∫°i t·ª´ RTDB)
  function setPersonUIFromRecord(prefix, rec) {
    if (!rec) return;
    el(`${prefix}-fullname`).textContent    =(rec.fullname||"").toUpperCase();
    el(`${prefix}-vendor`).textContent      =(rec.vendor_name||"").toUpperCase();
    el(`${prefix}-vendor-code`).textContent =(rec.vendor_code||"").toUpperCase();
    el(`${prefix}-gender`).textContent      =(rec.gender||"").toUpperCase();
    el(`${prefix}-birth`).textContent       =(rec.birth_year||"");
    // Avatar kh√¥ng c√≥ trong record, n√™n kh√¥ng update
  }

  function renderInCounters(stats){
    const raw = stats.raw || {};
    el("in-total").textContent = `Total Scan In: ${stats.total_in || 0}`;

    // Helper: map vendor name to canonical columns
    const canonVendors = ["Agari", "MBB", "GRG", "HTVN", "Other"];
    const toCanon = (name) => {
      const s = String(name || "").toUpperCase();
      if (s.includes("AGARI")) return "Agari";
      if (s.includes("MBB"))   return "MBB";
      // Handle bOther GRG and GRGR
      if (s.includes("GRGR") || s === "GRG" || s.includes(" GRG")) return "GRG";
      if (s.includes("HTVN"))  return "HTVN";
      // All other vendors go to "Other" category
      return "Other";
    };

    // Build per-shift rows
    const shifts = Object.keys(raw).sort((a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true}));
    const rows = [];
    let grand = { Agari:0, MBB:0, GRG:0, HTVN:0, Other:0 };

    for (const sh of shifts) {
      const group = raw[sh] || {};
      const counts = { Agari:0, MBB:0, GRG:0, HTVN:0, Other:0 };
      for (const [vn, sg] of Object.entries(group)) {
        const canon = toCanon(vn);
        counts[canon] += Object.keys(sg || {}).length;
      }
      grand.Agari += counts.Agari;
      grand.MBB   += counts.MBB;
      grand.GRG   += counts.GRG;
      grand.HTVN  += counts.HTVN;
      grand.Other += counts.Other;
      const total = counts.Agari + counts.MBB + counts.GRG + counts.HTVN + counts.Other;
      rows.push([sh, counts.Agari, counts.MBB, counts.GRG, counts.HTVN, counts.Other, total]);
    }

    // Render grid table into #in-shifts
    // Display label tweak: show 'GRGR' instead of 'GRG' without changing logic keys
    const hdr = ["Ca", ...canonVendors.map(v => v === "GRG" ? "GRGR" : v), "Total"]; // 6 columns
  const thead = `<thead><tr>${hdr.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
  const fmt0 = (v) => (Number(v) === 0 ? "-" : v);
  const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=> {
    if(i===0) return `<td>${c}</td>`;
    // C·ªôt Total (c·ªôt cu·ªëi) c√≥ m√†u xanh
    if(i===r.length-1) return `<td style=\"text-align:center;color:#28a745;font-weight:bold\">${fmt0(c)}</td>`;
    return `<td style=\"text-align:center\">${fmt0(c)}</td>`;
  }).join("")}</tr>`).join("")}</tbody>`;
  const gTotal = grand.Agari + grand.MBB + grand.GRG + grand.HTVN + grand.Other;
  // Grand Total row c√≥ n·ªÅn ƒë·ªè, ch·ªØ tr·∫Øng
  const tfoot = `<tfoot><tr style=\"color:blue\"><th>Grand Total</th><th style=\"text-align:center\">${fmt0(grand.Agari)}</th><th style=\"text-align:center\">${fmt0(grand.MBB)}</th><th style=\"text-align:center\">${fmt0(grand.GRG)}</th><th style=\"text-align:center\">${fmt0(grand.HTVN)}</th><th style=\"text-align:center\">${fmt0(grand.Other)}</th><th style=\"text-align:center;font-weight:bold\">${fmt0(gTotal)}</th></tr></tfoot>`;
    const tableHtml = `<table class="table">${thead}${tbody}${tfoot}</table>`;
    el("in-shifts").innerHTML = tableHtml;

    // Clear old overall vendor stats under the grid (redundant now)
    const overall = el("in-vendor-stats");
    if (overall) { overall.innerHTML = ""; }
  }

  function renderOutCounters(stats){
    const raw = stats.raw || {};

    // Canonical vendor mapping to align with In grid
    const canonVendors = ["Agari", "MBB", "GRG", "HTVN", "Other"];
    const toCanon = (name) => {
      const s = String(name || "").toUpperCase();
      if (s.includes("AGARI")) return "Agari";
      if (s.includes("MBB"))   return "MBB";
      if (s.includes("GRG") || s === "GRG" || s.includes(" GRG")) return "GRG";
      if (s.includes("HTVN"))  return "HTVN";
      // All other vendors go to "Other" category
      return "Other";
    };

    const shifts = Object.keys(raw).sort((a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true}));
    const rows = [];
    let grand = { Agari:{in:0,out:0}, MBB:{in:0,out:0}, GRG:{in:0,out:0}, HTVN:{in:0,out:0}, Other:{in:0,out:0} };
    let totIn=0, totOut=0;

    for(const sh of shifts){
      const group = raw[sh] || {};
      const counts = { Agari:{in:0,out:0}, MBB:{in:0,out:0}, GRG:{in:0,out:0}, HTVN:{in:0,out:0}, Other:{in:0,out:0} };
      for(const [vn, sg] of Object.entries(group)){
        const canon = toCanon(vn);
        const staff = Object.values(sg || {});
        const inN   = staff.length;
        const outN  = staff.filter(s => s && (s.gsheet_time_out || s.type === "done")).length;
        counts[canon].in  += inN;
        counts[canon].out += outN;
      }
      grand.Agari.in += counts.Agari.in; grand.Agari.out += counts.Agari.out;
      grand.MBB.in   += counts.MBB.in;   grand.MBB.out   += counts.MBB.out;
      grand.GRG.in   += counts.GRG.in;   grand.GRG.out   += counts.GRG.out;
      grand.HTVN.in  += counts.HTVN.in;  grand.HTVN.out  += counts.HTVN.out;
      grand.Other.in += counts.Other.in; grand.Other.out += counts.Other.out;

      const rowVendorCells = canonVendors.map(v => {
        const c = counts[v] || { in: 0, out: 0 };
        return `${c.out}/${c.in}`;
      });
      const inSum  = counts.Agari.in + counts.MBB.in + counts.GRG.in + counts.HTVN.in + counts.Other.in;
      const outSum = counts.Agari.out + counts.MBB.out + counts.GRG.out + counts.HTVN.out + counts.Other.out;
      totIn += inSum; totOut += outSum;
      rows.push([sh, ...rowVendorCells, `${outSum}/${inSum}`]);
    }

  // Render grid table for Out: each cell is out/in
  // Display label tweak: show 'GRGR' instead of 'GRG' without changing logic keys
  const hdr = ["Ca", ...canonVendors.map(v => v === "GRG" ? "GRGR" : v), "Total"]; // 6 columns
    const thead = `<thead><tr>${hdr.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
    const fmtPair = (a,b) => ((a===0 && b===0) ? "-" : `${a}/${b}`);
    const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=> {
      if(i===0) return `<td>${c}</td>`;
      const parts = String(c).split('/').map(x=>Number(x)||0);
      // C·ªôt Total (c·ªôt cu·ªëi) c√≥ m√†u xanh
      if(i===r.length-1) return `<td style=\"text-align:center;color:#28a745;font-weight:bold\">${fmtPair(parts[0], parts[1])}</td>`;
      return `<td style=\"text-align:center\">${fmtPair(parts[0], parts[1])}</td>`;
    }).join("")}</tr>`).join("")}</tbody>`;
    const gIn  = grand.Agari.in + grand.MBB.in + grand.GRG.in + grand.HTVN.in + grand.Other.in;
    const gOut = grand.Agari.out + grand.MBB.out + grand.GRG.out + grand.HTVN.out + grand.Other.out;
  // Grand Total row c√≥ n·ªÅn ƒë·ªè, ch·ªØ tr·∫Øng
  const tfoot = `<tfoot><tr style=\"color:blue\"><th>Grand Total</th><th style=\"text-align:center\">${fmtPair(grand.Agari?.out||0,grand.Agari?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.MBB?.out||0,grand.MBB?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.GRG?.out||0,grand.GRG?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.HTVN?.out||0,grand.HTVN?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.Other?.out||0,grand.Other?.in||0)}</th><th style=\"text-align:center;font-weight:bold\">${fmtPair(gOut,gIn)}</th></tr></tfoot>`;
    const tableHtml = `<table class=\"table\">${thead}${tbody}${tfoot}</table>`;
    el("out-shifts").innerHTML = tableHtml;
    el("out-total").textContent = `Total Scan Out: ${totOut} / ${totIn}`;

    const overall = el("out-vendor-stats");
    if (overall) { overall.innerHTML = ""; }
  }

  // Dashboard
  const DASH = { rows:[], filtered:[], page:1, pageSize:50, filters:{} };

  function normalizeDashRow(r){
    // Helper to safely convert to string and handle undefined/null
    const safe = (val, def = "") => {
      if (val === undefined || val === null || val === "undefined" || val === "null") return def;
      const s = String(val).trim();
      return s === "" ? def : s;
    };

    return {
      vendor_name:     safe(r.vendor_name),
      vendor_code:     safe(r.vendor_code || r.vendorCode || r.vendor_id).toUpperCase(),
      wfm_code:        safe(r.wfm_code),
      wms_user_id:     safe(r.wms_user_id),
      operator:        safe(r.operator).toUpperCase(),
      fullname:        safe(r.fullname || r.full_name).toUpperCase(),
      gender:          normalizeGender(r.gender) || safe(r.gender).toUpperCase().normalize("NFC"), // Normalize gender
      shift_in:        safe(r.shift_in || r.shift),
      shift_out:       safe(r.shift_out),
      birth_year:      safe(r.birth_year),
      gsheet_time_in:  safe(r.gsheet_time_in),
      break_60:        safe(r.break_60),
      break_60_in:     safe(r.break_60_in),
      break_30:        safe(r.break_30),
      break_30_in:     safe(r.break_30_in),
      gsheet_time_out: safe(r.gsheet_time_out)
    };
  }

  function renderDashboardList(raw){
    const flat=flattenRecords(raw);
    // Sort by shift first, then by gsheet_time_in (newest first within each shift)
    const num = (s)=>{
      const t = Date.parse(s || "");
      return Number.isFinite(t) ? t : 0;
    };
    const parseShift = (s)=>{
      const m = String(s||"").match(/(\d+):(\d+)/);
      return m ? parseInt(m[1])*60 + parseInt(m[2]) : 0;
    };
    flat.sort((a,b)=> {
      const shiftA = parseShift(a.shift_in);
      const shiftB = parseShift(b.shift_in);
      if(shiftA !== shiftB) return shiftA - shiftB;
      return num(b.gsheet_time_in) - num(a.gsheet_time_in);
    });
    DASH.rows = flat.map(normalizeDashRow);
    DASH.page = 1;
    applyDashFiltersAndRender();
  }

  function applyDashFiltersAndRender(){
    const fs=DASH.filters||{};
    const q=v=>String(v||"").toLowerCase();
    DASH.filtered = DASH.rows.filter(row=>{
      for(const [k,val] of Object.entries(fs)){
        if(!val) continue;
        if(!q(row[k]).includes(q(val))) return false;
      }
      return true;
    });
    renderDashTable();
  }

  function renderDashTable(){
    const body=el("tbody-dash"); if(!body) return;
    body.innerHTML="";
    const total=DASH.filtered.length, ps=DASH.pageSize||50;
    const maxPage=Math.max(1, Math.ceil(total/ps));
    if(DASH.page>maxPage) DASH.page=maxPage;
    const start=(DASH.page-1)*ps, end=Math.min(start+ps,total);
    const slice=DASH.filtered.slice(start,end);
    const isEditMode = document.body.dataset.editMode === "1";

    for(let i=0;i<slice.length;i++){
      const r=slice[i];
      const stt=start+i+1;
      const globalIdx = start+i;
      const tr=document.createElement("tr");

      // Always render as text, but add editable attributes when edit mode is on
      const editableClass = isEditMode ? 'editable' : '';
      const cells = [
        { cls: '', value: stt, field: null },
        { cls: editableClass, value: r.vendor_name, field: 'vendor_name' },
        { cls: editableClass, value: r.vendor_code, field: 'vendor_code' },
        { cls: '', value: r.wfm_code, field: null }, // WFM not editable
        { cls: editableClass, value: r.wms_user_id, field: 'wms_user_id' },
        { cls: `tbl-col-fullname ${editableClass}`, value: r.fullname, field: 'fullname' },
        { cls: `tbl-col-gender ${editableClass}`, value: r.gender, field: 'gender' },
        { cls: editableClass, value: r.birth_year, field: 'birth_year' },
        { cls: editableClass, value: r.shift_in, field: 'shift_in' },
        { cls: editableClass, value: r.break_60, field: 'break_60' },
        { cls: editableClass, value: r.break_60_in, field: 'break_60_in' },
        { cls: editableClass, value: r.break_30, field: 'break_30' },
        { cls: editableClass, value: r.break_30_in, field: 'break_30_in' },
        { cls: editableClass, value: r.shift_out, field: 'shift_out' }
      ];

      tr.innerHTML = cells.map(c => {
        const dataAttrs = c.field ? `data-idx="${globalIdx}" data-field="${c.field}"` : '';
        return `<td class="${c.cls}" ${dataAttrs}>${c.value ?? ""}</td>`;
      }).join("");

      body.appendChild(tr);
    }

    const info=el("dash-info"); if(info) info.textContent=`Trang ${DASH.page} / ${maxPage} ‚Äî ${total} k·∫øt qu·∫£`;
    const jump=el("dash-jump"); if(jump) jump.value=DASH.page;
    const prev=el("dash-prev"), next=el("dash-next");
    if(total<=ps){
      prev && (prev.disabled=true);
      next && (next.disabled=true);
      DASH.page=1;
      if(jump) jump.value=1;
    }else{
      prev && (prev.disabled = (DASH.page<=1));
      next && (next.disabled = (DASH.page>=maxPage));
    }
  }

  function renderTaskRightCards(raw){
    const s = computeTaskStats(raw);

    // Update headers
    const h60 = el('task60-card')?.querySelector('h3');
    const h30 = el('task30-card')?.querySelector('h3');
    if (h60) h60.textContent = `Ngh·ªâ Tr∆∞a: ${s.total_b60} / V√†o Ca: ${s.total_b60_in} / Total: ${s.total_in}`;
    if (h30) h30.textContent = `Ngh·ªâ OT: ${s.total_b30} / V√†o Ca: ${s.total_b30_in} / Total: ${s.total_in}`;

    // Hide legacy blocks
    el('task60-total')?.classList.add('is-hidden');
    el('task30-total')?.classList.add('is-hidden');

    // Canonical vendor mapping
    const canonVendors = ["Agari", "MBB", "GRG", "HTVN", "Other"];
    const toCanon = (name) => {
      const s = String(name || "").toUpperCase();
      if (s.includes("AGARI")) return "Agari";
      if (s.includes("MBB"))   return "MBB";
      if (s.includes("GRG") || s === "GRG" || s.includes(" GRG")) return "GRG";
      if (s.includes("HTVN"))  return "HTVN";
      if (s === "Other")       return "Other";
      return null;
    };

    const shifts = Object.keys(raw || {}).sort((a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true}));

    // Build tables for 60' and 30'
    function buildTable(kind){
      // kind: '60' or '30'
      const rows = [];
      const grand = { Agari:{a:0,b:0,in:0}, MBB:{a:0,b:0,in:0}, GRG:{a:0,b:0,in:0}, HTVN:{a:0,b:0,in:0}, Other:{a:0,b:0,in:0} };
      for (const sh of shifts){
        const group = raw[sh] || {};
        const counts = { Agari:{a:0,b:0,in:0}, MBB:{a:0,b:0,in:0}, GRG:{a:0,b:0,in:0}, HTVN:{a:0,b:0,in:0}, Other:{a:0,b:0,in:0} };
        for (const [vn, sg] of Object.entries(group)){
          const canon = toCanon(vn); if(!canon) continue;
          const staff = Object.values(sg || {});
          // a = total break opened, b = total returned, in = total scan in of that vendor/shift
          let a=0, b=0, inN=0;
          inN = staff.length;
          if (kind === '60') {
            a = staff.filter(s => !!(s && s.break_60)).length;
            b = staff.filter(s => !!(s && s.break_60_in)).length;
          } else {
            a = staff.filter(s => !!(s && s.break_30)).length;
            b = staff.filter(s => !!(s && s.break_30_in)).length;
          }
          counts[canon].a  += a; counts[canon].b  += b; counts[canon].in += inN;
        }
        // accumulate grand totals
        for (const v of canonVendors){ grand[v].a += counts[v].a; grand[v].b += counts[v].b; grand[v].in += counts[v].in; }
        const sumA  = canonVendors.reduce((t,v)=> t + counts[v].a , 0);
        const sumB  = canonVendors.reduce((t,v)=> t + counts[v].b , 0);
        const sumIn = canonVendors.reduce((t,v)=> t + counts[v].in, 0);
        // cell text order: ngh·ªâ/vao/scan-in
        rows.push([sh, ...canonVendors.map(v => `${counts[v].a}/${counts[v].b}/${counts[v].in}`), `${sumA}/${sumB}/${sumIn}`]);
      }

  // Display label tweak: show 'GRGR' instead of 'GRG' without changing logic keys
  const hdr = ["Ca", ...canonVendors.map(v => v === "GRG" ? "GRGR" : v), "Total"];
      const thead = `<thead><tr>${hdr.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
      const fmtTriple = (a,b,iN) => ((a===0 && b===0 && iN===0) ? '-' : `${a}/${b}/${iN}`);
      const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=> {
        if(i===0) return `<td>${c}</td>`;
        const parts = String(c).split('/').map(x=>Number(x)||0);
        // C·ªôt Total (c·ªôt cu·ªëi) c√≥ m√†u xanh
        if(i===r.length-1) return `<td style=\"text-align:center;color:#28a745;font-weight:bold\">${fmtTriple(parts[0], parts[1], parts[2]||0)}</td>`;
        return `<td style=\"text-align:center\">${fmtTriple(parts[0], parts[1], parts[2]||0)}</td>`;
      }).join('')}</tr>`).join('')}</tbody>`;
      const gA  = canonVendors.reduce((t,v)=> t + grand[v].a , 0);
      const gB  = canonVendors.reduce((t,v)=> t + grand[v].b , 0);
      const gIn = canonVendors.reduce((t,v)=> t + grand[v].in, 0);
      // Grand Total row c√≥ n·ªÅn ƒë·ªè, ch·ªØ tr·∫Øng
      const tfoot = `<tfoot><tr style=\"color:blue\"><th>Grand Total</th>${canonVendors.map(v=>`<th style=\"text-align:center\">${fmtTriple(grand[v].a,grand[v].b,grand[v].in)}</th>`).join('')}<th style=\"text-align:center;font-weight:bold\">${fmtTriple(gA,gB,gIn)}</th></tr></tfoot>`;
      return `<table class=\"table\">${thead}${tbody}${tfoot}</table>`;
    }

    const s60 = el('task60-shifts');
    const s30 = el('task30-shifts');
    if (s60) s60.innerHTML = buildTable('60');
    if (s30) s30.innerHTML = buildTable('30');
  }

  /* ====================== CONTROLLERS ====================== */
  async function doScan(direction){
  const wh = el("warehouse").value;
  const hh = String(+el("hour").value).padStart(2,"0");
  const mm = el("minute").value === "30" ? "30" : "00";
  const shiftTime = `${hh}:${mm}`;

  if (direction === "in") {
    el("in-operator").textContent = "?";
    el("in-wmsid").textContent = "?";
    const wfmText = el("in-wfm").value.trim();

    if (!wfmText){
      notice("Vui l√≤ng scan QR, ho·∫∑c nh·∫≠p m√£ Vendor (SP********) / WFM.", "error");
      playSysErr();
      return;
    }
    setBusy(true);

    try{
      setAllDisabled(true);

      const { staff_no, info, img_url } = await parseQR(wfmText);

      // Hi·ªÉn th·ªã ngay sau parse
      setPersonUI("in", info, img_url ? await imgFromUrl(img_url) : "");

      // Kh√¥ng c√≥ staff_no th√¨ d·ª´ng (kh√¥ng n√©m l·ªói ƒë·ªÉ UI gi·ªØ th√¥ng tin)
      if (!staff_no){
        notice("Kh√¥ng l·∫•y ƒë∆∞·ª£c WFM t·ª´ vendor. Vui l√≤ng ki·ªÉm tra m√£/QR ho·∫∑c th·ª≠ l·∫°i.", "error", 5000);
        playSysErr();
        return;
      }

      // ‚õî Ch·∫∑n Scan In tr√πng theo key (shift_in ƒë√£ c√≥ gi√° tr·ªã)
      {
        const raw  = await fetchRTDBAll(wh, todayKey());
        const flat = flattenRecords(raw);
        const rec  = findTodayRec(flat, staff_no);
        const msg  = checkDuplicateByKeys(rec, "in");
        if (msg){
          notice(msg, "error", 5000);
          playSysErr();
          return;
        }
      }

      // Optional QA verification: don't mark scanned unless QA API confirms
      // ‚ö†Ô∏è B·ªè qua QA check khi ·ªü ch·∫ø ƒë·ªô Firebase (vanhanh API kh√¥ng t·ªìn t·∫°i)
      const scanMode = el("scanMode")?.value || "vanhanh";
      if (CONFIG.ENABLE_QA_CHECK && scanMode !== "firebase") {
        try {
          const qa = await callWms('/wms/verify_scan', { vendor_url: wfmText, staff_no });
          if (!qa || qa.ok !== true) {
            notice('Scan ch∆∞a ƒë∆∞·ª£c x√°c nh·∫≠n b·ªüi QA API.', 'error', 5000);
            playSysErr();
            return;
          }
        } catch (e) {
          notice('L·ªói khi ki·ªÉm tra QA: ' + (e.message || e), 'error', 5000);
          playSysErr();
          return;
        }
      }

      // G·ªçi attendance & activity khi ƒë√£ c√≥ staff_no
      // ‚ö†Ô∏è Khi ·ªü ch·∫ø ƒë·ªô Firebase, staff_no l√† wfm_code (S098373)
      await callWms("/wms/attendance", { warehouse: wh, type: 1, staff_no });
      const act = await callWms("/wms/activity", { warehouse: wh, staff_no, act_no: "A0020" });
      const operator    = act?.data?.staff_name || "";
      const wms_user_id = act?.data?.wms_user_id || "";

  el("in-operator").textContent = (operator || "?").toUpperCase();
  el("in-wmsid").textContent    = wms_user_id || "?";

      const now = new Date();
      const gsheet_time_in = now.toLocaleString("en-GB", {
        hour12:false, day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).replace(",", "");

      // ƒê·∫£m b·∫£o vendor_name kh√¥ng r·ªóng ƒë·ªÉ tr√°nh path Firebase b·ªã l·ªói
      const vendorName = String(info.contractor || "").trim().toUpperCase() || "Other";

      // N·∫øu scan b·∫±ng WFM tr·ª±c ti·∫øp (kh√¥ng c√≥ fullname t·ª´ vendor), d√πng operator l√†m fullname
      const isDirectWfm = !String(info.full_name || "").trim();
      const fullnameValue = isDirectWfm
        ? String(operator || "").trim().toUpperCase()
        : String(info.full_name || "").trim().toUpperCase();

      const rec = {
        type:"in",
        wfm_code: staff_no.toUpperCase(),
        fullname: fullnameValue,
        vendor_name: vendorName,
        shift_in: shiftTime,
        date: todayKey(),
        gender: normalizeGender(info.gender),
        vendor_code: String(info.staff_id || "").trim().toUpperCase(),
        birth_year: String(info.birth_year || "").trim(),
        operator: String(operator || "").trim().toUpperCase(),
        wms_user_id: String(wms_user_id || "").trim(),
        gsheet_time_in
      };      const path = rtdbRecPath(wh, todayKey(), rec.shift_in, vendorName, staff_no.toUpperCase());
      console.log("[SCAN IN] Firebase path:", path);
      console.log("[SCAN IN] staff_no:", staff_no, "| vendor_code:", rec.vendor_code);
      await fetch(path, { method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(rec) });

      setPersonUI("in", info, img_url ? await imgFromUrl(img_url) : "");
      notice(`‚úÖ ${rec.fullname || ""} scan in ${now.toTimeString().slice(0,8)}`, "success", 6000);
      playSysOk();
      el("in-wfm").value = "";
      el("in-wfm").focus();
    }catch(e){
      notice(`Scan in l·ªói: ${e.message || e}`, "error", 5000);
      playSysErr();
    }finally{
      setAllDisabled(false);
      setBusy(false);
      safeFocus("in-wfm");
    }
    return;
  }

  if (direction === "task") {
    el("task-operator").textContent = "?";
    el("task-wmsid").textContent = "?";

    try {
      setAllDisabled(true);

      const qr = el("task-wfm").value.trim();
      const rawTask = assertValidVendorOrQR(qr);          // ƒë·ªÉ trong try
      const act_no  = el("task-type").value;

      const { staff_no, info, img_url } = await parseQR(rawTask);

      // Hi·ªÉn th·ªã NGAY sau parse
      setPersonUI("task", info, img_url ? await imgFromUrl(img_url) : "");

      if (!staff_no) {
        notice("Kh√¥ng l·∫•y ƒë∆∞·ª£c WFM t·ª´ vendor. Vui l√≤ng ki·ªÉm tra m√£/QR ho·∫∑c th·ª≠ l·∫°i.", "error", 5000);
        playSysErr();
        return;
      }

      // Ki·ªÉm tra ch·∫ø ƒë·ªô: n·∫øu Firebase, l·∫•y t·ª´ Firebase RTDB; n·∫øu kh√¥ng l·∫•y t·ª´ RTDB hi·ªán t·∫°i nh∆∞ c≈©
      const scanMode = el("scanMode")?.value || "vanhanh";
      let rec = null;

      if (scanMode === "firebase") {
        // Mode Firebase: l·∫•y t·ª´ Firebase RTDB c·ªßa ng√†y h√¥m nay (data ƒë√£ scan in)
        try {
          const raw  = await fetchRTDBAll(wh, todayKey());
          const flat = flattenRecords(raw);
          rec  = findTodayRec(flat, staff_no);

          if (!rec) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y staff ${staff_no} trong Firebase - ch∆∞a scan in`);
          }

          // Update UI t·ª´ Firebase record thay v√¨ VNDB
          setPersonUIFromRecord("task", rec);
        } catch (e) {
          notice(`L·ªói l·∫•y d·ªØ li·ªáu Firebase: ${e.message}`, "error", 5000);
          playSysErr();
          return;
        }
      } else {
        // Mode Vanhanh: l·∫•y t·ª´ RTDB hi·ªán t·∫°i
        const raw  = await fetchRTDBAll(wh, todayKey());
        const flat = flattenRecords(raw);
        rec  = findTodayRec(flat, staff_no);
      }

      // Helper c·ª•c b·ªô
      const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";

      // 1) B·∫Øt bu·ªôc: ƒë√£ In v√† CH∆ØA Out
      const isIn  = rec && hasVal(rec.shift_in);
      const isOut = rec && (hasVal(rec.shift_out) || hasVal(rec.gsheet_time_out));
      if (!isIn || isOut) {
        notice("Staff ch∆∞a scan in ho·∫∑c ƒë√£ scan out!", "error", 5000);
        playSysErr();
        return;
      }

      // 2) Ch·∫∑n tr√πng theo key (key n√†o ƒë√£ c√≥ gi√° tr·ªã th√¨ block)
      {
        const msg = checkDuplicateByKeys(rec, act_no);
        if (msg) {
          notice(msg, "error", 5000);
          playSysErr();
          return;
        }
      }

      // 3) X·ª≠ l√Ω theo lo·∫°i task
      const now = new Date();
      const task_time = now.toTimeString().slice(0,8);   // HH:MM:SS
      let field_name = null;
      let resp = null;

      if (act_no === "A0020") {
        const open60 = hasVal(rec.break_60) && !hasVal(rec.break_60_in);
        const open30 = hasVal(rec.break_30) && !hasVal(rec.break_30_in);

        if (!open60 && !open30) {
          throw new Error("Kh√¥ng c√≥ break n√†o ƒëang m·ªü ƒë·ªÉ k·∫øt th√∫c.");
        }
        if (open60 && open30) {
          throw new Error("ƒêang m·ªü ƒë·ªìng th·ªùi break 60' v√† 30'. Vui l√≤ng x·ª≠ l√Ω th·ªß c√¥ng.");
        }

        field_name = open60 ? "break_60_in" : "break_30_in";

        // G·ªçi API k·∫øt th√∫c break
        resp = await callWms("/wms/activity", { warehouse: wh, act_no: "A0020", staff_no });
        } else {
        // M·ªü break: A0027 (60) / A0026 (30)
        field_name = ({ "A0027":"break_60", "A0026":"break_30" })[act_no];

        resp = await callWms("/wms/activity", { warehouse: wh, act_no, staff_no });
      }

      // 4) Ghi PATCH l√™n RTDB (ghi theo c·∫•u tr√∫c shift ‚Üí vendor ‚Üí wfm)
      const patch = {}; patch[field_name] = task_time;
      const vendorNameForPath = (rec.vendor_name || "").trim() || "Other";
      const url = rtdbRecPath(
        wh,
        todayKey(),
        rec.shift_in || rec.shift || "",      // node ca
        vendorNameForPath,                     // node vendor
        staff_no.toUpperCase()                // D√πng staff_no ƒë√£ parse, chuy·ªÉn uppercase
      );
      console.log("[TASK] Firebase path:", url);
      console.log("[TASK] staff_no:", staff_no, "| rec.wfm_code:", rec.wfm_code, "| rec.vendor_code:", rec.vendor_code);
      await fetch(url, {
        method: "PATCH",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(patch)
      });

      // 5) UI done
  notice(`‚úÖ ${(resp?.data?.staff_name || info?.full_name || "")} ${task_time}`, "success", 5000);
  playSysOk();
  el("task-operator").textContent = (resp?.data?.staff_name || "").toUpperCase();
  el("task-wmsid").textContent    = resp?.data?.wms_user_id || "";

      // (tu·ª≥ ch·ªçn) refresh KPI & b·∫£ng break_60/break_30 t·∫°i ƒë√¢y
      // renderBreakTables(...);
    } catch (e) {
      console.error(e);
      notice(`Task l·ªói: ${e.message || e}`, "error", 5000);
      playSysErr();
    } finally {
      setAllDisabled(false);
      safeFocus("task-wfm");
    }
    return;
  }

  if (direction === "out") {
    el("out-operator").textContent = "?";
    el("out-wmsid").textContent = "?";
    const wfmText = el("out-wfm").value.trim();
    const rawOut  = assertValidVendorOrQR(wfmText);

    if (!rawOut) {
      notice("Vui l√≤ng nh·∫≠p/scan m√£ WFM.", "error");
      playSysErr();
      return;
    }

    try {
      setAllDisabled(true);
      const { staff_no, info, img_url } = await parseQR(rawOut);
      setPersonUI("out", info, img_url ? await imgFromUrl(img_url) : "");

      if (!staff_no){
        notice("Kh√¥ng l·∫•y ƒë∆∞·ª£c WFM t·ª´ vendor. Vui l√≤ng ki·ªÉm tra m√£/QR ho·∫∑c th·ª≠ l·∫°i.", "error", 5000);
        playSysErr();
        el("out-wfm").value = ""; safeFocus("out-wfm");
        return;
      }

      // Ki·ªÉm tra ch·∫ø ƒë·ªô: n·∫øu Firebase, l·∫•y t·ª´ Firebase RTDB; n·∫øu kh√¥ng l·∫•y t·ª´ RTDB hi·ªán t·∫°i nh∆∞ c≈©
      const scanMode = el("scanMode")?.value || "vanhanh";
      let rec = null;

      if (scanMode === "firebase") {
        // Mode Firebase: l·∫•y t·ª´ Firebase RTDB c·ªßa ng√†y h√¥m nay (data ƒë√£ scan in)
        try {
          const raw  = await fetchRTDBAll(wh, todayKey());
          const flat = flattenRecords(raw);
          rec  = findTodayRec(flat, staff_no);

          if (!rec) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y staff ${staff_no} trong Firebase - ch∆∞a scan in`);
          }

          // Update UI t·ª´ Firebase record thay v√¨ VNDB
          setPersonUIFromRecord("out", rec);
        } catch (e) {
          notice(`L·ªói l·∫•y d·ªØ li·ªáu Firebase: ${e.message}`, "error", 5000);
          playSysErr();
          return;
        }
      } else {
        // Mode Vanhanh: l·∫•y t·ª´ RTDB hi·ªán t·∫°i
        const raw  = await fetchRTDBAll(wh, todayKey());
        const flat = flattenRecords(raw);
        rec  = findTodayRec(flat, staff_no);
      }

      // helper
      const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";

      // B·∫Øt bu·ªôc ƒë√£ In v√† ch∆∞a Out
      const isIn  = rec && hasVal(rec.shift_in);
      const isOut = rec && (hasVal(rec.shift_out) || hasVal(rec.gsheet_time_out));
      if (!isIn || isOut) {
        notice("Nh√¢n vi√™n n√†y ch∆∞a Scan In tr∆∞·ªõc ƒë√≥ ho·∫∑c ƒë√£ Scan Out.", "error", 5000);
        playSysErr();
        return;
      }

      // Ch·∫∑n tr√πng theo key cho Out (shift_out ƒë√£ c√≥)
      {
        const msg = checkDuplicateByKeys(rec, "out");
        if (msg){
          notice(msg, "error", 5000);
          playSysErr();
          return;
        }
        el("out-wfm").value = ""; safeFocus("out-wfm");
      }

      // Set UI t·ª´ record
      setPersonUI("out", info || rec, img_url ? await imgFromUrl(img_url) : "");
  el("out-operator").textContent = (rec.operator || "").toUpperCase();
      el("out-wmsid").textContent    = rec.wms_user_id || "";

      // Attendance Out
      await callWms("/wms/attendance", { warehouse: wh, type: 2, staff_no });

      const now = new Date();
      const shift_out = `${String(+el("hour").value).padStart(2,"0")}:${el("minute").value==="30" ? "30" : "00"}`;
      const gsheet_time_out = now.toLocaleString("en-GB", {
        hour12:false, day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).replace(",", "");

      const patch = { shift_out, gsheet_time_out, type:"done" };
      const vendorNameForPath = (rec.vendor_name || "").trim() || "Other";
      const url = rtdbRecPath(
        wh,
        todayKey(),
        rec.shift_in || rec.shift,
        vendorNameForPath,
        staff_no.toUpperCase()  // D√πng staff_no ƒë√£ parse, chuy·ªÉn uppercase
      );
      console.log("[SCAN OUT] Firebase path:", url);
      console.log("[SCAN OUT] staff_no:", staff_no, "| rec.wfm_code:", rec.wfm_code, "| rec.vendor_code:", rec.vendor_code);
      await fetch(url, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(patch) });

      notice(`‚úÖ ${(info?.full_name || rec.fullname || "")} scan out ${now.toTimeString().slice(0,8)}`, "success", 5000);
      playSysOk();
      el("out-wfm").value = "";

    }catch(e){
      notice(`Scan out l·ªói: ${e.message || e}`, "error", 5000);
      playSysErr();
    }finally{
      setAllDisabled(false);
      setBusy(false);
      safeFocus("out-wfm");
    }
    return;
  }
}


  /* ====================== REALTIME (Firebase) ====================== */
  // module type="module" ƒë·ªÉ import SDK s·∫Ω ti·ªán h∆°n; ·ªü ƒë√¢y m√¨nh t·ªëi gi·∫£n: SDK import ·ªü cu·ªëi b·∫±ng type=module
  window.__startRealtimeAll = function(db){
    let detach=null;
    function start(){
      const wh = el('warehouse')?.value || 'VNDB';
      const dp = el('dayPicker');
      const day = (dp?.value && /^\d{4}-\d{2}-\d{2}$/.test(dp.value)) ? dp.value : todayKey();
      applyDayLock();   // <<< g·ªçi ngay khi ƒë·ªïi ng√†y/kho

      if(detach){ try{ detach(); }catch{} detach=null; }
      setBusy(true);

      const { ref, onValue } = window.__firebaseDB;
      const r = ref(db, `${wh}/${day}`);
      console.debug("[Realtime] Listen:", `${wh}/${day}`);

      detach = onValue(
        r,
        (snap)=>{
          const val=snap.val()||{};
          const stats=computeCounts(val);
          renderInCounters(stats);
          renderOutCounters(stats);
          renderTaskRightCards(val);
          renderDashboardList(val);
          setBusy(false);

          // Auto-refresh analytics if analyze tab is active
          const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab;
          if (activeTab === 'analyze') {
            loadAnalytics();
          }
        },
        (err)=>{
          console.error("[Realtime] error:", err);
          notice("L·ªói k·∫øt n·ªëi Firebase!", "error", 3000);
          playSysErr();
          setBusy(false);
        }
      );
    }
    el('dayPicker')?.addEventListener('change', start);
    el('warehouse')?.addEventListener('change', start);
    window.addEventListener('load', start);

    // Start immediately once configured so UI updates without requiring extra navigation
    try { start(); } catch(e){ console.warn('Realtime start failed (will retry on load/change):', e); }
  };

  /* ====================== INIT ====================== */
  function bindEvents(){
    // Scan Mode selector - l∆∞u l·ª±a ch·ªçn v√†o localStorage
    el("scanMode")?.addEventListener('change', (e)=>{
      const mode = e.target.value;
      localStorage.setItem('scanMode', mode);
      console.log('[ScanMode] Changed to:', mode);
      notice(`Ch·∫ø ƒë·ªô scan: ${mode === 'firebase' ? 'Firebase VNDB' : 'Vanhanh API'}`, 'info', 2000);
    });

    // Tabs
    const tabs = el('tabs');
    tabs?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab-btn'); if(!btn) return;
      const tabName = btn.dataset.tab;
      setActiveTab(tabName);

      // Auto-load analytics when switching to analyze tab (always reload)
      if (tabName === 'analyze') {
        loadAnalytics();
      }
    });

    // Scan buttons
    el("btnScanIn").onclick  = ()=>doScan("in");
    el("in-wfm").addEventListener("keydown", e=>{ if(e.key==="Enter") doScan("in"); });
    el("btnScanOut").onclick = ()=>doScan("out");
    el("out-wfm").addEventListener("keydown", e=>{ if(e.key==="Enter") doScan("out"); });
    el("btnScanTask").onclick = ()=>doScan("task");
    el("task-wfm").addEventListener("keydown", e=>{ if(e.key==="Enter") doScan("task"); });

    // Dashboard filter buttons + pager
    $$('.filter-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        showFilterModal(btn.dataset.col);
      });
    });

    el("dash-prev")?.addEventListener('click', ()=>{ if(DASH.page>1){ DASH.page--; renderDashTable(); }});
    el("dash-next")?.addEventListener('click', ()=>{ DASH.page++; renderDashTable(); });
    el("dash-jump")?.addEventListener('change', ()=>{
      const jump=el("dash-jump"); const v=Math.max(1, parseInt(jump.value||"1",10));
      DASH.page=v; renderDashTable();
    });

    // Reset filters button
    el("btnResetFilters")?.addEventListener('click', resetAllFilters);

    // Refresh analytics button
    el("btnRefreshAnalyze")?.addEventListener('click', loadAnalytics);

    // Threshold input change
    el("analyze-threshold")?.addEventListener('change', function() {
      if (ANALYZE.currentData && ANALYZE.allData) {
        loadAnalytics();
      }
    });

    // Edit Mode button
    el("btnEditMode")?.addEventListener('click', toggleEditMode);

    // Double-click to edit cells
    el("tbody-dash")?.addEventListener('dblclick', (e)=>{
      const td = e.target.closest('td');
      if(!td || !td.classList.contains('editable')) return;
      if(document.body.dataset.editMode !== "1") return;
      makeCellEditable(td);
    });

    // Filter modal events
    el("filterCancel")?.addEventListener('click', hideFilterModal);
    el("filterModal")?.addEventListener('click', (e)=>{
      if(e.target === el("filterModal")) hideFilterModal();
    });
    el("filterClear")?.addEventListener('click', clearCurrentFilter);
    el("filterApply")?.addEventListener('click', applyCurrentFilter);
    el("filterSearch")?.addEventListener('input', filterSearchOptions);

    // Edit Modal handlers
    el("editCancel")?.addEventListener('click', hideEditModal);
    el("editModal")?.addEventListener('click', (e)=>{
      if(e.target === el("editModal")) hideEditModal();
    });
    el("editSave")?.addEventListener('click', saveEditForm);

  }

  // Filter functionality
  let currentFilterColumn = null;
  let currentFilterValues = new Set();
  let EDITING_ROW = null;

  function resetAllFilters() {
    // Clear all filters
    DASH.filters = {};
    DASH.page = 1;

    // Remove active state from all filter buttons
    $$('.filter-btn').forEach(btn => btn.classList.remove('active'));

    // Re-render table with all data
    applyDashFiltersAndRender();

    // Show success message
    notice("ƒê√£ reset t·∫•t c·∫£ b·ªô l·ªçc", "success", 6000);
  }

  function showFilterModal(column) {
    currentFilterColumn = column;
    const title = el("filterTitle");
    const options = el("filterOptions");
    const modal = el("filterModal");

    // Get unique values for this column, including blank values
    const allValues = DASH.rows.map(row => String(row[column] || ""));
    const nonEmptyValues = [...new Set(allValues.filter(v => v.trim()))].sort();
    const hasEmptyValues = allValues.some(v => !v.trim());

    // Combine non-empty values with blank option if there are empty values
    const values = hasEmptyValues ? ["(Tr·ªëng)", ...nonEmptyValues] : nonEmptyValues;

    title.textContent = `L·ªçc: ${getColumnTitle(column)}`;

    // Build options HTML
    options.innerHTML = values.map(value => `
      <div class="filter-option" data-value="${value}">
        <input type="checkbox" id="filter_${value}" value="${value}" ${currentFilterValues.has(value) ? 'checked' : ''}>
        <label for="filter_${value}">${value}</label>
      </div>
    `).join('');

    // Add click handlers for the entire row
    $$('#filterOptions .filter-option').forEach(option => {
      option.addEventListener('click', (e) => {
        // Don't trigger if user clicked directly on checkbox or label
        if (e.target.type === 'checkbox' || e.target.tagName === 'LABEL') return;

        const checkbox = option.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
        }
      });
    });

    modal.classList.add('show');
  }

  function hideFilterModal() {
    el("filterModal").classList.remove('show');
    el("filterSearch").value = '';
  }

  function getColumnTitle(column) {
    const titles = {
      vendor_name: 'Nh√† Th·∫ßu',
      vendor_code: 'M√£ Vendor',
      wfm_code: 'M√£ WFM',
      wms_user_id: 'M√£ WMS',
      operator: 'Operator',
      fullname: 'H·ªç v√† T√™n',
      gender: 'Gi·ªõi t√≠nh',
      birth_year: 'NƒÉm sinh',
      gsheet_time_in: 'Time in',
      break_60: 'Ngh·ªâ Tr∆∞a',
      break_60_in: 'V√†o Ca Tr∆∞a',
      break_30: 'Ngh·ªâ OT',
      break_30_in: 'V√†o Ca OT',
      gsheet_time_out: 'Time Out'
    };
    return titles[column] || column;
  }

  function clearCurrentFilter() {
    $$('#filterOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
  }

  function applyCurrentFilter() {
    const checkedValues = Array.from($$('#filterOptions input[type="checkbox"]:checked')).map(cb => cb.value);

    if (checkedValues.length === 0) {
      delete DASH.filters[currentFilterColumn];
    } else {
      DASH.filters[currentFilterColumn] = checkedValues;
    }

    // Update filter button appearance
    const filterBtn = $(`.filter-btn[data-col="${currentFilterColumn}"]`);
    if (filterBtn) {
      if (checkedValues.length === 0) {
        filterBtn.classList.remove('active');
      } else {
        filterBtn.classList.add('active');
      }
    }

    DASH.page = 1;
    applyDashFiltersAndRender();
    hideFilterModal();
  }

  function filterSearchOptions() {
    const searchValue = el("filterSearch").value.toLowerCase();
    $$('.filter-option').forEach(option => {
      const label = option.querySelector('label').textContent.toLowerCase();
      option.style.display = label.includes(searchValue) ? 'flex' : 'none';
    });
  }

  // ===== Edit Modal Functions =====
  let EDIT_CONTEXT = null; // Store context for current edit operation

  function showEditModal(rowData) {
    if (!rowData) return;

    EDIT_CONTEXT = JSON.parse(JSON.stringify(rowData)); // Deep copy

    // Populate form fields
    el("edit-vendor_name").value = rowData.vendor_name || "";
    el("edit-vendor_code").value = rowData.vendor_code || "";
    el("edit-wfm_code").value = rowData.wfm_code || "";
    el("edit-wms_user_id").value = rowData.wms_user_id || "";
    el("edit-fullname").value = rowData.fullname || "";
    el("edit-gender").value = rowData.gender || "";
    el("edit-birth_year").value = rowData.birth_year || "";

    el("editModal").classList.add('show');
    safeFocus("edit-vendor_name");
  }

  function hideEditModal() {
    el("editModal").classList.remove('show');
    EDIT_CONTEXT = null;
  }

  async function saveEditForm() {
    if (!EDIT_CONTEXT) {
      notice("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u", "error", 3000);
      return;
    }

    const wh = el('warehouse')?.value || 'VNDB';
    const dp = el('dayPicker');
    const day = (dp?.value && /^\d{4}-\d{2}-\d{2}$/.test(dp.value)) ? dp.value : todayKey();

    // Get form values
    const newData = {
      vendor_name: el("edit-vendor_name").value.trim().toUpperCase() || EDIT_CONTEXT.vendor_name,
      vendor_code: el("edit-vendor_code").value.trim().toUpperCase() || EDIT_CONTEXT.vendor_code,
      wms_user_id: el("edit-wms_user_id").value.trim(),
      fullname: el("edit-fullname").value.trim().toUpperCase(),
      gender: normalizeGender(el("edit-gender").value),
      birth_year: el("edit-birth_year").value.trim()
    };

    // Validate required fields
    if (!newData.fullname) {
      notice("Vui l√≤ng nh·∫≠p H·ªç v√† t√™n", "error", 3000);
      safeFocus("edit-fullname");
      return;
    }

    const oldShift = EDIT_CONTEXT.shift_in || EDIT_CONTEXT.shift || '';
    const oldVendor = EDIT_CONTEXT.vendor_name || "Other";
    const wfm = (EDIT_CONTEXT.wfm_code || '').toUpperCase();

    if (!wfm || !oldShift) {
      notice("Kh√¥ng ƒë·ªß th√¥ng tin ƒë·ªÉ l∆∞u", "error", 3000);
      return;
    }

    try {
      // 1. Fetch current record
      const oldUrl = rtdbRecPath(wh, day, oldShift, oldVendor, wfm);
      const getResp = await fetch(oldUrl);
      const currentRecord = await getResp.json();

      if (!currentRecord) {
        notice("Kh√¥ng t√¨m th·∫•y record ƒë·ªÉ c·∫≠p nh·∫≠t", "error", 3000);
        return;
      }

      // 2. Create updated record with new vendor_name (which creates a "link" to vendor node)
      const updatedRecord = {
        ...currentRecord,
        vendor_name: newData.vendor_name,
        vendor_code: newData.vendor_code,
        wms_user_id: newData.wms_user_id,
        fullname: newData.fullname,
        gender: newData.gender,
        birth_year: newData.birth_year
      };

      // 3. Check if vendor_name changed - if so, move record to new vendor node
      if (newData.vendor_name !== oldVendor) {
        // Write to new vendor node
        const newUrl = rtdbRecPath(wh, day, oldShift, newData.vendor_name, wfm);
        await fetch(newUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedRecord)
        });

        // Delete from old vendor node
        await fetch(oldUrl, { method: "DELETE" });

        notice(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t v√† chuy·ªÉn nh√¢n vi√™n sang Nh√† Th·∫ßu: ${newData.vendor_name}`, "success", 4000);
      } else {
        // Just update fields in same vendor node
        const patch = {
          wms_user_id: newData.wms_user_id,
          fullname: newData.fullname,
          gender: newData.gender,
          birth_year: newData.birth_year,
          vendor_code: newData.vendor_code
        };

        await fetch(oldUrl, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(patch)
        });

        notice("‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n", "success", 4000);
      }

      // Update local row
      for (const [key, value] of Object.entries(newData)) {
        EDIT_CONTEXT[key] = value;
      }

      hideEditModal();
      // Realtime update will refresh dashboard automatically
    } catch (e) {
      console.error(e);
      notice(`L∆∞u th·∫•t b·∫°i: ${e.message || e}`, "error", 4000);
    }
  }

  function toggleEditMode(){
    const current = document.body.dataset.editMode === "1";
    const btn = el('btnEditMode');

    if(!current){
      // Enable edit mode
      document.body.dataset.editMode = "1";
      if(btn) {
        btn.textContent = "View Mode";
        btn.classList.add('active');
      }
      // notice("Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a ƒë√£ B·∫¨T. Double-click v√†o √¥ ƒë·ªÉ ch·ªânh s·ª≠a.", "info", 4000);
    } else {
      // Disable edit mode
      document.body.dataset.editMode = "0";
      if(btn) {
        btn.textContent = "Edit Mode";
        btn.classList.remove('active');
      }
      // notice("Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a ƒë√£ T·∫ÆT.", "info", 3000);
    }

    renderDashTable();
  }

  // Convert cell to editable on double-click
  function makeCellEditable(td){
    if(!td || !td.dataset.field) return;
    if(td.getAttribute('contenteditable') === 'true') return; // Already editing

    const idx = parseInt(td.dataset.idx || "0", 10);
    const field = td.dataset.field;
    const row = DASH.filtered[idx];
    if(!row) return;

    const currentValue = row[field] || '';
    const originalText = td.textContent.trim();

    // Make cell editable
    td.contentEditable = 'true';
    td.classList.add('editing');
    td.focus();

    // Select all text
    const range = document.createRange();
    range.selectNodeContents(td);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);

    // Save on blur or Enter
    const save = async () => {
      td.contentEditable = 'false';
      td.classList.remove('editing');

      const newValue = td.textContent.trim();
      if(newValue === currentValue || newValue === originalText) {
        // No change
        td.textContent = originalText;
        return;
      }

      const wh = el('warehouse')?.value || 'VNDB';
      const dp = el('dayPicker');
      const day = (dp?.value && /^\d{4}-\d{2}-\d{2}$/.test(dp.value)) ? dp.value : todayKey();
      const oldShift = row.shift_in || row.shift || '';
      const vendorName = row.vendor_name || '';
      const wfm = (row.wfm_code || '').toUpperCase();

      if(!wfm || !oldShift) {
        notice("Kh√¥ng ƒë·ªß th√¥ng tin ƒë·ªÉ l∆∞u", "error", 3000);
        td.textContent = originalText;
        return;
      }

      try{
        // Special handling for shift_in: move record to new shift node
        if(field === 'shift_in') {
          const newShift = newValue.trim();
          if(!newShift || !/^\d{1,2}:\d{2}$/.test(newShift)) {
            notice("Shift ph·∫£i theo ƒë·ªãnh d·∫°ng HH:MM (vd: 10:30)", "error", 3000);
            td.textContent = originalText;
            return;
          }

          // 1. Fetch current record from old shift node
          const oldUrl = rtdbRecPath(wh, day, oldShift, vendorName, wfm);
          const getResp = await fetch(oldUrl);
          const currentRecord = await getResp.json();

          if(!currentRecord) {
            notice("Kh√¥ng t√¨m th·∫•y record ƒë·ªÉ di chuy·ªÉn", "error", 3000);
            td.textContent = originalText;
            return;
          }

          // 2. Create updated record with new shift_in
          const updatedRecord = { ...currentRecord, shift_in: newShift };

          // 3. Write to new shift node
          const newUrl = rtdbRecPath(wh, day, newShift, vendorName, wfm);
          await fetch(newUrl, {
            method: "PUT",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(updatedRecord)
          });

          // 4. Delete from old shift node
          await fetch(oldUrl, { method: "DELETE" });

          // 5. Update local row data
          row.shift_in = newShift;
          row.shift = newShift;
          td.textContent = newShift;
          td.style.background = '#d4edda';
          setTimeout(() => td.style.background = '', 800);

          // 6. Re-sort and re-render dashboard to reflect new shift order
          applyDashFiltersAndRender();

          notice("‚úÖ ƒê√£ di chuy·ªÉn record sang ca m·ªõi", "success", 3000);
        } else if(field === 'vendor_name') {
          // Special handling for vendor_name: move record to new vendor node
          const newVendor = newValue.trim().toUpperCase() || vendorName;
          if(!newVendor) {
            notice("Nh√† th·∫ßu kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng", "error", 3000);
            td.textContent = originalText;
            return;
          }

          // 1. Fetch current record from old vendor node
          const oldUrl = rtdbRecPath(wh, day, oldShift, vendorName, wfm);
          const getResp = await fetch(oldUrl);
          const currentRecord = await getResp.json();

          if(!currentRecord) {
            notice("Kh√¥ng t√¨m th·∫•y record ƒë·ªÉ di chuy·ªÉn", "error", 3000);
            td.textContent = originalText;
            return;
          }

          // 2. Create updated record with new vendor_name
          const updatedRecord = { ...currentRecord, vendor_name: newVendor };

          // 3. Write to new vendor node
          const newUrl = rtdbRecPath(wh, day, oldShift, newVendor, wfm);
          await fetch(newUrl, {
            method: "PUT",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(updatedRecord)
          });

          // 4. Delete from old vendor node
          await fetch(oldUrl, { method: "DELETE" });

          // 5. Update local row data
          row.vendor_name = newVendor;
          td.textContent = newVendor;
          td.style.background = '#d4edda';
          setTimeout(() => td.style.background = '', 800);

          // 6. Re-sort and re-render dashboard to reflect new vendor
          applyDashFiltersAndRender();

          notice("‚úÖ ƒê√£ di chuy·ªÉn nh√¢n vi√™n sang Nh√† Th·∫ßu: " + newVendor, "success", 3000);
        } else {
          // Normal field update: just PATCH
          const patch = { [field]: newValue };
          const url = rtdbRecPath(wh, day, oldShift, vendorName, wfm);
          await fetch(url, {
            method: "PATCH",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(patch)
          });

          row[field] = newValue;
          td.textContent = newValue;
          td.style.background = '#d4edda';
          setTimeout(() => td.style.background = '', 800);
        }
      }catch(e){
        console.error(e);
        notice(`L∆∞u th·∫•t b·∫°i: ` + (e.message || e), "error", 4000);
        td.textContent = originalText;
      }
    };

    const onBlur = () => save();
    const onKeydown = (e) => {
      if(e.key === 'Enter') {
        e.preventDefault();
        td.blur();
      } else if(e.key === 'Escape') {
        td.contentEditable = 'false';
        td.classList.remove('editing');
        td.textContent = originalText;
      }
    };

    td.addEventListener('blur', onBlur, {once: true});
    td.addEventListener('keydown', onKeydown);
  }  function applyDashFiltersAndRender(){
    const fs=DASH.filters||{};
    DASH.filtered = DASH.rows.filter(row=>{
      for(const [k,val] of Object.entries(fs)){
        if(!val) continue;
        if (Array.isArray(val)) {
          // New filter format - array of selected values
          const cellValue = String(row[k] || "");
          const isEmpty = !cellValue.trim();

          // Check if the value matches any selected filter
          const matches = val.some(filterValue => {
            if (filterValue === "(Tr·ªëng)") {
              return isEmpty; // Match empty values
            } else {
              return cellValue === filterValue; // Exact match for non-empty values
            }
          });

          if (!matches) return false;
        } else {
          // Old format fallback
          const q=v=>String(v||"").toLowerCase();
          if(!q(row[k]).includes(q(val))) return false;
        }
      }
      return true;
    });
    renderDashTable();
  }

  function initDayPicker(){
    const dp=el('dayPicker');
    if(!dp) return;
    if(!dp.value){
      const d=new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      dp.value = `${y}-${m}-${dd}`;
    }
  }

  function init(){
    const {h,use30}=ceilToNext15();
    el("hour").value = h;
    el("minute").value = use30;

    // Restore scan mode from localStorage
    const savedMode = localStorage.getItem('scanMode') || 'vanhanh';
    el("scanMode").value = savedMode;

    notice("D·ªØ li·ªáu ƒë√£ s·∫µn s√†ng!", "success", 2000);
    scheduleShiftAutoAdvance();
    setActiveTab('scan');
    initDayPicker();
    applyDayLock();
    bindEvents();
  }

  // Expose minimal for debugging if c·∫ßn
  window.ScanTool = { CONFIG, doScan };

  // Run init
  document.addEventListener('DOMContentLoaded', init);

  // Export Excel t·ª´ d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã (ƒë√£ l·ªçc)
  el("btnExportXlsx")?.addEventListener("click", () => {
    try{
      const headers = [
        "Nh√† Th·∫ßu","M√£ Vendor","M√£ WFM","M√£ WMS","Operator",
        "H·ªç v√† T√™n","Gi·ªõi t√≠nh","NƒÉm sinh","Shift In","Time in",
        "Ngh·ªâ Tr∆∞a","V√†o Ca Tr∆∞a","Ngh·ªâ OT","V√†o Ca OT","Shift Out","Time Out"
      ];
      const rows = (DASH.filtered?.length ? DASH.filtered : DASH.rows).map(r => ([
        r.vendor_name, r.vendor_code, r.wfm_code, r.wms_user_id, r.operator,
        r.fullname, r.gender, r.birth_year,
        r.shift_in || r.shift || "", r.gsheet_time_in,
        r.break_60,  r.break_60_in, r.break_30, r.break_30_in, r.shift_out || "", r.gsheet_time_out
      ]));

      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      // Fit width nh·∫π
      const colWidths = headers.map((h, i) => ({
        wch: Math.max(
          String(h || "").length + 2,
          ...rows.map(r => String(r[i] || "").length + 1)
        )
      }));
      ws['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Dashboard");
      const wh = el("warehouse")?.value || "WAREHOUSE";
      const day = el("dayPicker")?.value || todayKey();
      XLSX.writeFile(wb, `dashboard_${wh}_${day}.xlsx`);
      playSysOk();
    }catch(e){
      console.error(e);
      notice("Xu·∫•t Excel th·∫•t b·∫°i.", "error", 4000);
      playSysErr();
    }
  });

  // Expose debug function ƒë·ªÉ test Firebase
  window.testFirebaseWFM = async function(wfmCode) {
    try {
      console.log('[DEBUG] Testing Firebase v·ªõi WFM:', wfmCode);
      const result = await fetchStaffFromScanToolByDate(wfmCode, todayKey());
      console.log('[DEBUG] ‚úì T√¨m th·∫•y record:', result);
      return result;
    } catch (e) {
      console.error('[DEBUG] ‚úó L·ªói:', e.message);
      throw e;
    }
  };

})();
</script>

<!-- ========================== View-Only Mode Handler ========================== -->
<script>
(function() {
  "use strict";

  // Check if user is authenticated (passed from backend via template)
  const isAuthenticated = "{{ 'true' if is_authenticated else 'false' }}" === "true";

  function applyViewOnlyMode() {
    if (isAuthenticated) return;

    console.log('[VIEW-ONLY] Disabling all action controls');

    // Disable all input fields for actions
    const actionInputs = [
      'in-wfm', 'out-wfm', 'task-wfm',
      'dayPicker', 'hour', 'minute', 'warehouse',
      'task-type', 'analyze-threshold'
    ];

    actionInputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.disabled = true;
        el.readOnly = true;
        el.style.opacity = '0.6';
        el.style.cursor = 'not-allowed';
        el.style.pointerEvents = 'none';
        el.title = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y';

        // Prevent all input events
        el.addEventListener('keydown', (e) => e.preventDefault(), true);
        el.addEventListener('keypress', (e) => e.preventDefault(), true);
        el.addEventListener('input', (e) => e.preventDefault(), true);
        el.addEventListener('change', (e) => e.preventDefault(), true);
        el.addEventListener('focus', (e) => e.blur(), true);
      }
    });

    // Disable all action buttons
    const actionButtons = [
      'btnScanIn', 'btnScanOut', 'btnScanTask',
      'btnEditMode', 'btnExportXlsx', 'btnResetFilters',
      'btnRefreshAnalyze'
    ];

    actionButtons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        btn.style.pointerEvents = 'none';
        btn.title = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y';
      }
    });

    // Disable filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.style.pointerEvents = 'none';
      btn.title = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y';
    });

    // Show view-only notice
    const notice = document.getElementById('notice');
    if (notice) {
      notice.textContent = '‚ö† Ch·∫ø ƒë·ªô ch·ªâ xem - Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c';
      notice.dataset.kind = 'warning';
      notice.style.opacity = '1';
    }

    // Override action functions to show login prompt
    const showLoginPrompt = (e) => {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      if (confirm('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.\n\nƒêƒÉng nh·∫≠p ngay?')) {
        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
      }
      return false;
    };

    // Override scan functions globally
    if (typeof window.doScan === 'function') {
      window.doScan = showLoginPrompt;
    }

    // Prevent edit mode on dashboard
    const tbody = document.getElementById('tbody-dash');
    if (tbody) {
      tbody.addEventListener('dblclick', showLoginPrompt, true);
      tbody.addEventListener('click', (e) => {
        const td = e.target.closest('td');
        if (td && td.classList.contains('editable')) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);
    }
  }

  // Apply immediately if DOM ready, otherwise wait
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyViewOnlyMode);
  } else {
    applyViewOnlyMode();
  }

  // Also apply after a short delay to catch any late-rendered elements
  setTimeout(applyViewOnlyMode, 500);
})();
</script>

<!-- ========================== Firebase SDK (module) ========================== -->
<script type="module">
  // Import modular Firebase configuration
  import { initFirebase } from '../static/js/firebase-config.js';

  // Initialize Firebase for scan project
  const { app, db, ref, onValue, databaseURL } = await initFirebase('scan');

  // ‚ÄúC·∫ßu n·ªëi‚Äù ƒë·ªÉ script ch√≠nh d√πng m√† kh√¥ng c·∫ßn import (gi·ªØ one-file)
  window.__firebaseDB = { ref, onValue, databaseURL };
  if (typeof window.__startRealtimeAll === 'function') {
    window.__startRealtimeAll(db);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
{% endblock %}
