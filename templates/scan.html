{% extends "base.html" %}
{% block title %}Scan Tool{% endblock %}
{% block content %}

<script>
  window.API_BASE = window.API_BASE || "";
</script>

<!-- ===== Notice ===== -->
<div id="notice" class="notice"></div>

  <div class="row card space-between">
    <div class="row">
      <label>Ngày</label>
      <input id="dayPicker" type="date">
      <label>Warehouse</label>
      <select id="warehouse"><option>VNDB</option></select>
      <label>Ca</label>
      <div class="row">
        <input id="hour" type="number" min="0" max="23">
        <span>:</span>
        <select id="minute"><option>00</option><option>30</option></select>
      </div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="scan">SCAN IN/OUT</button>
    <button class="tab-btn" data-tab="task">SCAN TASK</button>
    <button class="tab-btn" data-tab="dash">DASHBOARD</button>
  </div>

  <!-- ========================== PANEL: SCAN ========================== -->
  <section id="tab-scan" class="tab-panel grid grid-2">
    <div class="grid">
      <!-- IN -->
      <div class="card">
        <div class="row">
          <input id="in-wfm" type="text" class="big grow" placeholder="Scan Mã QR hoặc WFM" spellcheck="false">
          <button id="btnScanIn" class="btn-action">Scan In</button>
        </div>
        <hr>
        <div class="grid grid-2">
          <div>
            <div class="kpi" id="in-fullname"></div>
            <div class="row"><label>Nhà thầu:</label> <div id="in-vendor" class="grow"></div></div>
            <div class="row"><label>Mã Vendor:</label> <div id="in-vendor-code" class="grow"></div></div>
            <div class="row"><label>Giới tính:</label> <div id="in-gender" class="grow"></div></div>
            <div class="row"><label>Năm sinh:</label> <div id="in-birth" class="grow"></div></div>
            <div class="row"><label>Operator:</label> <div id="in-operator" class="grow"></div></div>
            <div class="row"><label>WMS ID:</label> <div id="in-wmsid" class="grow"></div></div>
          </div>
          <div class="row end">
            <img id="in-avatar" class="avatar" alt="avatar">
          </div>
        </div>
      </div>

      <!-- OUT -->
      <div class="card">
        <div class="row">
          <input id="out-wfm" type="text" class="big grow" placeholder="Scan Mã QR hoặc WFM" spellcheck="false">
          <button id="btnScanOut" class="btn-action">Scan Out</button>
        </div>
        <hr>
        <div class="grid grid-2">
          <div>
            <div class="kpi" id="out-fullname"></div>
            <div class="row"><label>Nhà thầu:</label> <div id="out-vendor" class="grow"></div></div>
            <div class="row"><label>Mã Vendor:</label> <div id="out-vendor-code" class="grow"></div></div>
            <div class="row"><label>Giới tính:</label> <div id="out-gender" class="grow"></div></div>
            <div class="row"><label>Năm sinh:</label> <div id="out-birth" class="grow"></div></div>
            <div class="row"><label>Operator:</label> <div id="out-operator" class="grow"></div></div>
            <div class="row"><label>WMS ID:</label> <div id="out-wmsid" class="grow"></div></div>
          </div>
          <div class="row end">
            <img id="out-avatar" class="avatar" alt="avatar">
          </div>
        </div>
      </div>
    </div>

    <!-- Counter phải -->
    <div class="grid">
      <div class="counter card">
        <h3 id="in-total">Total Scan In</h3>
        <div id="in-shifts"><div class="block">
          <div class="stats-line"><strong></strong></div>
          <div class="stats-line vendors"><span></span></div>
        </div></div>
        <hr>
        <div id="in-vendor-stats" class="stats-line vendors"><span></span></div>
      </div>

      <div class="counter card">
        <h3 id="out-total">Total Scan Out</h3>
        <div id="out-shifts"><div class="stats-line"></div></div>
        <hr>
        <div id="out-vendor-stats" class="stats-line"></div>
      </div>
    </div>
  </section>

  <!-- ========================== PANEL: TASK ========================== -->
  <section id="tab-task" class="tab-panel grid grid-2 is-hidden">
    <div class="grid">
      <div class="card row">
        <input id="task-wfm" type="text" class="big grow" placeholder="Scan Mã QR hoặc WFM" spellcheck="false">
        <select id="task-type">
          <option value="A0027">Nghỉ Trưa</option>
          <option value="A0020">Vào Ca</option>
          <option value="A0026">Nghỉ OT</option>
        </select>
        <button id="btnScanTask" class="btn-action">SCAN</button>
        <div id="task-result" class="kpi ml-auto"></div>
      </div>

      <div class="card">
        <div class="grid grid-2">
          <div>
            <div class="kpi" id="task-fullname"></div>
            <div class="row"><label>Nhà thầu:</label>  <div id="task-vendor" class="grow"></div></div>
            <div class="row"><label>Mã Vendor:</label> <div id="task-vendor-code" class="grow"></div></div>
            <div class="row"><label>Giới tính:</label> <div id="task-gender" class="grow"></div></div>
            <div class="row"><label>Năm sinh:</label> <div id="task-birth" class="grow"></div></div>
            <div class="row"><label>Operator:</label> <div id="task-operator" class="grow"></div></div>
            <div class="row"><label>WMS ID:</label>   <div id="task-wmsid" class="grow"></div></div>
          </div>
          <div class="row end">
            <img id="task-avatar" class="avatar" alt="avatar">
          </div>
        </div>
      </div>
    </div>

    <!-- Counter phải -->
    <div class="grid" id="task-right">
      <div class="counter card" id="task60-card">
        <h3 id="task60-header">Nghỉ Trưa: 0 / Vào Ca: 0 / Total: 0</h3>
        <div id="task60-total" class="stats-line is-hidden"></div>
        <div id="task60-shifts"><div class="stats-line">Đang tải...</div></div>
        <hr>
        <div id="task60-vendor-stats" class="stats-line"></div>
      </div>

      <div class="counter card" id="task30-card">
        <h3 id="task30-header">Nghỉ OT: 0 / Vào Ca: 0 / Total: 0</h3>
        <div id="task30-total" class="stats-line is-hidden"></div>
        <div id="task30-shifts"><div class="stats-line">Đang tải...</div></div>
        <hr>
        <div id="task30-vendor-stats" class="stats-line"></div>
      </div>
    </div>
  </section>

  <!-- ========================== PANEL: DASHBOARD ========================== -->
  <section id="tab-dash" class="tab-panel is-hidden">
    <div class="table-wrap card">
  <div class="title">
    <span>Dashboard nhân sự</span>
    <div>
      <button id="btnResetFilters" class="btn-action" title="Reset tất cả bộ lọc">Reset Filters</button>
      <button id="btnExportXlsx" class="btn-action" title="Tải Excel">Export Excel</button>
    </div>
  </div>


      <div class="table-container">
        <table class="table" id="tbl-dashboard">
          <thead>
            <tr>
              <th class="sticky">STT</th>
              <th class="sticky">Nhà Thầu <button class="filter-btn" data-col="vendor_name" title="Lọc">⏷</button></th>
              <th class="sticky">Mã Vendor <button class="filter-btn" data-col="vendor_code" title="Lọc">⏷</button></th>
              <th class="sticky">Mã WFM <button class="filter-btn" data-col="wfm_code" title="Lọc">⏷</button></th>
              <th class="sticky">Mã WMS <button class="filter-btn" data-col="wms_user_id" title="Lọc">⏷</button></th>
              <th class="sticky tbl-col-fullname">Họ và Tên <button class="filter-btn" data-col="fullname" title="Lọc">⏷</button></th>
              <th class="sticky tbl-col-gender">Giới tính <button class="filter-btn" data-col="gender" title="Lọc">⏷</button></th>
              <th class="sticky">Năm sinh <button class="filter-btn" data-col="birth_year" title="Lọc">⏷</button></th>
              <th class="sticky">Shift In <button class="filter-btn" data-col="shift_in" title="Lọc">⏷</button></th>
              <th class="sticky">Nghỉ Trưa <button class="filter-btn" data-col="break_60" title="Lọc">⏷</button></th>
              <th class="sticky">Vào Ca Trưa <button class="filter-btn" data-col="break_60_in" title="Lọc">⏷</button></th>
              <th class="sticky">Nghỉ OT <button class="filter-btn" data-col="break_30" title="Lọc">⏷</button></th>
              <th class="sticky">Vào Ca OT <button class="filter-btn" data-col="break_30_in" title="Lọc">⏷</button></th>
              <th class="sticky">Shift Out <button class="filter-btn" data-col="shift_out" title="Lọc">⏷</button></th>
            </tr>
          </thead>
          <tbody id="tbody-dash">
          </tbody>
        </table>

        <div class="pager" id="dash-pager">
          <button id="dash-prev" class="btn-action" disabled="">«</button>
          <span class="page-info" id="dash-info">Trang 1 / 1 — 1 kết quả</span>
          <button id="dash-next" class="btn-action" disabled="">»</button>
          <span>Đến trang:</span>
          <input type="number" min="1" value="1" class="jump" id="dash-jump">
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Modal -->
  <div id="filterModal" class="filter-modal">
    <div class="filter-content">
      <h4 id="filterTitle">Lọc dữ liệu</h4>
      <div class="filter-search">
        <input type="text" id="filterSearch" placeholder="Tìm kiếm..." style="width: 100%; margin-bottom: 10px;">
      </div>
      <div id="filterOptions" class="filter-options"></div>
      <div class="filter-actions">
        <button id="filterClear">Xóa tất cả</button>
        <button id="filterCancel">Hủy</button>
        <button id="filterApply" class="btn-primary">Áp dụng</button>
      </div>
    </div>
  </div>

<!-- ========================== APP SCRIPT (có thể tách assets/app.js) ========================== -->
<script>
(() => {
  "use strict";

  /* ====================== CONFIG ====================== */
  const CONFIG = {
    API_BASE: window.API_BASE || ""   // same-origin
  };
  // Enable/disable extra QA verification before marking scan success
  // Set to true to call /wms/verify_scan API which should return { ok: true } when the scan is valid
  CONFIG.ENABLE_QA_CHECK = true;

  // ===== MODULAR SOUND SYSTEM =====
  let playOk, playErr, playCancel, playSysOk, playSysErr;

  // Dynamic import for sound system
  (async () => {
    try {
      const soundModule = await import('../static/js/sound-system.js');
      const STATIC_AUDIO_URLS = {
        "cancel.mp3":      "{{ url_for('static', filename='sounds/cancel.mp3') }}",
        "error.mp3":       "{{ url_for('static', filename='sounds/error.mp3') }}",
        "ok.mp3":          "{{ url_for('static', filename='sounds/ok.mp3') }}",
        "sys_error.mp3":   "{{ url_for('static', filename='sounds/sys_error.mp3') }}",
        "sys_success.mp3": "{{ url_for('static', filename='sounds/sys_success.mp3') }}"
      };
      await soundModule.initSounds(STATIC_AUDIO_URLS);
      playOk = soundModule.playOk;
      playErr = soundModule.playErr;
      playCancel = soundModule.playCancel;
      playSysOk = soundModule.playSysOk;
      playSysErr = soundModule.playSysErr;
    } catch (e) {
      console.warn('Failed to load sound system:', e);
      // Fallback to simple beep
      const fallbackBeep = () => console.beep?.() || console.log('beep');
      playOk = playErr = playCancel = playSysOk = playSysErr = fallbackBeep;
    }
  })();

  /* ====================== UTILS ====================== */

  // ==== Vendor code helpers ====
  // 10 ký tự, bắt đầu bằng "SP", phần còn lại chữ/số
  const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";

  /** Cập nhật các counter tổng từ raw RTDB */
  function renderBreakCounters(raw){
    const s = computeTaskStats(raw);

    // Nghỉ Trưa – 60'
    const b60   = document.getElementById("nt-b60");
    const b60in = document.getElementById("nt-b60in");
    if (b60)   b60.textContent   = s.total_b60;
    if (b60in) b60in.textContent = s.total_b60_in;
    document.querySelectorAll(".nt-totalin").forEach(el => el.textContent = s.total_in);

    // Nghỉ OT – 30'
    const b30   = document.getElementById("no-b30");
    const b30in = document.getElementById("no-b30in");
    if (b30)   b30.textContent   = s.total_b30;
    if (b30in) b30in.textContent = s.total_b30_in;
    document.querySelectorAll(".no-totalin").forEach(el => el.textContent = s.total_in);
  }

  /** Tính tổng và theo ca từ raw RTDB của ngày hiện tại */
  function computeTaskStats(raw){
    const byShift = {}; // {shift: { total_in, b60, b60_in, b30, b30_in }}

    for (const [shift, vendors] of Object.entries(raw || {})){
      const S = (byShift[shift] ||= { total_in:0, b60:0, b60_in:0, b30:0, b30_in:0 });
      for (const staffGroup of Object.values(vendors || {})){
        for (const s of Object.values(staffGroup || {})){
          if (!s) continue;

          if (hasVal(s.shift_in))      S.total_in++;
          if (hasVal(s.break_60))      S.b60++;
          if (hasVal(s.break_60_in))   S.b60_in++;
          if (hasVal(s.break_30))      S.b30++;
          if (hasVal(s.break_30_in))   S.b30_in++;
        }
      }
    }

    // Tổng toàn ngày
    let total_in=0, total_b60=0, total_b60_in=0, total_b30=0, total_b30_in=0;
    for (const sh of Object.keys(byShift)){
      const S = byShift[sh];
      total_in     += S.total_in;
      total_b60    += S.b60;
      total_b60_in += S.b60_in;
      total_b30    += S.b30;
      total_b30_in += S.b30_in;
    }

    return { byShift, total_in, total_b60, total_b60_in, total_b30, total_b30_in };
  }

  function findTodayRec(flat, staff_no){
    return flat.find(r => r.wfm_code?.toUpperCase() === staff_no.toUpperCase());
  }

  function safeFocus(id){
  // đợi DOM re-enable xong rồi mới focus
  setTimeout(()=>{
    const elv = document.getElementById(id);
    if(!elv) return;
    // đảm bảo không còn disabled/hidden
    elv.disabled = false;
    try{ elv.focus(); elv.select?.(); }catch(_){}
  }, 0); // có thể đổi 0 → 30–50ms nếu vẫn bị toast/transition cướp focus
}

  // Trả về lý do chặn (string) hoặc "" nếu hợp lệ
  function checkDuplicateByKeys(rec, action){
  const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";
  if(!rec) return "";

  if(action === "in"){
    if(hasVal(rec.shift_in)) return "Nhân viên này đã Scan In trong ngày rồi!";
  } else if(action === "out"){
    if(!hasVal(rec.shift_in)) return "Nhân viên này chưa Scan In, không thể Out.";
    if(hasVal(rec.shift_out) || hasVal(rec.gsheet_time_out)) return "Nhân viên này đã Scan Out trong ngày rồi!";
  } else if(action === "A0027"){           // mở 60'
    if(hasVal(rec.break_60)) return "Nhân viên đã vào ca sau giờ nghỉ trưa rồi.";
  } else if(action === "A0026"){           // mở 30'
    if(hasVal(rec.break_30)) return "Nhân viên đã vào ca sau giờ nghỉ OT rồi.";
  } else if(action === "A0020"){           // kết thúc break (vào ca)
    const open60 = hasVal(rec.break_60) && !hasVal(rec.break_60_in);
    const open30 = hasVal(rec.break_30) && !hasVal(rec.break_30_in);
    if (!open60 && !open30) return "Nhân viên này đã vào ca rồi.";
    if (open60 && open30)   return "Nhân viên này đã nghỉ giải lao rồi.";
    // ✅ Hợp lệ: đúng 1 loại đang mở → KHÔNG trả thông báo block
  }

  return "";
}

  const VENDOR_RE = /^SP[A-Z0-9]{8}$/i;
  const VANHANH_BASE = "https://vanhanh.shopee.vn";

  /** Nếu nhập mã vendor, tự ghép sang URL /spx-ops/wh/<code>; nếu là URL/QR thì giữ nguyên */
  function normalizeVendorOrQR(input) {
    const s = (input || "").trim();
    if (!s) return "";
    if (VENDOR_RE.test(s)) return `${VANHANH_BASE}/spx-ops/wh/${s.toUpperCase()}`;
    return s;
  }

  /** (tuỳ chọn) báo sớm nếu nhập sai định dạng vendor */
  function assertValidVendorOrQR(s){
    const v = (s||"").trim();
    if (!v) throw new Error("Vui lòng nhập/scan mã.");
    const looksUrl = /^https?:\/\//i.test(v) || v.includes("/");
    if (!looksUrl && !VENDOR_RE.test(v)) {
      // Không bắt buộc phải throw. Nếu muốn chặt chẽ thì mở comment dưới:
      // throw new Error("Mã Vendor phải 10 ký tự và bắt đầu bằng SP (vd: SP12345678).");
    }
    return v;
  }

  // ==== DOM helpers ====
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const el = (id)=>document.getElementById(id);

  const notice = (msg, kind="info", timeout=3000) => {
    const n = el("notice");
    if (!n) return;

    // If no message, clear content and styling and exit
    if (!msg) {
      n.textContent = "";
      n.removeAttribute("data-kind");
      return;
    }

    // Show message with kind
    n.dataset.kind = kind;
    n.textContent = msg;

    // Auto-clear after timeout: remove text and styling so background color doesn't linger
    if (notice._t) clearTimeout(notice._t);
    if (timeout > 0) {
      notice._t = setTimeout(() => {
        n.textContent = "";
        n.removeAttribute("data-kind");
      }, timeout);
    }
  };

  const todayKey = (d=new Date())=>{
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };

  const ceilToNext15 = ()=>{
    const d=new Date();
    let h=d.getHours(), m=d.getMinutes();
    let next=Math.floor(m/15)*15+15; if(next>=60){ next=0; h=(h+1)%24; }
    const use30=(next===0||next===15)?"00":"30";
    return {h, use30};
  };

  const toVendorCode = (input)=>{
    const s=(input||"").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)){
      try{ const u=new URL(s); const parts=u.pathname.split('/').filter(Boolean); return parts.pop(); }catch{ return s; }
    }
    if(s.includes("/")){ const parts=s.split('/').filter(Boolean); return parts.pop(); }
    return s;
  };

  const imgFromUrl = async (url)=>{
    try{ const r=await fetch(url); if(!r.ok) return ""; return URL.createObjectURL(await r.blob()); }catch{ return ""; }
  };

  function setBusy(on){ document.documentElement.classList.toggle('busy', !!on); }
  function setAllDisabled(disabled=true){
  const dayLocked = document.body.dataset.dayLock === "1";
  const finalDisabled = disabled || dayLocked; // nếu dayLocked thì luôn giữ disable

  ["in-wfm","btnScanIn","task-wfm","btnScanTask","out-wfm","btnScanOut"].forEach(id=>{
    const n = document.getElementById(id);
    if (!n) return;
    n.disabled = finalDisabled;
    n.style.opacity = finalDisabled ? "0.6" : "1";
    n.style.cursor  = finalDisabled ? "not-allowed" : "pointer";
  });
}

  function scheduleShiftAutoAdvance(){
    const apply=()=>{
      const {h,use30}=ceilToNext15();
      const hourEl=el('hour'), minuteEl=el('minute');
      if(hourEl && minuteEl){
        const hh=String(+h).padStart(2,'0');
        if(hourEl.value!==hh) hourEl.value=hh;
        if(minuteEl.value!==use30) minuteEl.value=use30;
      }
      const now=new Date();
      const msToNextMinute=60000-(now.getSeconds()*1000+now.getMilliseconds());
      setTimeout(apply, msToNextMinute);
    };
    apply();
  }

  // ==== Day lock helpers ====
  function isTodayStr(yyyy_mm_dd){
    if (!/^\d{4}-\d{2}-\d{2}$/.test(yyyy_mm_dd||"")) return false;
    return yyyy_mm_dd === todayKey();
  }

  // Khóa quét nếu chọn khác hôm nay (past/future)
  function applyDayLock(){
    const dp = document.getElementById('dayPicker');
    const locked = dp && !isTodayStr(dp.value);
    document.body.dataset.dayLock = locked ? "1" : "0";

    // Chỉ tác động tới các control quét
    const ids = ["in-wfm","btnScanIn","task-wfm","btnScanTask","out-wfm","btnScanOut"];
    ids.forEach(id=>{
      const n = document.getElementById(id);
      if (!n) return;
      n.disabled = !!locked;
      n.style.opacity = locked ? "0.6" : "1";
      n.style.cursor  = locked ? "not-allowed" : "pointer";
    });

    if (locked) {
      notice("Đang xem ngày cũ (hoặc khác hôm nay) — đã tắt chức năng quét.", "warning", 6000);
    }
  }


  /* ====================== SERVICES (API/BE) ====================== */
  async function callWms(path, payload){
    const url = `${CONFIG.API_BASE}${path}`;
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });
    const text = await r.text();
    let data={}; try{ data=JSON.parse(text);}catch{}
    if(!r.ok){
      console.error("[callWms]", url, {payload, status:r.status, text});
      const serverMsg=(data&&(data.message||data.error))||text.slice(0,300);
      throw new Error(`HTTP ${r.status} – ${serverMsg}`);
    }
    if(typeof data.retcode!=="undefined" && data.retcode!==0){
      console.error("[callWms-retcode]", data);
      throw new Error(`retcode=${data.retcode} – ${(data.message||"")}`);
    }
    return data;
  }

  async function fetchStaffByVendor(vendorCodeInput) {
    // Cho phép nhập SP******** hoặc URL
    const normalized = normalizeVendorOrQR(vendorCodeInput);
    const vendorCode = toVendorCode(normalized);
    if (!vendorCode) throw new Error("Vendor code trống");

    const url = `${window.API_BASE || ""}/wms/info/${encodeURIComponent(vendorCode)}`;
    const r = await fetch(url, { method: "GET" });
    let j = {};
    try { j = await r.json(); } catch { j = {}; }

    // ❗ Chỉ throw khi HTTP lỗi. KHÔNG throw khi j.ok === false
    if (!r.ok) throw new Error(`HTTP ${r.status}`);

    // Lấy info dù j.ok false (để hiển thị sớm)
    const base = j.all_info || {};
    const info = {
      full_name:  j.full_name  ?? base.full_name  ?? "",
      contractor: j.contractor ?? base.contractor ?? "",
      gender:     j.gender     ?? base.gender     ?? "",
      birth_year: j.birth_year ?? base.birth_year ?? "",
      staff_id:   j.staff_id   ?? base.staff_id   ?? "",
    };

    // wfm có thể nằm ở nhiều key khác nhau (tùy trang/parser)
    const staff_no =
      j.wfm || j.vac_number || j.vacc_number || base.wfm || base.vac_number || base.vacc_number || "";

    const img_url = j.profile_image_url || base.profile_image_url || "";

    return { staff_no, info, img_url };
  }


  async function parseQR(inputCode){
    const code=(inputCode||"").trim();
    if(!code) throw new Error("Mã trống");
    try{
      const data=await fetchStaffByVendor(code);
      window.currentStaff = data;
      return data;
    }catch(e){
      return { staff_no: code, info:{}, img_url:"" };
    }
  }

  /* ====================== DATA (RTDB helpers) ====================== */
  const rtdbDayPath = (wh, day=todayKey()) => `${window.__firebaseDB.databaseURL}/${wh}/${day}.json`;
  const rtdbRecPath = (wh, day, shift, vendor, wfm) =>
    `${window.__firebaseDB.databaseURL}/${wh}/${day}/${encodeURIComponent(shift)}/${encodeURIComponent(vendor)}/${encodeURIComponent(wfm)}.json`;

  async function fetchRTDBAll(wh, day=todayKey()){
    const r = await fetch(rtdbDayPath(wh, day));
    return (await r.json()) || {};
  }

  function flattenRecords(records){
    const flat=[];
    for(const [shift, group] of Object.entries(records||{})){
      for(const [vendor_name, staff_group] of Object.entries(group||{})){
        for(const [wfm, info] of Object.entries(staff_group||{})){
          flat.push({...info, shift, vendor_name, wfm_code:wfm});
        }
      }
    }
    return flat;
  }

  function computeCounts(raw){
    let total_in=0, total_out=0;
    for(const group of Object.values(raw||{})){
      for(const staff_group of Object.values(group||{})){
        const arr=Object.values(staff_group||{});
        total_in += arr.length;
        for(const s of arr){ if(s.gsheet_time_out || s.type==="done") total_out++; }
      }
    }
    return {total_in, total_out, raw};
  }

  function computeTaskFromRaw(raw){
    const byShift={}; let break60=0, break30=0;
    for (const [shift, vendors] of Object.entries(raw||{})){
      const S=(byShift[shift] ||= { totalIn:0, b60:0, b30:0 });
      for (const staffGroup of Object.values(vendors||{})){
        for (const s of Object.values(staffGroup||{})){
          if(!s) continue;
          const is60=!!s.break_60 && !s.break_60_in;
          const is30=!!s.break_30 && !s.break_30_in;
          S.totalIn++;
          if(is60){ S.b60++; break60++; }
          if(is30){ S.b30++; break30++; }
        }
      }
    }
    return { byShift, break60, break30 };
  }

  /* ====================== UI ====================== */
  function setActiveTab(name){
    $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    const want='tab-'+name;
    $$('.tab-panel').forEach(p=>p.classList.toggle('is-hidden', p.id!==want));
  }

  function setPersonUI(prefix, info, img){
    el(`${prefix}-fullname`).textContent    =(info.full_name||"").toUpperCase();
    el(`${prefix}-vendor`).textContent      =(info.contractor||"").toUpperCase();
    el(`${prefix}-vendor-code`).textContent =(info.staff_id||"").toUpperCase();
    el(`${prefix}-gender`).textContent      =(info.gender||"").toUpperCase();
    el(`${prefix}-birth`).textContent       =(info.birth_year||"");
    const imgEl = el(`${prefix}-avatar`);
    if (imgEl) imgEl.src = img || "";
  }

  function renderInCounters(stats){
    const raw = stats.raw || {};
    el("in-total").textContent = `Total Scan In: ${stats.total_in || 0}`;

    // Helper: map vendor name to canonical columns
    const canonVendors = ["Agari", "MBB", "GRG", "HTVN"];
    const toCanon = (name) => {
      const s = String(name || "").toUpperCase();
      if (s.includes("AGARI")) return "Agari";
      if (s.includes("MBB"))   return "MBB";
      // Handle both GRG and GRGR
      if (s.includes("GRGR") || s === "GRG" || s.includes(" GRG")) return "GRG";
      if (s.includes("HTVN"))  return "HTVN";
      return null; // ignore others in this table
    };

    // Build per-shift rows
    const shifts = Object.keys(raw).sort((a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true}));
    const rows = [];
    let grand = { Agari:0, MBB:0, GRG:0, HTVN:0 };

    for (const sh of shifts) {
      const group = raw[sh] || {};
      const counts = { Agari:0, MBB:0, GRG:0, HTVN:0 };
      for (const [vn, sg] of Object.entries(group)) {
        const canon = toCanon(vn);
        if (!canon) continue;
        counts[canon] += Object.keys(sg || {}).length;
      }
      grand.Agari += counts.Agari;
      grand.MBB   += counts.MBB;
      grand.GRG   += counts.GRG;
      grand.HTVN  += counts.HTVN;
      const total = counts.Agari + counts.MBB + counts.GRG + counts.HTVN;
      rows.push([sh, counts.Agari, counts.MBB, counts.GRG, counts.HTVN, total]);
    }

    // Render grid table into #in-shifts
    // Display label tweak: show 'GRGR' instead of 'GRG' without changing logic keys
    const hdr = ["Ca", ...canonVendors.map(v => v === "GRG" ? "GRGR" : v), "Total"]; // 6 columns
  const thead = `<thead><tr>${hdr.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
  const fmt0 = (v) => (Number(v) === 0 ? "-" : v);
  const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=> i===0?`<td>${c}</td>`:`<td style=\"text-align:center\">${fmt0(c)}</td>`).join("")}</tr>`).join("")}</tbody>`;
  const gTotal = grand.Agari + grand.MBB + grand.GRG + grand.HTVN;
  const tfoot = `<tfoot><tr><th>Grand Total</th><th style=\"text-align:center\">${fmt0(grand.Agari)}</th><th style=\"text-align:center\">${fmt0(grand.MBB)}</th><th style=\"text-align:center\">${fmt0(grand.GRG)}</th><th style=\"text-align:center\">${fmt0(grand.HTVN)}</th><th style=\"text-align:center\">${fmt0(gTotal)}</th></tr></tfoot>`;
    const tableHtml = `<table class="table">${thead}${tbody}${tfoot}</table>`;
    el("in-shifts").innerHTML = tableHtml;

    // Clear old overall vendor stats under the grid (redundant now)
    const overall = el("in-vendor-stats");
    if (overall) { overall.innerHTML = ""; }
  }

  function renderOutCounters(stats){
    const raw = stats.raw || {};

    // Canonical vendor mapping to align with In grid
    const canonVendors = ["Agari", "MBB", "GRG", "HTVN"];
    const toCanon = (name) => {
      const s = String(name || "").toUpperCase();
      if (s.includes("AGARI")) return "Agari";
      if (s.includes("MBB"))   return "MBB";
      if (s.includes("GRG") || s === "GRG" || s.includes(" GRG")) return "GRG";
      if (s.includes("HTVN"))  return "HTVN";
      return null;
    };

    const shifts = Object.keys(raw).sort((a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true}));
    const rows = [];
    let grand = { Agari:{in:0,out:0}, MBB:{in:0,out:0}, GRG:{in:0,out:0}, HTVN:{in:0,out:0} };
    let totIn=0, totOut=0;

    for(const sh of shifts){
      const group = raw[sh] || {};
      const counts = { Agari:{in:0,out:0}, MBB:{in:0,out:0}, GRG:{in:0,out:0}, HTVN:{in:0,out:0} };
      for(const [vn, sg] of Object.entries(group)){
        const canon = toCanon(vn);
        if(!canon) continue;
        const staff = Object.values(sg || {});
        const inN   = staff.length;
        const outN  = staff.filter(s => s && (s.gsheet_time_out || s.type === "done")).length;
        counts[canon].in  += inN;
        counts[canon].out += outN;
      }
      grand.Agari.in += counts.Agari.in; grand.Agari.out += counts.Agari.out;
      grand.MBB.in   += counts.MBB.in;   grand.MBB.out   += counts.MBB.out;
      grand.GRG.in   += counts.GRG.in;   grand.GRG.out   += counts.GRG.out;
      grand.HTVN.in  += counts.HTVN.in;  grand.HTVN.out  += counts.HTVN.out;

      const rowVendorCells = canonVendors.map(v => {
        const c = counts[v] || { in: 0, out: 0 };
        return `${c.out}/${c.in}`;
      });
      const inSum  = counts.Agari.in + counts.MBB.in + counts.GRG.in + counts.HTVN.in;
      const outSum = counts.Agari.out + counts.MBB.out + counts.GRG.out + counts.HTVN.out;
      totIn += inSum; totOut += outSum;
      rows.push([sh, ...rowVendorCells, `${outSum}/${inSum}`]);
    }

  // Render grid table for Out: each cell is out/in
  // Display label tweak: show 'GRGR' instead of 'GRG' without changing logic keys
  const hdr = ["Ca", ...canonVendors.map(v => v === "GRG" ? "GRGR" : v), "Total"]; // 6 columns
    const thead = `<thead><tr>${hdr.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
    const fmtPair = (a,b) => ((a===0 && b===0) ? "-" : `${a}/${b}`);
    const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=> {
      if(i===0) return `<td>${c}</td>`;
      const parts = String(c).split('/').map(x=>Number(x)||0);
      return `<td style=\"text-align:center\">${fmtPair(parts[0], parts[1])}</td>`;
    }).join("")}</tr>`).join("")}</tbody>`;
    const gIn  = grand.Agari.in + grand.MBB.in + grand.GRG.in + grand.HTVN.in;
    const gOut = grand.Agari.out + grand.MBB.out + grand.GRG.out + grand.HTVN.out;
  const tfoot = `<tfoot><tr><th>Grand Total</th><th style=\"text-align:center\">${fmtPair(grand.Agari?.out||0,grand.Agari?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.MBB?.out||0,grand.MBB?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.GRG?.out||0,grand.GRG?.in||0)}</th><th style=\"text-align:center\">${fmtPair(grand.HTVN?.out||0,grand.HTVN?.in||0)}</th><th style=\"text-align:center\">${fmtPair(gOut,gIn)}</th></tr></tfoot>`;
    const tableHtml = `<table class=\"table\">${thead}${tbody}${tfoot}</table>`;
    el("out-shifts").innerHTML = tableHtml;
    el("out-total").textContent = `Total Scan Out: ${totOut} / ${totIn}`;

    const overall = el("out-vendor-stats");
    if (overall) { overall.innerHTML = ""; }
  }

  // Dashboard
  const DASH = { rows:[], filtered:[], page:1, pageSize:50, filters:{} };

  function normalizeDashRow(r){
    return {
      vendor_name:     r.vendor_name || "",
      vendor_code:     (r.vendor_code || r.vendorCode || r.vendor_id || "").toString().toUpperCase(),
      wfm_code:        r.wfm_code || "",
      wms_user_id:     (r.wms_user_id || "").toString(),
      operator:        (r.operator || "").toString().toUpperCase(),
      fullname:        (r.fullname || r.full_name || "").toString().toUpperCase(),
      gender:          (r.gender || "").toString().toUpperCase(),
      shift_in:        r.shift_in || r.shift || "",
      shift_out:       r.shift_out || "",
      birth_year:      r.birth_year || "",
      gsheet_time_in:  r.gsheet_time_in || "",
      break_60:        r.break_60 || "",
      break_60_in:     r.break_60_in || "",
      break_30:        r.break_30 || "",
      break_30_in:     r.break_30_in || "",
      gsheet_time_out: r.gsheet_time_out || ""
    };
  }

  function renderDashboardList(raw){
    const flat=flattenRecords(raw);
    // Always sort by gsheet_time_in (newest first), robust to empty/invalid strings
    const num = (s)=>{
      const t = Date.parse(s || "");
      return Number.isFinite(t) ? t : 0;
    };
    flat.sort((b,a)=> num(b.gsheet_time_in) - num(a.gsheet_time_in));
    DASH.rows = flat.map(normalizeDashRow);
    DASH.page = 1;
    applyDashFiltersAndRender();
  }

  function applyDashFiltersAndRender(){
    const fs=DASH.filters||{};
    const q=v=>String(v||"").toLowerCase();
    DASH.filtered = DASH.rows.filter(row=>{
      for(const [k,val] of Object.entries(fs)){
        if(!val) continue;
        if(!q(row[k]).includes(q(val))) return false;
      }
      return true;
    });
    renderDashTable();
  }

  function renderDashTable(){
    const body=el("tbody-dash"); if(!body) return;
    body.innerHTML="";
    const total=DASH.filtered.length, ps=DASH.pageSize||50;
    const maxPage=Math.max(1, Math.ceil(total/ps));
    if(DASH.page>maxPage) DASH.page=maxPage;
    const start=(DASH.page-1)*ps, end=Math.min(start+ps,total);
    const slice=DASH.filtered.slice(start,end);

    for(let i=0;i<slice.length;i++){
      const r=slice[i];
      const stt=start+i+1;
      const tr=document.createElement("tr");
      const cells = [
        { cls: '', value: stt },
        { cls: '', value: r.vendor_name },
        { cls: '', value: r.vendor_code },
        { cls: '', value: r.wfm_code },
        { cls: '', value: r.wms_user_id },
        { cls: 'tbl-col-fullname', value: r.fullname },
        { cls: 'tbl-col-gender', value: r.gender },
        { cls: '', value: r.birth_year },
        { cls: '', value: r.shift_in },  // Shift in (replaces Time in)
        { cls: '', value: r.break_60 },        // Nghỉ Trưa
        { cls: '', value: r.break_60_in },     // Vào Ca Trưa
        { cls: '', value: r.break_30 },        // Nghỉ OT
        { cls: '', value: r.break_30_in },     // Vào Ca OT
        { cls: '', value: r.shift_out }  // Shift out (replaces Time Out)
      ];
      tr.innerHTML = cells.map(c => `<td class="${c.cls}">${c.value ?? ""}</td>`).join("");
      body.appendChild(tr);
    }

    const info=el("dash-info"); if(info) info.textContent=`Trang ${DASH.page} / ${maxPage} — ${total} kết quả`;
    const jump=el("dash-jump"); if(jump) jump.value=DASH.page;
    const prev=el("dash-prev"), next=el("dash-next");
    if(total<=ps){
      prev && (prev.disabled=true);
      next && (next.disabled=true);
      DASH.page=1;
      if(jump) jump.value=1;
    }else{
      prev && (prev.disabled = (DASH.page<=1));
      next && (next.disabled = (DASH.page>=maxPage));
    }
  }

  function renderTaskRightCards(raw){
    const s = computeTaskStats(raw);

    // Update headers
    const h60 = el('task60-card')?.querySelector('h3');
    const h30 = el('task30-card')?.querySelector('h3');
    if (h60) h60.textContent = `Nghỉ Trưa: ${s.total_b60} / Vào Ca: ${s.total_b60_in} / Total: ${s.total_in}`;
    if (h30) h30.textContent = `Nghỉ OT: ${s.total_b30} / Vào Ca: ${s.total_b30_in} / Total: ${s.total_in}`;

    // Hide legacy blocks
    el('task60-total')?.classList.add('is-hidden');
    el('task30-total')?.classList.add('is-hidden');

    // Canonical vendor mapping
    const canonVendors = ["Agari", "MBB", "GRG", "HTVN"];
    const toCanon = (name) => {
      const s = String(name || "").toUpperCase();
      if (s.includes("AGARI")) return "Agari";
      if (s.includes("MBB"))   return "MBB";
      if (s.includes("GRG") || s === "GRG" || s.includes(" GRG")) return "GRG";
      if (s.includes("HTVN"))  return "HTVN";
      return null;
    };

    const shifts = Object.keys(raw || {}).sort((a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true}));

    // Build tables for 60' and 30'
    function buildTable(kind){
      // kind: '60' or '30'
      const rows = [];
      const grand = { Agari:{a:0,b:0,in:0}, MBB:{a:0,b:0,in:0}, GRG:{a:0,b:0,in:0}, HTVN:{a:0,b:0,in:0} };
      for (const sh of shifts){
        const group = raw[sh] || {};
        const counts = { Agari:{a:0,b:0,in:0}, MBB:{a:0,b:0,in:0}, GRG:{a:0,b:0,in:0}, HTVN:{a:0,b:0,in:0} };
        for (const [vn, sg] of Object.entries(group)){
          const canon = toCanon(vn); if(!canon) continue;
          const staff = Object.values(sg || {});
          // a = total break opened, b = total returned, in = total scan in of that vendor/shift
          let a=0, b=0, inN=0;
          inN = staff.length;
          if (kind === '60') {
            a = staff.filter(s => !!(s && s.break_60)).length;
            b = staff.filter(s => !!(s && s.break_60_in)).length;
          } else {
            a = staff.filter(s => !!(s && s.break_30)).length;
            b = staff.filter(s => !!(s && s.break_30_in)).length;
          }
          counts[canon].a  += a; counts[canon].b  += b; counts[canon].in += inN;
        }
        // accumulate grand totals
        for (const v of canonVendors){ grand[v].a += counts[v].a; grand[v].b += counts[v].b; grand[v].in += counts[v].in; }
        const sumA  = canonVendors.reduce((t,v)=> t + counts[v].a , 0);
        const sumB  = canonVendors.reduce((t,v)=> t + counts[v].b , 0);
        const sumIn = canonVendors.reduce((t,v)=> t + counts[v].in, 0);
        // cell text order: nghỉ/vao/scan-in
        rows.push([sh, ...canonVendors.map(v => `${counts[v].a}/${counts[v].b}/${counts[v].in}`), `${sumA}/${sumB}/${sumIn}`]);
      }

  // Display label tweak: show 'GRGR' instead of 'GRG' without changing logic keys
  const hdr = ["Ca", ...canonVendors.map(v => v === "GRG" ? "GRGR" : v), "Total"];
      const thead = `<thead><tr>${hdr.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
      const fmtTriple = (a,b,iN) => ((a===0 && b===0 && iN===0) ? '-' : `${a}/${b}/${iN}`);
      const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=> {
        if(i===0) return `<td>${c}</td>`;
        const parts = String(c).split('/').map(x=>Number(x)||0);
        return `<td style=\"text-align:center\">${fmtTriple(parts[0], parts[1], parts[2]||0)}</td>`;
      }).join('')}</tr>`).join('')}</tbody>`;
      const gA  = canonVendors.reduce((t,v)=> t + grand[v].a , 0);
      const gB  = canonVendors.reduce((t,v)=> t + grand[v].b , 0);
      const gIn = canonVendors.reduce((t,v)=> t + grand[v].in, 0);
      const tfoot = `<tfoot><tr><th>Grand Total</th>${canonVendors.map(v=>`<th style=\"text-align:center\">${fmtTriple(grand[v].a,grand[v].b,grand[v].in)}</th>`).join('')}<th style=\"text-align:center\">${fmtTriple(gA,gB,gIn)}</th></tr></tfoot>`;
      return `<table class=\"table\">${thead}${tbody}${tfoot}</table>`;
    }

    const s60 = el('task60-shifts');
    const s30 = el('task30-shifts');
    if (s60) s60.innerHTML = buildTable('60');
    if (s30) s30.innerHTML = buildTable('30');
  }

  /* ====================== CONTROLLERS ====================== */
  async function doScan(direction){
  const wh = el("warehouse").value;
  const hh = String(+el("hour").value).padStart(2,"0");
  const mm = el("minute").value === "30" ? "30" : "00";
  const shiftTime = `${hh}:${mm}`;

  if (direction === "in") {
    el("in-operator").textContent = "?";
    el("in-wmsid").textContent = "?";
    const wfmText = el("in-wfm").value.trim();

    if (!wfmText){
      notice("Vui lòng scan QR, hoặc nhập mã Vendor (SP********) / WFM.", "error");
      playSysErr();
      return;
    }
    setBusy(true);

    try{
      setAllDisabled(true);

      const { staff_no, info, img_url } = await parseQR(wfmText);

      // Hiển thị ngay sau parse
      setPersonUI("in", info, img_url ? await imgFromUrl(img_url) : "");

      // Không có staff_no thì dừng (không ném lỗi để UI giữ thông tin)
      if (!staff_no){
        notice("Không lấy được WFM từ vendor. Vui lòng kiểm tra mã/QR hoặc thử lại.", "error", 5000);
        playSysErr();
        return;
      }

      // ⛔ Chặn Scan In trùng theo key (shift_in đã có giá trị)
      {
        const raw  = await fetchRTDBAll(wh, todayKey());
        const flat = flattenRecords(raw);
        const rec  = findTodayRec(flat, staff_no);
        const msg  = checkDuplicateByKeys(rec, "in");
        if (msg){
          notice(msg, "error", 5000);
          playSysErr();
          return;
        }
      }

      // Optional QA verification: don't mark scanned unless QA API confirms
      if (CONFIG.ENABLE_QA_CHECK) {
        try {
          const qa = await callWms('/wms/verify_scan', { vendor_url: wfmText, staff_no });
          if (!qa || qa.ok !== true) {
            notice('Scan chưa được xác nhận bởi QA API.', 'error', 5000);
            playSysErr();
            return;
          }
        } catch (e) {
          notice('Lỗi khi kiểm tra QA: ' + (e.message || e), 'error', 5000);
          playSysErr();
          return;
        }
      }

      // Gọi attendance & activity khi đã có staff_no
      await callWms("/wms/attendance", { warehouse: wh, type: 1, staff_no });
      const act = await callWms("/wms/activity", { warehouse: wh, staff_no, act_no: "A0020" });
      const operator    = act?.data?.staff_name || "";
      const wms_user_id = act?.data?.wms_user_id || "";

  el("in-operator").textContent = (operator || "?").toUpperCase();
  el("in-wmsid").textContent    = wms_user_id || "?";

      const now = new Date();
      const gsheet_time_in = now.toLocaleString("en-GB", {
        hour12:false, day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).replace(",", "");

      const rec = {
        type:"in",
        wfm_code: staff_no,
        fullname: info.full_name || "",
        vendor_name: info.contractor || "",
        shift_in: shiftTime,
        date: todayKey(),
        gender: info.gender || "",
        vendor_code: info.staff_id || "",
        birth_year: info.birth_year || "",
        operator, wms_user_id, gsheet_time_in
      };

      const path = rtdbRecPath(wh, todayKey(), rec.shift_in, rec.vendor_name || "", rec.wfm_code || "");
      await fetch(path, { method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(rec) });

      setPersonUI("in", info, img_url ? await imgFromUrl(img_url) : "");
      notice(`✅ ${rec.fullname || ""} scan in ${now.toTimeString().slice(0,8)}`, "success", 6000);
      playSysOk();
      el("in-wfm").value = "";
      el("in-wfm").focus();
    }catch(e){
      notice(`Scan in lỗi: ${e.message || e}`, "error", 5000);
      playSysErr();
    }finally{
      setAllDisabled(false);
      setBusy(false);
      safeFocus("in-wfm");
    }
    return;
  }

  if (direction === "task") {
    el("task-operator").textContent = "?";
    el("task-wmsid").textContent = "?";

    try {
      setAllDisabled(true);

      const qr = el("task-wfm").value.trim();
      const rawTask = assertValidVendorOrQR(qr);          // để trong try
      const act_no  = el("task-type").value;

      const { staff_no, info, img_url } = await parseQR(rawTask);

      // Hiển thị NGAY sau parse
      setPersonUI("task", info, img_url ? await imgFromUrl(img_url) : "");

      if (!staff_no) {
        notice("Không lấy được WFM từ vendor. Vui lòng kiểm tra mã/QR hoặc thử lại.", "error", 5000);
        playSysErr();
        return;
      }

      // ---- Fetch RTDB 1 lần, tìm record trong ngày
      const raw  = await fetchRTDBAll(wh, todayKey());
      const flat = flattenRecords(raw);
      const rec  = findTodayRec(flat, staff_no);

      // Helper cục bộ
      const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";

      // 1) Bắt buộc: đã In và CHƯA Out
      const isIn  = rec && hasVal(rec.shift_in);
      const isOut = rec && (hasVal(rec.shift_out) || hasVal(rec.gsheet_time_out));
      if (!isIn || isOut) {
        notice("Staff chưa scan in hoặc đã scan out!", "error", 5000);
        playSysErr();
        return;
      }

      // 2) Chặn trùng theo key (key nào đã có giá trị thì block)
      {
        const msg = checkDuplicateByKeys(rec, act_no);
        if (msg) {
          notice(msg, "error", 5000);
          playSysErr();
          return;
        }
      }

      // 3) Xử lý theo loại task
      const now = new Date();
      const task_time = now.toTimeString().slice(0,8);   // HH:MM:SS
      let field_name = null;
      let resp = null;

      if (act_no === "A0020") {
        const open60 = hasVal(rec.break_60) && !hasVal(rec.break_60_in);
        const open30 = hasVal(rec.break_30) && !hasVal(rec.break_30_in);

        if (!open60 && !open30) {
          throw new Error("Không có break nào đang mở để kết thúc.");
        }
        if (open60 && open30) {
          throw new Error("Đang mở đồng thời break 60' và 30'. Vui lòng xử lý thủ công.");
        }

        field_name = open60 ? "break_60_in" : "break_30_in";

        // Gọi API kết thúc break
        resp = await callWms("/wms/activity", { warehouse: wh, act_no: "A0020", staff_no });
        } else {
        // Mở break: A0027 (60) / A0026 (30)
        field_name = ({ "A0027":"break_60", "A0026":"break_30" })[act_no];

        resp = await callWms("/wms/activity", { warehouse: wh, act_no, staff_no });
      }

      // 4) Ghi PATCH lên RTDB (ghi theo cấu trúc shift → vendor → wfm)
      const patch = {}; patch[field_name] = task_time;
      const url = rtdbRecPath(
        wh,
        todayKey(),
        rec.shift_in || rec.shift || "",      // node ca
        rec.vendor_name || "",                // node vendor
        rec.wfm_code || ""                    // node mã WFM
      );
      await fetch(url, {
        method: "PATCH",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(patch)
      });

      // 5) UI done
  notice(`✅ ${(resp?.data?.staff_name || info?.full_name || "")} ${task_time}`, "success", 5000);
  playSysOk();
  el("task-operator").textContent = (resp?.data?.staff_name || "").toUpperCase();
  el("task-wmsid").textContent    = resp?.data?.wms_user_id || "";

      // (tuỳ chọn) refresh KPI & bảng break_60/break_30 tại đây
      // renderBreakTables(...);
    } catch (e) {
      console.error(e);
      notice(`Task lỗi: ${e.message || e}`, "error", 5000);
      playSysErr();
    } finally {
      setAllDisabled(false);
      safeFocus("task-wfm");
    }
    return;
  }

  if (direction === "out") {
    el("out-operator").textContent = "?";
    el("out-wmsid").textContent = "?";
    const wfmText = el("out-wfm").value.trim();
    const rawOut  = assertValidVendorOrQR(wfmText);

    if (!rawOut) {
      notice("Vui lòng nhập/scan mã WFM.", "error");
      playSysErr();
      return;
    }

    try {
      setAllDisabled(true);
      const { staff_no, info, img_url } = await parseQR(rawOut);
      setPersonUI("out", info, img_url ? await imgFromUrl(img_url) : "");

      if (!staff_no){
        notice("Không lấy được WFM từ vendor. Vui lòng kiểm tra mã/QR hoặc thử lại.", "error", 5000);
        playSysErr();
        el("out-wfm").value = ""; safeFocus("out-wfm");
        return;}

      const raw  = await fetchRTDBAll(wh, todayKey());
      const flat = flattenRecords(raw);
      const rec  = findTodayRec(flat, staff_no);

      // helper
      const hasVal = v => v !== undefined && v !== null && String(v).trim() !== "";

      // Bắt buộc đã In và chưa Out
      const isIn  = rec && hasVal(rec.shift_in);
      const isOut = rec && (hasVal(rec.shift_out) || hasVal(rec.gsheet_time_out));
      if (!isIn || isOut) {
        notice("Nhân viên này chưa Scan In trước đó hoặc đã Scan Out.", "error", 5000);
        playSysErr();
        return;
      }

      // Chặn trùng theo key cho Out (shift_out đã có)
      {
        const msg = checkDuplicateByKeys(rec, "out");
        if (msg){
          notice(msg, "error", 5000);
          playSysErr();
          return;
        }
        el("out-wfm").value = ""; safeFocus("out-wfm");
      }

      // Set UI từ record
      setPersonUI("out", info || rec, img_url ? await imgFromUrl(img_url) : "");
  el("out-operator").textContent = (rec.operator || "").toUpperCase();
      el("out-wmsid").textContent    = rec.wms_user_id || "";

      // Attendance Out
      await callWms("/wms/attendance", { warehouse: wh, type: 2, staff_no });

      const now = new Date();
      const shift_out = `${String(+el("hour").value).padStart(2,"0")}:${el("minute").value==="30" ? "30" : "00"}`;
      const gsheet_time_out = now.toLocaleString("en-GB", {
        hour12:false, day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      }).replace(",", "");

      const patch = { shift_out, gsheet_time_out, type:"done" };
      const url = rtdbRecPath(
        wh,
        todayKey(),
        rec.shift_in || rec.shift,
        rec.vendor_name || "",
        rec.wfm_code || ""
      );
      await fetch(url, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(patch) });

      notice(`✅ ${(info?.full_name || rec.fullname || "")} scan out ${now.toTimeString().slice(0,8)}`, "success", 5000);
      playSysOk();
      el("out-wfm").value = "";

    }catch(e){
      notice(`Scan out lỗi: ${e.message || e}`, "error", 5000);
      playSysErr();
    }finally{
      setAllDisabled(false);
      setBusy(false);
      safeFocus("out-wfm");
    }
    return;
  }
}


  /* ====================== REALTIME (Firebase) ====================== */
  // module type="module" để import SDK sẽ tiện hơn; ở đây mình tối giản: SDK import ở cuối bằng type=module
  window.__startRealtimeAll = function(db){
    let detach=null;
    function start(){
      const wh = el('warehouse')?.value || 'VNDB';
      const dp = el('dayPicker');
      const day = (dp?.value && /^\d{4}-\d{2}-\d{2}$/.test(dp.value)) ? dp.value : todayKey();
      applyDayLock();   // <<< gọi ngay khi đổi ngày/kho

      if(detach){ try{ detach(); }catch{} detach=null; }
      setBusy(true);

      const { ref, onValue } = window.__firebaseDB;
      const r = ref(db, `${wh}/${day}`);
      console.debug("[Realtime] Listen:", `${wh}/${day}`);

      detach = onValue(
        r,
        (snap)=>{
          const val=snap.val()||{};
          const stats=computeCounts(val);
          renderInCounters(stats);
          renderOutCounters(stats);
          renderTaskRightCards(val);
          renderDashboardList(val);
          setBusy(false);
        },
        (err)=>{
          console.error("[Realtime] error:", err);
          notice("Lỗi kết nối Firebase!", "error", 3000);
          playSysErr();
          setBusy(false);
        }
      );
    }
    el('dayPicker')?.addEventListener('change', start);
    el('warehouse')?.addEventListener('change', start);
    window.addEventListener('load', start);

    // Start immediately once configured so UI updates without requiring extra navigation
    try { start(); } catch(e){ console.warn('Realtime start failed (will retry on load/change):', e); }
  };

  /* ====================== INIT ====================== */
  function bindEvents(){
    // Tabs
    const tabs = el('tabs');
    tabs?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab-btn'); if(!btn) return;
      setActiveTab(btn.dataset.tab);
    });

    // Scan buttons
    el("btnScanIn").onclick  = ()=>doScan("in");
    el("in-wfm").addEventListener("keydown", e=>{ if(e.key==="Enter") doScan("in"); });
    el("btnScanOut").onclick = ()=>doScan("out");
    el("out-wfm").addEventListener("keydown", e=>{ if(e.key==="Enter") doScan("out"); });
    el("btnScanTask").onclick = ()=>doScan("task");
    el("task-wfm").addEventListener("keydown", e=>{ if(e.key==="Enter") doScan("task"); });

    // Dashboard filter buttons + pager
    $$('.filter-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        showFilterModal(btn.dataset.col);
      });
    });

    el("dash-prev")?.addEventListener('click', ()=>{ if(DASH.page>1){ DASH.page--; renderDashTable(); }});
    el("dash-next")?.addEventListener('click', ()=>{ DASH.page++; renderDashTable(); });
    el("dash-jump")?.addEventListener('change', ()=>{
      const jump=el("dash-jump"); const v=Math.max(1, parseInt(jump.value||"1",10));
      DASH.page=v; renderDashTable();
    });

    // Reset filters button
    el("btnResetFilters")?.addEventListener('click', resetAllFilters);

    // Filter modal events
    el("filterCancel")?.addEventListener('click', hideFilterModal);
    el("filterModal")?.addEventListener('click', (e)=>{
      if(e.target === el("filterModal")) hideFilterModal();
    });
    el("filterClear")?.addEventListener('click', clearCurrentFilter);
    el("filterApply")?.addEventListener('click', applyCurrentFilter);
    el("filterSearch")?.addEventListener('input', filterSearchOptions);
  }

  // Filter functionality
  let currentFilterColumn = null;
  let currentFilterValues = new Set();

  function resetAllFilters() {
    // Clear all filters
    DASH.filters = {};
    DASH.page = 1;

    // Remove active state from all filter buttons
    $$('.filter-btn').forEach(btn => btn.classList.remove('active'));

    // Re-render table with all data
    applyDashFiltersAndRender();

    // Show success message
    notice("Đã reset tất cả bộ lọc", "success", 6000);
  }

  function showFilterModal(column) {
    currentFilterColumn = column;
    const title = el("filterTitle");
    const options = el("filterOptions");
    const modal = el("filterModal");

    // Get unique values for this column, including blank values
    const allValues = DASH.rows.map(row => String(row[column] || ""));
    const nonEmptyValues = [...new Set(allValues.filter(v => v.trim()))].sort();
    const hasEmptyValues = allValues.some(v => !v.trim());

    // Combine non-empty values with blank option if there are empty values
    const values = hasEmptyValues ? ["(Trống)", ...nonEmptyValues] : nonEmptyValues;

    title.textContent = `Lọc: ${getColumnTitle(column)}`;

    // Build options HTML
    options.innerHTML = values.map(value => `
      <div class="filter-option" data-value="${value}">
        <input type="checkbox" id="filter_${value}" value="${value}" ${currentFilterValues.has(value) ? 'checked' : ''}>
        <label for="filter_${value}">${value}</label>
      </div>
    `).join('');

    // Add click handlers for the entire row
    $$('#filterOptions .filter-option').forEach(option => {
      option.addEventListener('click', (e) => {
        // Don't trigger if user clicked directly on checkbox or label
        if (e.target.type === 'checkbox' || e.target.tagName === 'LABEL') return;

        const checkbox = option.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
        }
      });
    });

    modal.classList.add('show');
  }

  function hideFilterModal() {
    el("filterModal").classList.remove('show');
    el("filterSearch").value = '';
  }

  function getColumnTitle(column) {
    const titles = {
      vendor_name: 'Nhà Thầu',
      vendor_code: 'Mã Vendor',
      wfm_code: 'Mã WFM',
      wms_user_id: 'Mã WMS',
      operator: 'Operator',
      fullname: 'Họ và Tên',
      gender: 'Giới tính',
      birth_year: 'Năm sinh',
      gsheet_time_in: 'Time in',
      break_60: 'Nghỉ Trưa',
      break_60_in: 'Vào Ca Trưa',
      break_30: 'Nghỉ OT',
      break_30_in: 'Vào Ca OT',
      gsheet_time_out: 'Time Out'
    };
    return titles[column] || column;
  }

  function clearCurrentFilter() {
    $$('#filterOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
  }

  function applyCurrentFilter() {
    const checkedValues = Array.from($$('#filterOptions input[type="checkbox"]:checked')).map(cb => cb.value);

    if (checkedValues.length === 0) {
      delete DASH.filters[currentFilterColumn];
    } else {
      DASH.filters[currentFilterColumn] = checkedValues;
    }

    // Update filter button appearance
    const filterBtn = $(`.filter-btn[data-col="${currentFilterColumn}"]`);
    if (filterBtn) {
      if (checkedValues.length === 0) {
        filterBtn.classList.remove('active');
      } else {
        filterBtn.classList.add('active');
      }
    }

    DASH.page = 1;
    applyDashFiltersAndRender();
    hideFilterModal();
  }

  function filterSearchOptions() {
    const searchValue = el("filterSearch").value.toLowerCase();
    $$('.filter-option').forEach(option => {
      const label = option.querySelector('label').textContent.toLowerCase();
      option.style.display = label.includes(searchValue) ? 'flex' : 'none';
    });
  }

  function applyDashFiltersAndRender(){
    const fs=DASH.filters||{};
    DASH.filtered = DASH.rows.filter(row=>{
      for(const [k,val] of Object.entries(fs)){
        if(!val) continue;
        if (Array.isArray(val)) {
          // New filter format - array of selected values
          const cellValue = String(row[k] || "");
          const isEmpty = !cellValue.trim();

          // Check if the value matches any selected filter
          const matches = val.some(filterValue => {
            if (filterValue === "(Trống)") {
              return isEmpty; // Match empty values
            } else {
              return cellValue === filterValue; // Exact match for non-empty values
            }
          });

          if (!matches) return false;
        } else {
          // Old format fallback
          const q=v=>String(v||"").toLowerCase();
          if(!q(row[k]).includes(q(val))) return false;
        }
      }
      return true;
    });
    renderDashTable();
  }

  function initDayPicker(){
    const dp=el('dayPicker');
    if(!dp) return;
    if(!dp.value){
      const d=new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      dp.value = `${y}-${m}-${dd}`;
    }
  }

  function init(){
    const {h,use30}=ceilToNext15();
    el("hour").value = h;
    el("minute").value = use30;
    notice("Dữ liệu đã sẵn sàng!", "success", 2000);
    scheduleShiftAutoAdvance();
    setActiveTab('scan');
    initDayPicker();
    applyDayLock();
    bindEvents();
  }

  // Expose minimal for debugging if cần
  window.ScanTool = { CONFIG, doScan };

  // Run init
  document.addEventListener('DOMContentLoaded', init);

  // Export Excel từ dữ liệu đang hiển thị (đã lọc)
  el("btnExportXlsx")?.addEventListener("click", () => {
    try{
      const headers = [
        "Nhà Thầu","Mã Vendor","Mã WFM","Mã WMS","Operator",
        "Họ và Tên","Giới tính","Năm sinh","Shift In","Time in",
        "Nghỉ Trưa","Vào Ca Trưa","Nghỉ OT","Vào Ca OT","Shift Out","Time Out"
      ];
      const rows = (DASH.filtered?.length ? DASH.filtered : DASH.rows).map(r => ([
        r.vendor_name, r.vendor_code, r.wfm_code, r.wms_user_id, r.operator,
        r.fullname, r.gender, r.birth_year,
        r.shift_in || r.shift || "", r.gsheet_time_in,
        r.break_60,  r.break_60_in, r.break_30, r.break_30_in, r.shift_out || "", r.gsheet_time_out
      ]));

      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      // Fit width nhẹ
      const colWidths = headers.map((h, i) => ({
        wch: Math.max(
          String(h || "").length + 2,
          ...rows.map(r => String(r[i] || "").length + 1)
        )
      }));
      ws['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Dashboard");
      const wh = el("warehouse")?.value || "WAREHOUSE";
      const day = el("dayPicker")?.value || todayKey();
      XLSX.writeFile(wb, `dashboard_${wh}_${day}.xlsx`);
      playSysOk();
    }catch(e){
      console.error(e);
      notice("Xuất Excel thất bại.", "error", 4000);
      playSysErr();
    }
  });


})();
</script>

<!-- ========================== Firebase SDK (module) ========================== -->
<script type="module">
  // Import modular Firebase configuration
  import { initFirebase } from '../static/js/firebase-config.js';

  // Initialize Firebase for scan project
  const { app, db, ref, onValue, databaseURL } = await initFirebase('scan');

  // “Cầu nối” để script chính dùng mà không cần import (giữ one-file)
  window.__firebaseDB = { ref, onValue, databaseURL };
  if (typeof window.__startRealtimeAll === 'function') {
    window.__startRealtimeAll(db);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
{% endblock %}

